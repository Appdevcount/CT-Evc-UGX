NGINX
NGinx.conf
server {

    listen 0.0.0.0:80;
    listen [::]:80;
    default_type application/octet-stream;

    gzip                    on;
    gzip_comp_level         6;
    gzip_vary               on;
    gzip_min_length         1000;
    gzip_proxied            any;
    gzip_types              text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_buffers            16 8k;
    client_max_body_size    256M;

  location / {
    root   /usr/share/nginx/html;
    index  index.html index.htm;
    try_files $uri $uri/ /index.html;
  }

  error_page   500 502 503 504  /50x.html;

  location = /50x.html {
    root   /usr/share/nginx/html;
  }

}
PUBLIC
Index.html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="UCX application"
    />

    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />

    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>Unified Clinical Experience - UCX</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <!-- <script src="%PUBLIC_URL%/pdf-viewer.js"></script> -->
    <!-- <script src="%PUBLIC_URL%/ucx-medical-director-review-history.js"></script> -->
     <!-- <script src="%PUBLIC_URL%/ucx-activity-log-micro-ui.js"></script> -->
  </body>
</html>


SRC
INDEX.TSX
import React from 'react';
import ReactDOM from 'react-dom';
import './index.css';
import App from './App';
import { BrowserRouter as Router } from "react-router-dom";
import reportWebVitals from './reportWebVitals';
import { AuthProvider } from "./auth/authProvider";
import RequestStore from './state/store/request-store';
import { MsalProvider } from '@azure/msal-react';

AuthProvider._initialize();

ReactDOM.render(
  <MsalProvider instance={AuthProvider.Application}>
    <RequestStore>
      <Router>
        <App />
      </Router>
    </RequestStore>
  </MsalProvider>,
  document.getElementById('root')
);

// If you want to start measuring performance in your app, pass a function
// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals
reportWebVitals();

INDEX.CSS
@import "https://evicore-cdn.azureedge.net/css/bootstrap.css";
@import "https://use.fontawesome.com/releases/v5.13.0/css/all.css";

.nav-link {
    cursor: pointer;
}

.alert-link {
  cursor: pointer;
}

.sticky-top {
    z-index: 900 !important;  
}

.well {
  background-color: #f8f9fa;
  border: 1px solid #e3e3e3;
}
/******************************************************
  PDF Viewer
*******************************************************/

.pdf-nav {
    position: relative;
    margin-left: 5px;
    clear: both;
    height: 35px;
  }
  
  .pdf-nav-page {
    width: 200px;
    float: left;
  }
  
  .pdf-nav-zoom,
  .pdf-nav-rotate {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 93px;
  }
  
  .pdf-nav-rotate {
    top: 0;
    left: 64.75%;
    width: 65px;
  }
    
  .pdf-nav-label {
    font-size: 13px;
    color: #fff;
  }
  
  .pdf-nav-button,
  .pdf-nav-zoom-button,
  .pdf-rotate-button {
    border: 0;
    display: inline-block;
    background-color: transparent;
    color: #fff;
  }
  
  .pdf-nav-button.pdf-first {
    margin-left: 15px !important;
  }
  
  .separator {
    position: absolute;
    display: inline-block;
    left: 55.75%;
    margin: 0 10px 0 15px;
    color: #fff;
  }
  
  .pdf-canvas {
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
  }
  
  .pdf-pdf-title {
    font-size: 18px;
  }
  
  .react-pdf__Page__canvas {
    margin: 0 auto !important;
  }
  
  .react-pdf_message,
  .react-pdf__message.react-pdf__message--no-data,
  .react-pdf__message.react-pdf__message--loading,
  .react-pdf__message.react-pdf__message--error {
    color: #fff !important;
  }
  
  /******************************************************
    Reviewer Notes
  *******************************************************/
  .panel {
    clear: both;
  }
  
   .panel-heading {
     position: relative;
      margin-bottom: -1px;
      border-bottom: 1px solid rgba(17, 17, 17, 0.125);

  }
  
  /* .md-notes .panel-body,
  #clinicalReviewerNotes .panel-heading + div {
    margin-top: -37px;
  } */

  /*
  .panel-body.justify-content-between {
    -webkit-box-pack: justify !important;
    -ms-flex-pack: justify !important;
    justify-content: flex-end !important;
  } */

  .md-notes .panel-body > div {
    width: 100%;
  }

  .panel_header-condensed {
    margin-bottom: 0 !important;
    margin-top: 2px !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
    font-size: 0.875rem;
    font-weight: 600 !important;
  }
  
  /* removes the affect of fa class on Tab Names */
  .panel_header-condensed .fa {
    display: none;
  }
  
  #generatingAgentInfo,
  .note-detail,
  .review-detail {
    position: absolute;
    top: 2px;
    right: 5px;
    margin-bottom: 0 !important;
    padding-left: 0 !important;
    padding-right: 1rem !important;
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
    color: #6c757d !important;
    font-weight: 500 !important;
    font-size: 0.75rem;
  }
  
  #structuredClinicalReviewNotes .py-2,
  #nurseFreeTextNotes .py-2,
  #physicianFreeTextNotes .py-2 {
    padding-top: 0 !important;
    padding-bottom: 0 !important;
  }
 
  #structuredClinicalReviewNotes .border-bottom,
  #nurseFreeTextNotes .border-bottom,
  #physicianFreeTextNotes .border-bottom {
    border-bottom: 0 !important;
  }

  #noMdReviewMessage,
  #notFoundNonClinicalReviewHistory {
    font-size: 0.875rem;
  }
  
  #noMdReviewMessage {
    padding-left: 0.8rem;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
  }

  #denialLanguage,
  #clinicalReviewerNotes .table-striped tbody tr:nth-child(2) > td > p {
    margin-top: -22px;
  }

  .notes-tab .table-striped tbody tr:nth-of-type(odd) {
    background-color: #fff;
  }
  
  .md-notes .table-striped tbody tr:nth-child(2) > td,
  #clinicalReviewerNotes .table-striped tbody tr:nth-child(2) > td {
    border-top: 0 !important;
  }

  .notes-tab .table th {
    margin-top: 0;
    margin-bottom: 0;
    width: 25% !important;
    background-color: rgba(17, 17, 17, 0.03);
    border-bottom: 1px solid rgba(17, 17, 17, 0.125);
    font-weight: 500 !important;
  }
  
  .notes-tab .table td {
    margin-bottom: 0;
    background-color:#fff;
    /* border-bottom: 1px solid rgba(17, 17, 17, 0.125); */
    font-size: 0.875rem;
  }
  
  .notes-tab .table-sm th {
    font-weight: 500;
    font-size: 0.875rem;
    padding: 0.75rem;
    vertical-align: top;
    border-top: 1px solid #dee2e6;
  }
  
  .notes-tab .table-sm td {
    padding: 0.75rem;
    vertical-align: top;
    /* border-top: 1px solid #dee2e6; */
  }
  
  .structured-tab .table th {
    margin-top: 0;
    margin-bottom: 0;
    width: 50% !important;
    vertical-align: top;
    /* border-top: 1px solid #dee2e6; */
  }
  
  .structured-tab .table th p {
    margin-top: 0;
    margin-bottom: 0 !important;
    font-size: 0.875rem;
    font-weight: 600 !important;
  }
  
  .structured-tab .table td {
    margin-bottom: 0;
    vertical-align: top;
    /* border-top: 1px solid #dee2e6; */
    font-size: 0.875rem;
  }
  
  .structured-tab .table-sm th {
    padding: 0.75rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .structured-tab .table-sm td {
    padding: 0.5rem;
    font-size: 0.875rem;
  }
  
  .hide-element {
    display: none !important;
}

/******************************************************
  UPADS
*******************************************************/

/********** Overwrites CSS from upads-comtrol.js *********/

@media (min-width: 991px) {
  .alert-wrapper {
    padding: 10px 10px 10px 280px !important;
  }
}

@media (min-width: 1199px) {
  .alert-wrapper {
    padding: 10px 10px 10px 280px !important;
  }
}

@media (min-width: 990px) {
  .alert-wrapper {
    padding: 10px 10px 10px 280px !important;
  }
}

@media (min-width: 991px) {
  .topbar-wrapper {
    padding: 10px 0 10px 280px !important;
  }
}

@media (max-width: 1199px) {
  .topbar-wrapper {
    padding: 10px 0 10px 130px !important;
  }
}

@media (max-width: 990px) {
  .topbar-wrapper {
    padding: 10px 0 10px 130px !important;
  }
}

.btn-tertiary {
  color: #34657f !important;
  background: -webkit-gradient(linear, left top, left bottom, from(#FFFFFF), to(#F9FAFB)) !important;
  background: -webkit-linear-gradient(top, #FFFFFF 0%, #F9FAFB 100%) !important;
  background: -o-linear-gradient(top, #FFFFFF 0%, #F9FAFB 100%) !important;
  background: linear-gradient(
180deg
, #FFFFFF 0%, #F9FAFB 100%) !important;
  border: 1px solid #C2D1D9 !important;
  -webkit-box-shadow: none !important;
  box-shadow: none !important;
}

.btn-tertiary:hover { 
  color: #34657f !important; 
  background: -webkit-gradient(linear, left top, left bottom, from(#FAFBFC), to(#EBEFF2)) !important; 
  background: -webkit-linear-gradient(top, #FAFBFC 0%, #EBEFF2 100%) !important; 
  background: -o-linear-gradient(top, #FAFBFC 0%, #EBEFF2 100%) !important; 
  background: linear-gradient(180deg, #FAFBFC 0%, #EBEFF2 100%) !important; 
  border: 1px solid #9AB2BF !important; 
}

.fa.ucx-status {
  font: normal normal 900 11px/1 "Font Awesome 5 Free" !important;
}

.fa.decide-close {
  font: normal normal 900 16px/1 "Font Awesome 5 Free" !important;
}

.custom-control-input {
  left: 5px !important;
  width: 25px !important;
  z-index: 1000 !important;
}

.hide-sidebar {
  display: none;
}

/*Activity Log UI*/

.all-activity-item {
  border-top: 1px solid #dee2e6;
}
.table .all-activity-item td {
  border-top: none;
}

.markdown-heading>p,
.markdown-body>p,
.markdown-body>ul,
.markdown-body>ol,
.markdown-body>dl{
  margin: 0;
}

.text-end {
  text-align: end;
}

.pointer {
  cursor: pointer;
}

APP.TSX
import React, { useEffect, useContext, useRef } from "react";
import { Route, Switch, useLocation } from "react-router-dom";
import "./App.css";
import Home from "./components/home/home";
import RequestView from "./components/request-view/request-view";
import MicroUIHost from "./components/microuihost/microuihost";
import Sidebar from "./components/common/sidebar";
import ReloadRequest from "./components/common/reload";
import AttachmentControl from "./components/request-view/attachments/attachment-control/attachment-control";
import config from "./utils/config";
import { withAITracking } from "@microsoft/applicationinsights-react-js";
import { AppInsights, reactPlugin } from "./AppInsights";
import { RequestContext } from './state/store/request-store';
import { useAccount, useMsal } from "@azure/msal-react";
import { loadExternalScriptWithVersion } from "./utils/loadExternalScriptWithVersion";

export function loadExternalScript(scriptId: string, source: string): void {
  if (!document.getElementById(scriptId)) {
    const script = document.createElement("script");
    script.id = scriptId;
    script.src = source;
    script.defer = true;
    script.async = true;
    script.onload = (e) => {
      AppInsights.logEvent(`Loaded script: ${scriptId} micro UI from: ${source} in UCX UI`, [e]);
    };
    script.onerror = () => {
      AppInsights.logExceptionMessage(
        `Unable to load script: ${scriptId} micro UI from: ${source} in UCX UI`);
    };
    document.body.appendChild(script);
  }
}

function App() {
  const location = useLocation();
  const hideNav = location.pathname.includes("viewer") ? null : <Sidebar />;

  const { accounts } = useMsal();
  const account = useAccount(accounts[0] || {});

  let userName = useRef<string>("");

  useEffect(() => {

    AppInsights.SetAppInsightsKey(config.appInsights.instrumentationKey);

    config.microComponents.forEach((microUI: any, index: number) => {
      loadExternalScriptWithVersion(microUI, loadExternalScript);
    });
  }, []);

  useEffect(() => {
    if (account) {
      userName.current = account.name ?? "undefined";
    }
  }, [account]);

  return (
    <>
      {hideNav}
      <Switch>
        <Route exact path="/" component={Home} />
        <Route path="/request/:id" component={RequestView} />
        <Route
          path="/viewer/:id/:filename/:hideDocumentList/:pendingOcr"
          component={AttachmentControl}
        />
        <Route
          path="/attachment-viewer/:requestForServiceKey/:contextKey/:isHistorical"
          component={AttachmentControl}
        />
        <Route 
          path="/microuihost/:id"
          component={MicroUIHost}
        />
        <Route path="/reload" component={ReloadRequest} />
      </Switch>
    </>
  );
}

export default withAITracking(reactPlugin, App);


APP.TEST.TSX
import React from "react";
import { act, render } from "@testing-library/react";
import App from "./App";
import { MemoryRouter } from "react-router-dom";

import RequestStore from './state/store/request-store';

const mockConnection = {
  start: jest.fn(),
  stop: jest.fn()  
}

jest.mock("react-router-dom", () => {
  const originalModule = jest.requireActual("react-router-dom");

  return {
    ...originalModule,
    useHistory: jest.fn(),
    useLocation: () => ({
      pathname: "/viewer"
    })
  };
});

const loadScript = () => {
  const script = document.createElement("script");
  script.id = "testId";
  script.src = "https://eu2dv1staucxtfstate.blob.core.windows.net/eu2dv1scucx/build/ucx-procedures-micro-ui.js";
  script.defer = true;
  script.async = true;
  document.body.appendChild(script);

}

describe("<App />", () => {
  it("renders App component", () => {
    act(() => {
        render(
          <RequestStore>
            <MemoryRouter initialEntries={["/"]}>
              <App />
            </MemoryRouter>
          </RequestStore>
        );
    });
  });

  it("loads external script", () => {
    jest.spyOn(document.body, "appendChild");
  
    loadScript();
  
    expect(document.body.appendChild).toBeCalledWith(
      expect.objectContaining({
        src: "https://eu2dv1staucxtfstate.blob.core.windows.net/eu2dv1scucx/build/ucx-procedures-micro-ui.js",
        id: "testId"
      })
    );
  });
});

APPINSIGHTS.TS
import {ApplicationInsights, ITelemetryItem, SeverityLevel} from "@microsoft/applicationinsights-web";
import { ReactPlugin } from "@microsoft/applicationinsights-react-js";
import { createBrowserHistory } from "history";

const browserHistory = createBrowserHistory({ basename: "" });
const reactPlugin = new ReactPlugin();

export class AppInsights {
    private static _appInsights: ApplicationInsights;

    private static _initialize(key: string) {
        AppInsights._appInsights = new ApplicationInsights({
            config: {
                instrumentationKey: key,
                extensions: [reactPlugin],
                extensionConfig: {
                  [reactPlugin.identifier]: { history: browserHistory }
                }
        
            }
        });

        AppInsights._appInsights.loadAppInsights();
        AppInsights._appInsights.trackPageView();
        
        AppInsights._appInsights.addTelemetryInitializer((envelope: ITelemetryItem) => {
          envelope.tags = envelope.tags || [];
          envelope.tags.push({ "ai.cloud.role": "React UI" });
        });
    }

    public static SetAppInsightsKey(appInsightsKey: string) {
        AppInsights._initialize(appInsightsKey);
    }

    static logEvent = (eventName: string, properties?: { [key: string]: any }) => {
      if (AppInsights._appInsights) {
        AppInsights._appInsights.trackEvent( { name: eventName }, properties );
      }
        console.log(eventName, properties);
    }
    
    static logExceptionMessage = (exceptionMessage: string) => {
    
      if (AppInsights._appInsights) {
        AppInsights._appInsights.trackException( { exception: new Error(exceptionMessage) } );
      }
    
      console.error('logExceptionMessage:', exceptionMessage);
    }

    static logError = (error: Error, customProperties: {}) => {
        AppInsights._appInsights.trackException({
            exception: error,
            severityLevel: SeverityLevel.Error,
        }, customProperties);
        console.error(error, customProperties);
    };
  }

export { reactPlugin };

DECLARATIONS.D.TS
interface UcxAttachmentsProps extends React.DetailedHTMLProps<React.HTMLAttributes<HTMLElement>, HTMLElement>{
    objectValetId?: string;
    fileName?: string;
    requestForServiceKey?: string;
    contextKey?: string;
    sourceSystem?: string;
    isHistorical?:string;
    hideDocumentList?:string;
    pendingOcr?:string
}

interface ActivityLogProps extends React.DetailedHTMLProps<React.HTMLAttributes<HTMLElement>, HTMLElement>, MicroUiProps{
  requestForServiceKey?: string;
  authorizationKey?: string;
}
  
interface PdfViewerProps extends React.DetailedHTMLProps<React.HTMLAttributes<HTMLElement>, HTMLElement>{
  appInsightsKey?: string;
}

interface AIMicroUiProps extends React.DetailedHTMLProps<React.HTMLAttributes<HTMLElement>, HTMLElement>{
  authkey?: string;
  appInsightsKey?: string;
}

interface ClinicalRoutingMicroUiProps extends React.DetailedHTMLProps<React.HTMLAttributes<HTMLElement>, HTMLElement>{
  appInsightsKey?: string;
  userId?: string;
  userRole?: string;
  medicalDiscipline?: string;
  token?: string;
}

interface UcxHeaderProps extends React.DetailedHTMLProps<React.HTMLAttributes<HTMLElement>, HTMLElement>{
  requestForServiceKey?: string;
  originSystem:string;
}
declare namespace JSX {
  interface IntrinsicElements {
      "activity-log": ActivityLogProps,
      "ucx-attachments": UcxAttachmentsProps,
      "clinical-routing-ui-component": ClinicalRoutingMicroUiProps,
      "ucx-diagnosis-ui": any,
      "level-one-free-text-notes": any,
      "medical-director-review-history-element": AIMicroUiProps,
      "nurse-free-text-notes": any,
      "nurse-review-history-element": AIMicroUiProps,
      "non-clinical-review-history": AIMicroUiProps,
      "ucx-free-form-note-element" : any,
      "ucx-member-history-element" : any,
      "pdf-viewer": PdfViewerProps,
      "physician-free-text-notes": any,
      "procedures-micro-ui": any,
      "ucx-upads-micro-ui": any,
      "ucx-header": UcxHeaderProps,
      "request-member-details": any,
      "request-provider-details": any,
      "decision-ui": any,
      "ucx-qualifier-ui": any,
      "ucx-caselock": any
  }
}

SETUPSTEST.TS
// jest-dom adds custom jest matchers for asserting on DOM nodes.
// allows you to do things like:
// expect(element).toHaveTextContent(/react/i)
// learn more: https://github.com/testing-library/jest-dom
import '@testing-library/jest-dom';


REPORTWEBVITALS.TS
import { ReportHandler } from 'web-vitals';

const reportWebVitals = (onPerfEntry?: ReportHandler) => {
  if (onPerfEntry && onPerfEntry instanceof Function) {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(onPerfEntry);  
      getFID(onPerfEntry);
      getFCP(onPerfEntry);
      getLCP(onPerfEntry);
      getTTFB(onPerfEntry);
    });
  }
}

export default reportWebVitals;

UTILS
USESESSIONSTORAGE.TS
import { ReportHandler } from 'web-vitals';

const reportWebVitals = (onPerfEntry?: ReportHandler) => {
  if (onPerfEntry && onPerfEntry instanceof Function) {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(onPerfEntry);  
      getFID(onPerfEntry);
      getFCP(onPerfEntry);
      getLCP(onPerfEntry);
      getTTFB(onPerfEntry);
    });
  }
}

export default reportWebVitals;


USELOCALSTORAGE.TS
import { useState } from "react";

export function useLocalStorage<T>(key: string, initialValue: T) {
    // State to store our value
    // Pass initial state function to useState so logic is only executed once
    const [storedValue, setStoredValue] = useState<T>(() => {
        try {
            // Get from local storage by key
            const item = window.localStorage.getItem(key);
            // Parse stored json or if none return initialValue
            return item ? JSON.parse(item) : initialValue;
        } catch (error) {
            // If error also return initialValue
            return initialValue;
        }
    });

    // Return a wrapped version of useState's setter function that ...
    // ... persists the new value to localStorage.
    const setValue = (value: T | ((val: T) => T)) => {
        try {
            // Allow value to be a function so we have same API as useState
            const valueToStore =
                value instanceof Function ? value(storedValue) : value;
            // Save state
            setStoredValue(valueToStore);
            // Save to local storage
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) {
            // A more advanced implementation would handle the error case
        }
    };
    return [storedValue, setValue] as const;
}

export function getValueFromLocalStorage<T>(key: string, defaultValue: T) {
    try {
        const item = window.localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
    } catch (error) {
        return defaultValue;
    }
}

LOADEXTERNALSCRIPTWITHVERSION.TS
import { AppInsights, reactPlugin } from "./../AppInsights";

export function loadExternalScriptWithVersion(microUI: any, callback: (scriptId: string, source: string, microUI: any) => void) {
    var versionurl = microUI.version;
    var source = microUI.url;
    if (versionurl) {
        versionurl = `${versionurl}${versionurl.indexOf('?') > -1 ? '&ticks=' : '?ticks='}${new Date().getTime()}`;
        fetch(`${versionurl}`)
            .then((response) => response.ok ? response.json() : undefined)
            .then((json) => {
                var version = source.indexOf('?') > -1 ? `&version=${json.version}` : `?version=${json.version}`;
                source = `${source}${version}`;
            })
            .catch((error) => {
                AppInsights.logError(
                    new Error("Failed to fetch version for" + microUI.name),
                    {
                        error: error,
                        statusCode: error.status,
                    }
                );
            })
            .finally(() => {
                callback(microUI.name, source, microUI);
            });
    }
    else {
        callback(microUI.name, source, microUI);
    }
}

LOADEXTERNALSCRIPTWITHVERSIONTEST.TS
import { render, screen, act } from "@testing-library/react";
import { loadExternalScriptWithVersion } from "./loadExternalScriptWithVersion";
import { Component } from "react";
import { AppInsights } from "../AppInsights";

const scripts = {
    loadScripts(scriptId: string, source: string) {
    }
}

describe("loadExternalScriptWithVersion", () => {

    beforeEach(() => {
        jest.spyOn(global, "fetch").mockImplementation(() =>
            Promise.resolve({
                ok: () => Promise.resolve(true),
                json: () => Promise.resolve({ version: "1.0.0" }),
            } as unknown as Response)
        );
    });

    it('Should call with version', async () => {
        const spy = jest.spyOn(scripts, 'loadScripts');
        var microUI = { name: "test-ui", version: "versionurl", url: "sourceurl" };
        await act(async () => {
            loadExternalScriptWithVersion(microUI, scripts.loadScripts);
        });
        expect(spy).toBeCalledWith(microUI.name, `${microUI.url}?version=1.0.0`, microUI);
    });

    it('Should not call with version, if no version url', async () => {
        const spy = jest.spyOn(scripts, 'loadScripts');
        var microUI = { name: "test-ui", url: "sourceurl" };
        await act(async () => {
            loadExternalScriptWithVersion(microUI, scripts.loadScripts);
        });
        expect(spy).toBeCalledWith(microUI.name, microUI.url, microUI);
    });

    it('Should not call with version, if expection happens', async () => {
        jest.spyOn(global, "fetch").mockImplementation(() =>
            Promise.reject("API is down")
        );
        var errorFn = jest.spyOn(AppInsights, 'logError').mockImplementation(() => { });
        const spy = jest.spyOn(scripts, 'loadScripts');
        var microUI = { name: "test-ui", version: "versionurl", url: "sourceurl" };
        await act(async () => {
            loadExternalScriptWithVersion(microUI, scripts.loadScripts);
        });
        expect(errorFn).toBeCalledTimes(1);
        expect(spy).toBeCalledWith(microUI.name, microUI.url, microUI);
    });
});

HELPTER.TS
export const toTitleCase = (s: string): string => {
  if (typeof(s)==='string'&&s.length>0) {
    const words = s.split(' ')
    if (Array.isArray(words)&&words.length>0) {
      if (words.length===1) {
        const word = words[0]
        const matches = word.charAt(0).match(/\w+/i)
        const lines = word.split('\n')
        if (Array.isArray(lines)&&lines.length>1) {
          return lines.map(line=>{
            return toTitleCase(line)
          }).join('\n')
        } else if (Array.isArray(matches)) {
          return word.split('').map((c,i)=>{
            if (i===0) {
              return c.toUpperCase()
            }
            return c.toLowerCase()
          }).join('')
        } else {
          return word.charAt(0).concat(toTitleCase(word.slice(1)))
        }
      } else {
        return words.map(word=>toTitleCase(word)).join(' ')
      }
    }
  }
  return ''
}
  

CONSTANT.TS
export enum AttachmentTypes {
  ClinicalInformation = 'ClinicalInformation',
  RecordsSent = 'RecordsSent'
}
  
export enum NotesTabs {
  MedicalReviewerNotes = 'MedicalReviewerNotes',
  ClinicalReviewerNotes = 'ClinicalReviewerNotes',
  StructuredClinicalReviewNotes = 'StructuredClinicalReviewNotes',
  ActivityLog = "ActivityLog",
  AllNotes = 'AllNotes'
}

export const LOGOUT_TIMEOUT = 6000;
export const TOAST_TIMEOUT = 6000;

export const AlertTypes = {
  Info: {
    title: 'Info',
    message: 'This is an info message',
    timeSpan: TOAST_TIMEOUT,
    type: 'alert-info'
  },
  Success: {
    title: 'Success',
    message: 'This is a success message',
    timeSpan: TOAST_TIMEOUT,
    type: 'alert-success'
  },
  Warning: {
    title: 'Warning',
    message: 'This is a warning message',
    timeSpan: TOAST_TIMEOUT,
    type: 'alert-warnig'
  },
  Error: {
    title: 'Error',
    message: 'You are an unauthorized user. Please contact your administrator.',
    timeSpan: TOAST_TIMEOUT,
    type: 'alert-danger'
  }

};


CONFIG.TS
import { upadsServiceRequestType } from "../enums/upadsServiceRequestType";

const dv1 = {
    ENV: 'dv1',
    clientId: '9f3eb1b4-c333-47ef-ad11-44745710b07e',
    scope: 'https://ehdv1b2c.onmicrosoft.com/5f3a640a-613f-4696-afff-5c740cc371cf/ucxauth/user_access',
    authority: 'https://ehdv1b2c.b2clogin.com/ehdv1b2c.onmicrosoft.com/B2C_1A_UCX_SUSI',
    redirectUrl: 'https://dv1.ucx.evicore.com',
    b2cApiClientId: '5f3a640a-613f-4696-afff-5c740cc371cf',
    apiBaseUrl: 'https://dv1api.innovate.lan/',
    apiHostedBaseUrl: 'https://dv1apihosted.innovate.lan/ucx/',
    routingSubscriptionKey: '4db64eb47f164734a6c4b6fdbe9ad0b6',
    activityLogTempApiBaseUrl: 'https://eheu2dv1-as-ucx-activitylogservice.sites.innovate.lan/',
    caseLockApiBaseUrl: 'https://dv1apihosted.innovate.lan/ucxcaselockservice/api/caseLock/',
    userGroup: 'dv1_EpSleepMedicalDirector',
    clinicalRoutingServiceUserRole: 'MD',
    clinicalRoutingServiceDiscipline: 'Sleep',
    logoutAfterIdleTime: 3600000,
    attachmentPollingForIdleLogout: 3000,
    appInsights: {
        instrumentationKey: '75584c12-a500-4063-88ad-3cd9a2e2c44f'
    },
    upadsConfig: {
        reviewType: "UCXMDDecision",
        upadsShowHistory: true,
        upadsSystem: "eP",
        upadsForceNewReview: true,
        upadsUpadsApiUrl: "https://dv1api.innovate.lan/upads/v1/",
        upadsPublicServiceUrl: "https://ehdv1upadsvm1.innovate.lan/Upads.Public.Service/",
        upadsContentApiUrl: "https://dv1api.innovate.lan/upads/content/v1/",
        upadsServicesUrl: "https://dv1api.innovate.lan/Upads/Upads",
        upadsServicesGenericRole: "MD",
        upadsServicesRequestType: upadsServiceRequestType.Sleep,
        upadsErrorMessage: "Could not connect to Physician Action Workflow",
        xPlatformUpadsControlJs: 'https://dv1eu2m2upads01jscblob.blob.core.windows.net/upadsjscontrol/latest/upads-ui-control.js',
        xPlatformUpadsControlCss: 'https://dv1eu2m2upads01jscblob.blob.core.windows.net/upadsjscontrol/latest/styles.css'
    },
    microComponents: [
        {
            name: 'activity-log',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/activitylogmicroui/ucx-activity-log-micro-ui.js?sp=r&st=2023-08-07T14:25:42Z&se=2033-12-31T23:25:42Z&spr=https&sv=2022-11-02&sr=b&sig=byPLDG9JuKX3LxcOXGGQM5tKq1PI0TKCGRWwNMuFLvY%3D&version=2024-01-31',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/activitylogmicroui/src/config/version.json?sp=r&st=2024-04-04T17:28:00Z&se=2031-01-01T02:28:00Z&spr=https&sv=2022-11-02&sr=b&sig=TVe8AMsfaa7QCFWj1tUwCQmWRR29FwKquar%2FxI33N0Y%3D'

        },
        {
            name: 'ucx-attachments',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/ucxattachmentsmicroui/ucx-attachments.js?sp=r&st=2022-05-10T13:43:52Z&se=2027-05-10T21:43:52Z&spr=https&sv=2020-08-04&sr=b&sig=pZ2T5Rf0bGK0Ur5rDoyW2e39TWqLQPh0zPbiSzYrylM%3D&version=01-11-2024',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/ucxattachmentsmicroui/version.json?sp=r&st=2024-02-20T17:29:34Z&se=2034-02-21T01:29:34Z&spr=https&sv=2022-11-02&sr=b&sig=HFR%2BcgxcagbbcsSMB7UGVCRJ17hz1d1NEVxrFcphMms%3D'
        },
        {
            name: 'ucx-diagnosis-ui',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/ucxdiagnosisui/ucx-diagnosis-ui.js?sp=r&st=2023-05-31T17:09:01Z&se=2033-06-01T01:09:01Z&spr=https&sv=2022-11-02&sr=b&sig=XjsTEfNCks%2BJLpLHXfG5rtoifcnAJETniorQStsGbf0%3D'
        },
        {
            name: 'ucx-free-form-note-element',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/freeformnoteelement/ucx-free-form-note-element.js',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/freeformnoteelement/src/config/version.json'
        },
        {
            name: 'procedures',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/proceduresmicroui/ucx-procedures-micro-ui.js?sp=r&st=2024-07-24T16:14:36Z&se=2034-07-25T00:14:36Z&spr=https&sv=2022-11-02&sr=b&sig=sIwTXPi0bNLK7DrzpNHZzybyKiK3WMz2MKEw%2BdswoYk%3D',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/proceduresmicroui/version.json?sp=r&st=2024-07-24T16:16:10Z&se=2034-07-25T00:16:10Z&spr=https&sv=2022-11-02&sr=b&sig=pspPBR%2FAmwimjvP0r9MRut9Zbf1AtLgFCi%2BmTXYnDCk%3D'
        },
        {
            name: 'upads',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/upadsmicroui/ucx-upads-micro-ui.js?sp=r&st=2024-07-24T16:17:04Z&se=2034-07-25T00:17:04Z&spr=https&sv=2022-11-02&sr=b&sig=wHpfzhdrPmF3HRg6bn%2B3qDj3foRypUiLBQyL8cnbUS4%3D&version=2024-07-25'
        },
        {
            name: 'ucx-member-history-element',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/memberhistoryelement/ucx-member-history-element.js?sp=r&st=2023-08-07T13:47:07Z&se=2033-12-31T22:47:07Z&spr=https&sv=2022-11-02&sr=b&sig=xXvPPOJsrqwDbt5e0XR36TglgSieM%2FmB3J0G%2BY7gJ2s%3D',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/memberhistoryelement/src/config/version.json?sp=r&st=2024-03-13T19:21:10Z&se=2034-03-14T03:21:10Z&spr=https&sv=2022-11-02&sr=b&sig=O3yhQ5Zo2kDXIyizccFzOvNV6CzOArmZ0pwDKe0KAcY%3D'
        },
        {
            name: 'clinical-routing-ui-component',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/clinicalroutinguicomponent/build/ucx-clinical-routing-component.js?sp=r&st=2021-10-13T14:00:46Z&se=2031-10-13T22:00:46Z&spr=https&sv=2020-08-04&sr=b&sig=7cAROKj%2BjvF5SbdNpBnEh1slALkv1rps8E3Hd2YK17o%3D'
        },
        {
            name: 'ucx-header',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/ucxheadermicroui/ucx-header.js?sp=r&st=2022-05-16T18:51:02Z&se=2030-05-17T02:51:02Z&sv=2020-08-04&sr=b&sig=fU4UOxzRZJ%2BZ7%2FXTs2kwsQpGEacyzJjoiRtw0jdg9tk%3D&version=2024-01-12',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/ucxheadermicroui/version.json?sp=r&st=2024-04-26T15:55:57Z&se=2034-04-26T23:55:57Z&spr=https&sv=2022-11-02&sr=b&sig=6beMlOb8KdnQN59FRhVlf0L6zOPHWOHGZEOCiFyFxJ4%3D'
        },
        {
            name: 'ucx-request-provider-details',
            url: 'https://eheu2dv1ucxrpdetailfd.azurefd.net/ucx-request-provider-details.bundle.js?ts=2024-01-10T14:05:53Z',
            version: 'https://eheu2dv1ucxrpdetailfd.azurefd.net/version.json'
        },
        {
            name: 'ucx-request-member-details',
            url: 'https://eheu2dv1ucxrmdetailfd.azurefd.net/ucx-request-member-details.bundle.js'
        },
        {
            name: 'decision-ui',
            url: 'https://eheu2dv1ucxdecisionfrontdoor.azurefd.net/ucx-decision.bundle.js?ts=2023-12-05'
        },
        {
            name: 'ucx-qualifier-ui',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/ucxqualifierui/ucx-qualifier-ui.js?sp=r&st=2023-01-25T16:02:54Z&se=2033-01-26T00:02:54Z&spr=https&sv=2021-06-08&sr=b&sig=%2Bnlw6ayeS%2FVtopa9r%2F1cIzjpUqOUtk%2FHyXyOIB0RtpE%3D&version=2024-03-27',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/ucxqualifierui/version.json?sp=r&st=2024-03-22T15:26:01Z&se=2031-01-01T00:26:01Z&spr=https&sv=2022-11-02&sr=b&sig=SIWUNOv6YymqJozRQT8mPRDS8sMiB3b9%2FUAMwkIVhaM%3D'
        },
        {
            name: 'ucx-caselock',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/ucxcaselockmicroui/ucx-caselock.js?sp=r&st=2023-09-16T11:59:42Z&se=2033-09-16T19:59:42Z&spr=https&sv=2022-11-02&sr=b&sig=DrozMMWufP0di6IJbj6SCumsNWjxFSsg%2B1TCNG3qY2A%3D&version=02-14-2024'
        }
    ],
    isMemberHistoryCollapsed: false
};

const in1 = {
    ENV: 'in1',
    clientId: '7222459c-0273-4c67-b7b0-fcb61f69a7a8',
    scope: 'https://evicorein1b2c.onmicrosoft.com/10d5c007-7171-41ca-ae57-e5dfc340766b/ucxauth/user_access',
    authority: 'https://evicorein1b2c.b2clogin.com/evicorein1b2c.onmicrosoft.com/B2C_1A_UCX_SUSI',
    redirectUrl: 'https://in1.ucx.evicore.com',
    b2cApiClientId: '10d5c007-7171-41ca-ae57-e5dfc340766b',
    apiBaseUrl: 'https://in1api.innovate.lan/',
    apiHostedBaseUrl: 'https://in1apihosted.innovate.lan/ucx/',
    routingSubscriptionKey: '113c9ba15c544ebda04030c09e6624f0',
    activityLogTempApiBaseUrl: 'https://eheu2in1-as-ucx-activitylogservice.sites.innovate.lan/',
    userGroup: 'in1_EpSleepMedicalDirector',
    clinicalRoutingServiceUserRole: 'MD',
    clinicalRoutingServiceDiscipline: 'Sleep',
    caseLockApiBaseUrl: 'https://in1apihosted.innovate.lan/ucxcaselockservice/api/caseLock/',
    logoutAfterIdleTime: 3600000,
    attachmentPollingForIdleLogout: 3000,
    appInsights: {
        instrumentationKey: 'a7660029-8c00-43fa-a94b-1bbeb203de44'
    },
    upadsConfig: {
        reviewType: "UCXMDDecision",
        upadsShowHistory: true,
        upadsSystem: "eP",
        upadsForceNewReview: true,
        upadsUpadsApiUrl: "https://in1api.innovate.lan/upads/v1/",
        upadsPublicServiceUrl: "https://ehin1upadsvm1.innovate.lan/Upads.Public.Service/",
        upadsContentApiUrl: "https://in1api.innovate.lan/upads/content/v1/",
        upadsServicesUrl: "https://in1api.innovate.lan/Upads/Upads",
        upadsServicesGenericRole: "MD",
        upadsServicesRequestType: upadsServiceRequestType.Sleep,
        upadsErrorMessage: "Could not connect to Physician Action Workflow",
        xPlatformUpadsControlJs: 'https://in1m2upads01jscontrolep.azureedge.net/upadsjscontrol/latest/upads-ui-control.js',
        xPlatformUpadsControlCss: 'https://in1m2upads01jscontrolep.azureedge.net/upadsjscontrol/latest/styles.css'
    },
    microComponents: [
        {
            name: 'activity-log',
            url: 'https://in1ucxmicroui.blob.core.windows.net/activitylogmicroui/ucx-activity-log-micro-ui.js?sp=r&st=2023-08-07T14:28:35Z&se=2033-12-31T23:28:35Z&spr=https&sv=2022-11-02&sr=b&sig=%2FP33inQjvL2t5kDWoT5ENgNPzgrU4N6ApxY1NMnzUsw%3D&version=2024-01-31',
            version: 'https://in1ucxmicroui.blob.core.windows.net/activitylogmicroui/src/config/version.json?sp=r&st=2024-04-04T21:20:49Z&se=2030-12-31T06:20:49Z&spr=https&sv=2022-11-02&sr=b&sig=GqKlTZU2yLxhigrtc5xijzatuQrff6frnu0sVfrP8%2Bw%3D'
        },
        {
            name: 'ucx-attachments',
            url: 'https://in1ucxmicroui.blob.core.windows.net/ucxattachmentsmicroui/ucx-attachments.js?sp=r&st=2022-05-11T19:36:51Z&se=2027-05-12T03:36:51Z&spr=https&sv=2020-08-04&sr=b&sig=4i36Cg57dvYOIE9SmHuCefoDtWke8wMhHcU9Z2ku500%3D&version=01-11-2024',
            version: 'https://in1ucxmicroui.blob.core.windows.net/ucxattachmentsmicroui/version.json?sp=r&st=2024-02-22T16:51:32Z&se=2033-02-23T00:51:32Z&spr=https&sv=2022-11-02&sr=b&sig=%2FKIVi3ahLMSEkA1lyj0j5F2UXZoPF%2FDLaj600MWKwAo%3D'
        },
        {
            name: 'ucx-diagnosis-ui',
            url: 'https://in1ucxmicroui.blob.core.windows.net/ucxdiagnosisui/ucx-diagnosis-ui.js?sp=r&st=2023-06-09T13:50:22Z&se=2033-06-09T21:50:22Z&spr=https&sv=2022-11-02&sr=b&sig=OX1ewWepEFzqmqX0Zm%2BXUtNqSc5XPKHiJLjGxwmS2jk%3D'
        },
        {
            name: 'ucx-free-form-note-element',
            url: 'https://in1ucxmicroui.blob.core.windows.net/freeformnoteelement/ucx-free-form-note-element.js',
            version: 'https://in1ucxmicroui.blob.core.windows.net/freeformnoteelement/src/config/version.json'
        },
        {
            name: 'procedures',
            url: 'https://in1ucxmicroui.blob.core.windows.net/proceduresmicroui/ucx-procedures-micro-ui.js?sp=r&st=2024-07-24T16:30:10Z&se=2034-07-25T00:30:10Z&spr=https&sv=2022-11-02&sr=b&sig=iazw5ruJK90lOS5Wcbt6wQz4rm0Jv%2Bpuk1VCtlmEMu4%3D',
            version: 'https://in1ucxmicroui.blob.core.windows.net/proceduresmicroui/version.json?sp=r&st=2024-07-24T16:30:43Z&se=2034-07-25T00:30:43Z&spr=https&sv=2022-11-02&sr=b&sig=xEDTHSAaKUyvz8e%2Bjn%2FWkfSmc%2FzfBsPu2QTkvx1H2nE%3D'
        },
        {
            name: 'upads',
            url: 'https://in1ucxmicroui.blob.core.windows.net/upadsmicroui/ucx-upads-micro-ui.js?sp=r&st=2024-07-24T16:31:13Z&se=2034-07-25T00:31:13Z&spr=https&sv=2022-11-02&sr=b&sig=%2FcTD%2FZU7qJiPSvMNC3cor42XouqMc9q6KFVxR4EtVi4%3D&version=2024-07-25'
        },
        {
            name: 'ucx-member-history-element',
            url: 'https://in1ucxmicroui.blob.core.windows.net/memberhistoryelement/ucx-member-history-element.js?sp=r&st=2023-08-07T14:30:40Z&se=2033-12-31T23:30:40Z&spr=https&sv=2022-11-02&sr=b&sig=EVYBBbBWG5ov20oAfHGBlFWuyafIlBPjVISDbAYT%2BkQ%3D',
            version: 'https://in1ucxmicroui.blob.core.windows.net/memberhistoryelement/src/config/version.json?sp=r&st=2024-03-13T21:51:52Z&se=2034-03-14T05:51:52Z&spr=https&sv=2022-11-02&sr=b&sig=xtIek6FxLgyLQwarm4zYrmaHioaoQd5RwdodpfjEu8Q%3D'
        },
        {
            name: 'clinical-routing-ui-component',
            url: 'https://in1ucxmicroui.blob.core.windows.net/clinicalroutinguicomponent/build/ucx-clinical-routing-component.js?sp=r&st=2021-10-13T14:02:56Z&se=2031-10-01T22:02:56Z&spr=https&sv=2020-08-04&sr=b&sig=IRrus88iDVryKvMT3jubQsMsHz1FUX5bNW8FHeOIO7E%3D'
        },
        {
            name: 'ucx-header',
            url: 'https://in1ucxmicroui.blob.core.windows.net/ucxheadermicroui/ucx-header.js?sp=r&st=2022-05-20T19:50:17Z&se=2030-05-21T03:50:17Z&sv=2020-08-04&sr=b&sig=7c3RBF8aNASRMGUb18RpgwwdYcQnYP7eQuMYBdge8v4%3D&version=2024-01-12',
            version: 'https://in1ucxmicroui.blob.core.windows.net/ucxheadermicroui/version.json?sp=r&st=2024-04-26T16:19:51Z&se=2034-04-27T00:19:51Z&spr=https&sv=2022-11-02&sr=b&sig=rVHkj28honLZRCh8D2KKeabdZCu759DPO7gC7s5kW%2B4%3D'
        },
        {
            name: 'ucx-request-provider-details',
            url: 'https://eheu2in1ucxrpdetailfd.azurefd.net/ucx-request-provider-details.bundle.js?ts=2024-01-10T14:05:53Z',
            version: 'https://eheu2in1ucxrpdetailfd.azurefd.net/version.json'
        },
        {
            name: 'ucx-request-member-details',
            url: 'https://eheu2in1ucxrmdetailfd.azurefd.net/ucx-request-member-details.bundle.js'
        },
        {
            name: 'decision-ui',
            url: 'https://eheu2in1ucxdecisionfrontdoor.azurefd.net/ucx-decision.bundle.js?ts=2023-12-05'
        },
        {
            name: 'ucx-qualifier-ui',
            url: 'https://in1ucxmicroui.blob.core.windows.net/ucxqualifierui/ucx-qualifier-ui.js?sp=r&st=2023-01-27T18:50:31Z&se=2033-01-28T02:50:31Z&spr=https&sv=2021-06-08&sr=b&sig=SNM9Zjo59RGQmB15ePiqoKzGtFINQALIeun%2Fy%2Bj%2BsdM%3D&version=2024-03-27',
            version: 'https://in1ucxmicroui.blob.core.windows.net/ucxqualifierui/version.json?sp=r&st=2024-03-22T15:23:13Z&se=2031-01-01T00:23:13Z&spr=https&sv=2022-11-02&sr=b&sig=93uPIyb9mAJI%2FjE0XIl4aj9EoUn%2FlHaeeTbmGA6XH%2FY%3D'
        },
        {
            name: 'ucx-caselock',
            url: 'https://in1ucxmicroui.blob.core.windows.net/ucxcaselockmicroui/ucx-caselock.js?sp=r&st=2023-09-29T18:07:43Z&se=2033-09-30T02:07:43Z&spr=https&sv=2022-11-02&sr=b&sig=%2BYDRXSAk5NTctkjwaI6HiKnwaC26to4%2BaAucZ%2BJOYpI%3D&version=02-14-2024'
        }
    ],
    isMemberHistoryCollapsed: false
};

const pd1 = {
    ENV: 'pd1',
    clientId: '50f93070-d2de-476d-9f34-45cae62932c0',
    scope: 'https://evicorepd1b2c.onmicrosoft.com/17f930aa-1001-4bf5-b82a-6d416b84aa3b/ucxauth/user_access',
    authority: 'https://evicorepd1b2c.b2clogin.com/evicorepd1b2c.onmicrosoft.com/B2C_1A_UCX_SUSI',
    redirectUrl: 'https://ucx.evicore.com',
    b2cApiClientId: '17f930aa-1001-4bf5-b82a-6d416b84aa3b',
    apiBaseUrl: 'https://api.innovate.lan/',
    apiHostedBaseUrl: 'https://apihosted.innovate.lan/ucx/',
    routingSubscriptionKey: '89085873b54942ad904518199d309fac',
    activityLogTempApiBaseUrl: 'https://eheu2pd1-as-ucx-activitylogservice.sites.innovate.lan/',
    userGroup: 'pd1_ucx_md',
    clinicalRoutingServiceUserRole: 'MD',
    clinicalRoutingServiceDiscipline: 'Sleep',
    caseLockApiBaseUrl: 'https://apihosted.innovate.lan/ucxcaselockservice/api/caseLock/',
    logoutAfterIdleTime: 3600000,
    attachmentPollingForIdleLogout: 3000,
    appInsights: {
        instrumentationKey: '35e36865-4864-48bb-8ee0-b4201795ab95'
    },
    upadsConfig: {
        reviewType: "UCXMDDecision",
        upadsShowHistory: true,
        upadsSystem: "eP",
        upadsForceNewReview: true,
        upadsUpadsApiUrl: "https://api.innovate.lan/upads/v1/",
        upadsPublicServiceUrl: "https://ehpd1upadsvm1.innovate.lan/Upads.Public.Service/",
        upadsContentApiUrl: "https://api.innovate.lan/upads/content/v1/",
        upadsServicesUrl: "https://api.innovate.lan/Upads/Upads",
        upadsServicesGenericRole: "MD",
        upadsServicesRequestType: upadsServiceRequestType.Sleep,
        upadsErrorMessage: "Could not connect to Physician Action Workflow",
        xPlatformUpadsControlJs: 'https://pd1eu2m2upads01jscontrolep.azureedge.net/upadsjscontrol/latest/upads-ui-control.js',
        xPlatformUpadsControlCss: 'https://pd1eu2m2upads01jscontrolep.azureedge.net/upadsjscontrol/latest/styles.css'
    },
    microComponents: [
        {
            name: 'activity-log',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/activitylogmicroui/ucx-activity-log-micro-ui.js?sp=r&st=2023-08-07T14:33:49Z&se=2033-12-31T23:33:49Z&spr=https&sv=2022-11-02&sr=b&sig=WZifr1zw8ySqtht6ULUrTgrc6O9L2w%2Bwkrg0%2FT1wqgo%3D&version=2024-01-31',
            version: 'https://pd1ucxmicroui.blob.core.windows.net/activitylogmicroui/src/config/version.json?sp=r&st=2024-04-10T16:42:56Z&se=2031-01-01T01:42:56Z&spr=https&sv=2022-11-02&sr=b&sig=fmPpGR2N74%2F8pkrUYbSMLvvu5IJ3F02nYCJ6xbfLgTI%3D'
        },
        {
            name: 'ucx-attachments',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/ucxattachmentsmicroui/ucx-attachments.js?sp=r&st=2022-05-17T19:38:48Z&se=2027-05-18T03:38:48Z&spr=https&sv=2020-08-04&sr=b&sig=gXcdpT7Vyogl%2FGZEQKKtc9AO0Aljmklq43i8ADUoQq8%3D&version=01-11-2024',
            version: 'https://pd1ucxmicroui.blob.core.windows.net/ucxattachmentsmicroui/version.json?sp=r&st=2024-02-22T17:47:57Z&se=2034-02-23T01:47:57Z&spr=https&sv=2022-11-02&sr=b&sig=%2FfnQcqdJ6dImOVYZS0Qw2aNCzjLgblBCfwrErthu%2FHI%3D'
        },
        {
            name: 'ucx-diagnosis-ui',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/ucxdiagnosisui/ucx-diagnosis-ui.js?sp=r&st=2023-06-09T13:49:41Z&se=2033-06-09T21:49:41Z&spr=https&sv=2022-11-02&sr=b&sig=Vt%2BLJ959m70UpuIYMvoya8Uokfh%2FbBbsvBlrlnNKerM%3D'
        },
        {
            name: 'ucx-free-form-note-element',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/freeformnoteelement/ucx-free-form-note-element.js?sp=r&st=2023-08-07T15:05:11Z&se=2034-01-01T00:05:11Z&spr=https&sv=2022-11-02&sr=b&sig=4l6XfUWFWGGQ95o78YwqL2elcvg5tnjEpy%2BFxITqOek%3D',
            version: 'https://pd1ucxmicroui.blob.core.windows.net/freeformnoteelement/src/config/version.json'
        },
        {
            name: 'procedures',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/proceduresmicroui/ucx-procedures-micro-ui.js?sp=r&st=2024-07-24T17:05:24Z&se=2034-07-25T01:05:24Z&spr=https&sv=2022-11-02&sr=b&sig=QxhJy3MrgYPE8qjzhGMmm07Z7gTt5hGmtvZVMhiPN7k%3D',
            version: 'https://pd1ucxmicroui.blob.core.windows.net/proceduresmicroui/version.json?sp=r&st=2024-07-24T17:05:50Z&se=2034-07-25T01:05:50Z&spr=https&sv=2022-11-02&sr=b&sig=43t2K9g9UrxUMYYif98RRVxHVXnpfqMDMvH2%2BORv6ew%3D'
        },
        {
            name: 'upads',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/upadsmicroui/ucx-upads-micro-ui.js?sp=r&st=2024-07-24T17:06:18Z&se=2034-07-25T01:06:18Z&spr=https&sv=2022-11-02&sr=b&sig=X8J7o2pP1%2BQ9TV4A60SyyVy3RieyW67DKaN7JHRlsEQ%3D&version=2024-07-25'
        },
        {
            name: 'ucx-member-history-element',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/memberhistoryelement/ucx-member-history-element.js?sp=r&st=2023-08-07T14:35:29Z&se=2033-12-31T23:35:29Z&spr=https&sv=2022-11-02&sr=b&sig=kRvGdwrKdhzgjS3Rdh9CqWNEwPbcX%2BN0qILXWqJqZb8%3D',
            version: 'https://pd1ucxmicroui.blob.core.windows.net/memberhistoryelement/src/config/version.json?sp=r&st=2024-03-18T14:50:20Z&se=2034-03-18T22:50:20Z&spr=https&sv=2022-11-02&sr=b&sig=w3p9tFOTZ7%2BTAjkJkm6AMe6jO%2BY2lPUZ9iPt14WzcVA%3D'
        },
        {
            name: 'clinical-routing-ui-component',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/clinicalroutinguicomponent/build/ucx-clinical-routing-component.js?sp=r&st=2021-10-15T18:10:26Z&se=2031-10-02T02:10:26Z&spr=https&sv=2020-08-04&sr=b&sig=TUtXb8FChZXIFYehHecchgVWyug1uUwLZeNa2CVPb9g%3D'
        },
        {
            name: 'ucx-header',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/ucxheadermicroui/ucx-header.js?sp=r&st=2022-05-23T22:08:27Z&se=2030-05-24T06:08:27Z&sv=2020-08-04&sr=b&sig=SZgRoDXH%2BcpsejeOIP9%2FunXyWMP04dfyB6v%2FJYn1MUc%3D&version=2024-01-12',
            version: 'https://pd1ucxmicroui.blob.core.windows.net/ucxheadermicroui/version.json?sp=r&st=2024-04-26T17:30:42Z&se=2034-04-27T01:30:42Z&spr=https&sv=2022-11-02&sr=b&sig=AgdiVNNkm3OOxf81HUV4nCpVjwEhG1fxAlB8rdfUCjA%3D'
        },
        {
            name: 'ucx-request-provider-details',
            url: 'https://ehcuspd1ucxrpdetailfd.azurefd.net/ucx-request-provider-details.bundle.js?ts=2024-01-10T14:05:53Z',
            version: 'https://ehcuspd1ucxrpdetailfd.azurefd.net/version.json'
        },
        {
            name: 'ucx-request-member-details',
            url: 'https://ehcuspd1ucxrmdetailfd.azurefd.net/ucx-request-member-details.bundle.js'
        },
        {
            name: 'decision-ui',
            url: 'https://ehcuspd1ucxdecisionfrontdoor.azurefd.net/ucx-decision.bundle.js?ts=2023-12-05'
        },
        {
            name: 'ucx-qualifier-ui',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/ucxqualifierui/ucx-qualifier-ui.js?sp=r&st=2023-01-31T15:37:50Z&se=2033-01-31T23:37:50Z&spr=https&sv=2021-06-08&sr=b&sig=xs1ZGWgLySJvJwJ0K%2FB4PQ4TjEnAGLa0pjs5XNsz7dk%3D&version=2024-03-27'
        },
        {
            name: 'ucx-caselock',
            url: 'https://pd1ucxmicroui.blob.core.windows.net/ucxcaselockmicroui/ucx-caselock.js?sp=r&st=2023-10-02T14:34:20Z&se=2033-10-02T22:34:20Z&spr=https&sv=2022-11-02&sr=b&sig=ovCqqLnpNd0prrW%2B1JB8eWcuZb%2FpYXTFJA8a7xiH4qk%3D&version=02-14-2024'
        }
    ]
}

const local = {
    ENV: 'local',
    clientId: '9f3eb1b4-c333-47ef-ad11-44745710b07e',
    scope: 'https://ehdv1b2c.onmicrosoft.com/5f3a640a-613f-4696-afff-5c740cc371cf/ucxauth/user_access',
    authority: 'https://ehdv1b2c.b2clogin.com/ehdv1b2c.onmicrosoft.com/B2C_1A_UCX_SUSI',
    redirectUrl: 'http://localhost:3000',
    b2cApiClientId: '5f3a640a-613f-4696-afff-5c740cc371cf',
    apiBaseUrl: 'https://dv1api.innovate.lan/',
    apiHostedBaseUrl: 'https://dv1apihosted.innovate.lan/ucx/',
    routingSubscriptionKey: '4db64eb47f164734a6c4b6fdbe9ad0b6',
    activityLogTempApiBaseUrl: 'https://eheu2dv1-as-ucx-activitylogservice.sites.innovate.lan/',
    userGroup: 'dv1_EpSleepMedicalDirector',
    clinicalRoutingServiceUserRole: 'MD',
    clinicalRoutingServiceDiscipline: 'Sleep',
    caseLockApiBaseUrl: 'https://dv1apihosted.innovate.lan/ucxcaselockservice/api/caseLock/',
    // logoutAfterIdleTime: 10000, // For Testing Locally
    logoutAfterIdleTime: 3600000,
    attachmentPollingForIdleLogout: 3000,
    appInsights: {
        instrumentationKey: '75584c12-a500-4063-88ad-3cd9a2e2c44f'
    },
    upadsConfig: {
        reviewType: "UCXMDDecision",
        upadsShowHistory: true,
        upadsSystem: "eP",
        upadsForceNewReview: true,
        upadsUpadsApiUrl: "https://dv1api.innovate.lan/upads/v1/",
        upadsPublicServiceUrl: "https://ehdv1upadsvm1.innovate.lan/Upads.Public.Service/",
        upadsContentApiUrl: "https://dv1api.innovate.lan/upads/content/v1/",
        upadsServicesUrl: "https://dv1api.innovate.lan/Upads/Upads",
        upadsServicesGenericRole: "MD",
        upadsServicesRequestType: upadsServiceRequestType.Sleep,
        upadsErrorMessage: "Could not connect to Physician Action Workflow",
        xPlatformUpadsControlJs: 'https://dv1eu2m2upads01jscblob.blob.core.windows.net/upadsjscontrol/latest/upads-ui-control.js',
        xPlatformUpadsControlCss: 'https://dv1eu2m2upads01jscblob.blob.core.windows.net/upadsjscontrol/latest/styles.css'
    },
    microComponents: [
        {
            name: 'activity-log',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/activitylogmicroui/ucx-activity-log-micro-ui.js?sp=r&st=2023-08-07T14:25:42Z&se=2033-12-31T23:25:42Z&spr=https&sv=2022-11-02&sr=b&sig=byPLDG9JuKX3LxcOXGGQM5tKq1PI0TKCGRWwNMuFLvY%3D&version=2024-01-31'
        },
        {
            name: 'ucx-attachments',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/ucxattachmentsmicroui/ucx-attachments.js?sp=r&st=2022-05-10T13:43:52Z&se=2027-05-10T21:43:52Z&spr=https&sv=2020-08-04&sr=b&sig=pZ2T5Rf0bGK0Ur5rDoyW2e39TWqLQPh0zPbiSzYrylM%3D&version=01-11-2024',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/ucxattachmentsmicroui/version.json?sp=r&st=2024-02-20T17:29:34Z&se=2034-02-21T01:29:34Z&spr=https&sv=2022-11-02&sr=b&sig=HFR%2BcgxcagbbcsSMB7UGVCRJ17hz1d1NEVxrFcphMms%3D'
        },
        {
            name: 'ucx-diagnosis-ui',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/ucxdiagnosisui/ucx-diagnosis-ui.js?sp=r&st=2023-05-31T17:09:01Z&se=2033-06-01T01:09:01Z&spr=https&sv=2022-11-02&sr=b&sig=XjsTEfNCks%2BJLpLHXfG5rtoifcnAJETniorQStsGbf0%3D'
        },
        {
            name: 'ucx-free-form-note-element',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/freeformnoteelement/ucx-free-form-note-element.js'
        },
        {
            name: 'procedures',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/proceduresmicroui/ucx-procedures-micro-ui.js?sp=r&st=2024-07-24T16:14:36Z&se=2034-07-25T00:14:36Z&spr=https&sv=2022-11-02&sr=b&sig=sIwTXPi0bNLK7DrzpNHZzybyKiK3WMz2MKEw%2BdswoYk%3D',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/proceduresmicroui/version.json?sp=r&st=2024-07-24T16:16:10Z&se=2034-07-25T00:16:10Z&spr=https&sv=2022-11-02&sr=b&sig=pspPBR%2FAmwimjvP0r9MRut9Zbf1AtLgFCi%2BmTXYnDCk%3D'
        },
        {
            name: 'upads',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/upadsmicroui/ucx-upads-micro-ui.js?sp=r&st=2024-07-24T16:17:04Z&se=2034-07-25T00:17:04Z&spr=https&sv=2022-11-02&sr=b&sig=wHpfzhdrPmF3HRg6bn%2B3qDj3foRypUiLBQyL8cnbUS4%3D&version=2024-07-25'
        },
        {
            name: 'ucx-member-history-element',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/memberhistoryelement/ucx-member-history-element.js?sp=r&st=2023-08-07T13:47:07Z&se=2033-12-31T22:47:07Z&spr=https&sv=2022-11-02&sr=b&sig=xXvPPOJsrqwDbt5e0XR36TglgSieM%2FmB3J0G%2BY7gJ2s%3D',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/memberhistoryelement/src/config/version.json?sp=r&st=2024-03-13T19:21:10Z&se=2034-03-14T03:21:10Z&spr=https&sv=2022-11-02&sr=b&sig=O3yhQ5Zo2kDXIyizccFzOvNV6CzOArmZ0pwDKe0KAcY%3D'
        },
        {
            name: 'clinical-routing-ui-component',
            // url: 'ucx-clinical-routing-component.js'
            url: 'https://dv1ucxmicroui.blob.core.windows.net/clinicalroutinguicomponent/build/ucx-clinical-routing-component.js?sp=r&st=2021-10-13T14:00:46Z&se=2031-10-13T22:00:46Z&spr=https&sv=2020-08-04&sr=b&sig=7cAROKj%2BjvF5SbdNpBnEh1slALkv1rps8E3Hd2YK17o%3D'
        },
        {
            name: 'ucx-header',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/ucxheadermicroui/ucx-header.js?sp=r&st=2022-05-16T18:51:02Z&se=2030-05-17T02:51:02Z&sv=2020-08-04&sr=b&sig=fU4UOxzRZJ%2BZ7%2FXTs2kwsQpGEacyzJjoiRtw0jdg9tk%3D&version=2024-01-12',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/ucxheadermicroui/version.json?sp=r&st=2024-04-26T15:55:57Z&se=2034-04-26T23:55:57Z&spr=https&sv=2022-11-02&sr=b&sig=6beMlOb8KdnQN59FRhVlf0L6zOPHWOHGZEOCiFyFxJ4%3D'
        },
        {
            name: 'ucx-request-provider-details',
            url: 'https://eheu2dv1ucxrpdetailfd.azurefd.net/ucx-request-provider-details.bundle.js?ts=2023-09-07T14:05:53Z',
            version: 'https://eheu2dv1ucxrpdetailfd.azurefd.net/version.json'
        },
        {
            name: 'ucx-request-member-details',
            url: 'https://ehcuspd1ucxrmdetailfd.azurefd.net/ucx-request-member-details.bundle.js'
        },
        {
            name: 'decision-ui',
            url: 'https://eheu2dv1ucxdecisionfrontdoor.azurefd.net/ucx-decision.bundle.js'
        },
        {
            name: 'ucx-qualifier-ui',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/ucxqualifierui/ucx-qualifier-ui.js?sp=r&st=2023-01-25T16:02:54Z&se=2033-01-26T00:02:54Z&spr=https&sv=2021-06-08&sr=b&sig=%2Bnlw6ayeS%2FVtopa9r%2F1cIzjpUqOUtk%2FHyXyOIB0RtpE%3D&version=2024-03-27',
            version: 'https://dv1ucxmicroui.blob.core.windows.net/ucxqualifierui/version.json?sp=r&st=2024-03-22T15:26:01Z&se=2031-01-01T00:26:01Z&spr=https&sv=2022-11-02&sr=b&sig=SIWUNOv6YymqJozRQT8mPRDS8sMiB3b9%2FUAMwkIVhaM%3D'
        },
        {
            name: 'ucx-caselock',
            url: 'https://dv1ucxmicroui.blob.core.windows.net/ucxcaselockmicroui/ucx-caselock.js?sp=r&st=2023-09-16T11:59:42Z&se=2033-09-16T19:59:42Z&spr=https&sv=2022-11-02&sr=b&sig=DrozMMWufP0di6IJbj6SCumsNWjxFSsg%2B1TCNG3qY2A%3D&version=02-14-2024'
        }
    ]
};

let config: any;

if (process.env.REACT_APP_STAGE === 'dv1') {
    config = dv1;
} else if (process.env.REACT_APP_STAGE === 'in1') {
    config = in1;
} else if (process.env.REACT_APP_STAGE === 'pd1') {
    config = pd1;
} else {
    config = local;
}

config.microUIHost = [
    {
        name: 'request-search',
        label: "Search Cases",
        icon: 'fa-search',
        webComponentType: 'request-search',
        isMainMenu: true,
        files: [{
            name: 'request-search',
            url: `${process.env.REACT_APP_SEARCH_MICROUI_HOST}/ucx-request-search.bundle.js?ts=2023-09-29T10:40:53Z`,
            version: `${process.env.REACT_APP_SEARCH_MICROUI_HOST}/version.json`
        }]
    },
]

export { config as default };


TYPES.TS
import Attachment from './attachment';
import Diagnosis from './diagnosis';
import Note from './note';
import ProcedureCode from './procedureCode';

class RequestForService {
    key: string;
    requestId: string;
    requestType: string;
    authorizationKey: string;
    lineOfBusiness: string;
    insurer: string;
    status: string;
    memberFirstName: string;
    memberMiddleName: string;
    memberLastName: string;
    memberGender: string;
    memberDateOfBirth: string;
    memberPolicyId: string;
    memberIsErisa: boolean;
    memberIsFullyInsured: boolean;
    memberJurisdictionState: string;
    memberPolicyStartDate: string;
    memberPolicyEndDate: string;
    memberStateCode: string;
    medicalDiscipline: string;
    age: number;
    diagnoses: Diagnosis[];
    procedures: ProcedureCode[];
    attachments: Attachment[];
    notes: Note[];
    isUrgent: boolean;
    
    constructor(key: string, requestId: string, requestType: string, authorizationKey: string, lineOfBusiness: string,
        insurer: string, status: string, memberFirstName: string, memberMiddleName: string,
        memberLastName: string, memberGender: string, memberDateOfBirth: string,
        memberPolicyId: string, memberIsErisa: boolean, memberIsFullyInsured: boolean,
        memberJurisdictionState: string, memberPolicyStartDate: string, memberPolicyEndDate: string,
        memberStateCode: string, age: number, medicalDiscipline: string,diagnoses: Diagnosis[],
        procedures: ProcedureCode[], attachments: Attachment[], notes: Note[], isUrgent: boolean) {
            this.key = key;
            this.requestId = requestId;
            this.requestType = requestType;
            this.authorizationKey = authorizationKey;
            this.lineOfBusiness = lineOfBusiness;
            this.insurer = insurer;
            this.status = status;
            this.memberFirstName = memberFirstName;
            this.memberMiddleName = memberMiddleName;
            this.memberLastName = memberLastName;
            this.memberGender = memberGender;
            this.memberDateOfBirth = memberDateOfBirth;
            this.memberPolicyId = memberPolicyId;
            this.memberIsErisa = memberIsErisa;
            this.memberIsFullyInsured = memberIsFullyInsured;
            this.memberJurisdictionState = memberJurisdictionState;
            this.memberPolicyStartDate = memberPolicyStartDate;
            this.memberPolicyEndDate = memberPolicyEndDate;
            this.memberStateCode = memberStateCode;
            this.age = age;
            this.diagnoses = diagnoses;
            this.procedures = procedures;
            this.attachments =  attachments;
            this.notes = notes;
            this.isUrgent = isUrgent;
            this.medicalDiscipline = medicalDiscipline;
        }
}

export default RequestForService;

TESTDATA.TS

import LookUpRequest from "../types/lookup";
import RequestForService from "../types/requestForService";

export const testLookupData: LookUpRequest[] =
[
    {
        requestForServiceKey: "85b444cf-f62a-4682-b57b-a22927c40dbd",
        requestForServiceId: "N191316TQT",
        authorizationKey: '85b444cf-f62a-4682-b57b-a22927c40dbd',
        diagnoses: [],
        procedures: [
            {
            code: "G0399",
            description: "Home sleep study test (HST), home based device with 4 channels used to monitor your sleep and breathing during sleep"
        },
        {
            code: "G0398",
            description: "Home sleep study test (HST), home based device with 4 channels used to monitor your sleep and breathing during sleep"
        }
        ]
    }

]

export const testData: RequestForService[] =
[
    {
        key: "test-key",
        requestId: "N191316TQT",
        requestType: "Initial",
        authorizationKey: '85b444cf-f62a-4682-b57b-a22927c40dbd',
        insurer: "Cigna",
        lineOfBusiness: "Commercial",
        status: "Approved",
        memberFirstName: "ZEPH",
        memberMiddleName: "L",
        memberLastName: "TAANNER",
        memberGender: "M",
        memberPolicyId: "91905825501",
        age: 50,
        attachments: [
        {
        fileName: "UCX Sleep Attachment, pdf sample.pdf",
        fileDateTimeUtc: new Date("2020-11-20T23:33:38"),
        objectValetId: 41527118,
        type: "ClinicalInformation",
        templateName: ""
        },
        {
        fileName: "pdf-sample.pdf",
        fileDateTimeUtc: new Date("2020-11-20T23:44:33"),
        objectValetId: 41527125,
        type: "ClinicalInformation",
        templateName: ""
        },
        {
        fileName: "2020 Payroll and Holiday Schedule.pdf",
        fileDateTimeUtc: new Date("2020-11-20T23:44:33"),
        objectValetId: 41527126,
        type: "ClinicalInformation",
        templateName: ""
        }
        ],
        diagnoses: [],
        procedures: [
            {
            code: "G0399",
            description: "Home sleep study test (HST), home based device with 4 channels used to monitor your sleep and breathing during sleep"
        },
        {
            code: "G0398",
            description: "Home sleep study test (HST), home based device with 4 channels used to monitor your sleep and breathing during sleep"
        }
        ],
        memberDateOfBirth: "1970-05-11T00:00:00",
        notes: [],
        memberIsErisa: true,
        memberIsFullyInsured: true,
        memberJurisdictionState: "TN",
        memberPolicyStartDate: "1970-05-11T00:00:00",
        memberPolicyEndDate: "1970-05-11T00:00:00",
        memberStateCode: "TN",
        isUrgent: false,
        medicalDiscipline: "Sleep"
    },
    {
        key: "test-key2",
        requestId: "80CJ5DW3NH",
        requestType: "Initial",
        authorizationKey: '10b444cf-f62a-4682-b57b-a22927c90ac',
        insurer: "Cigna",
        lineOfBusiness: "Commercial",
        status: "Approved",
        memberFirstName: "MARY",
        memberMiddleName: "L",
        memberLastName: "SMITH",
        memberGender: "F",
        memberPolicyId: "91905825502",
        age: 50,
        attachments: [
        {
        fileName: "UCX Sleep Attachment, pdf sample.pdf",
        fileDateTimeUtc: new Date("2020-11-20T23:33:38"),
        objectValetId: 41527118,
        type: "ClinicalInformation",
        templateName: ""
        },
        {
        fileName: "pdf-sample.pdf",
        fileDateTimeUtc: new Date("2020-11-20T23:44:33"),
        objectValetId: 41527125,
        type: "ClinicalInformation",
        templateName: ""
        },
        {
        fileName: "2020 Payroll and Holiday Schedule.pdf",
        fileDateTimeUtc: new Date("2020-11-20T23:44:33"),
        objectValetId: 41527126,
        type: "ClinicalInformation",
        templateName: ""
        }
        ],
        diagnoses: [
        {
            code: "S1868",
            description: "Sleep Apnea",
        }
                  ],
        procedures: [
        {
            code: "G0399",
            description: "Home sleep study test (HST), home based device with 4 channels used to monitor your sleep and breathing during sleep"
        }

        ],
        memberDateOfBirth: "1970-05-11T00:00:00",
        notes: [],
        memberIsErisa: true,
        memberIsFullyInsured: true,
        memberJurisdictionState: "TN",
        memberPolicyStartDate: "1970-05-11T00:00:00",
        memberPolicyEndDate: "1970-05-11T00:00:00",
        memberStateCode: "TN",
        isUrgent: false,
        medicalDiscipline: "RadiationTherapy"
        
    }

];

STATE/REDUCERS/INDEX.TS
import { combineReducers } from "redux";
// import { requestReducer } from "./requestReducer";
//import { authReducer } from "./auth-reducer";
  
export const rootReducer = combineReducers({ } as any);

STATE/REDUCERS/REQUEST-REDUCER.TS
export const RequestReducer = (state: any, action: any) => {
  switch (action.type) {
    case "SET_REQUEST":
      return {
        ...state,
        request: action.payload,
      };
    case "SET_LOOKUP_REQUEST":
      return {
        ...state,
        lookupRequest: action.payload,
      };
    case "SET_GET_NEXT_REQUEST_KEY":
      return {
        ...state,
        getNextRequestId: action.payload,
      };
    case "SET_REFRESH_REQUEST_KEY":
      return {
        ...state,
        refreshRequestKey: action.payload,
      };
    case "SET_REFRESH":
      return {
        ...state,
        refresh: action.payload,
      };
    case "SET_ERROR":
      return {
        ...state,
        error: action.payload,
      };
    case "SET_BAD_TOKEN":
      return {
        ...state,
        badToken: action.payload,
      };
    case "SET_ACCESS_TOKEN":
      if (action.payload === state.accessToken) return state;
      return {
        ...state,
        accessToken: action.payload,
      };
    case "SET_IDLE_TIMEOUT":
      return {
        ...state,
        idleTimeout: action.payload,
      };
    case "SET_ORIGIN_SYSTEM":
      return {
        ...state,
        originSystem: action.payload,
      };
    default:
      return state;
  }
};


STATE/STORE/REDUXSTORE.TS
import { createStore, applyMiddleware } from "redux";
import { rootReducer } from "../reducers/index";
import thunk, { ThunkMiddleware } from "redux-thunk";
import { createLogger } from "redux-logger";

const logger = createLogger();

export type AppState = ReturnType<typeof rootReducer>;

export const ucxReduxStore = createStore(
  rootReducer,
  applyMiddleware(thunk as ThunkMiddleware<AppState>, logger)
);

STATE/STORE/REQUEST-STORE.TS
import React, {createContext, useReducer} from "react";
import LookupRequest from "../../types/lookup";
import { RequestReducer } from '../reducers/request-reducer';

type Props = {
    children: React.ReactNode
}

const initialState = {
    request: localStorage.getItem("currentRequest") === null ? {} as LookupRequest : JSON.parse(localStorage.getItem("currentRequest")!),
    refresh: false,
    error: null,
    badToken: false,
    accessToken: "",
    idleTimeout: false,
    getNextRequestId: "",
    refreshRequestKey: "",
    originSystem:"",
};
export const RequestContext = createContext<LookupRequest | {}>(initialState);

const RequestStore = ( { children }: Props ) => {
    const [state, dispatch] = useReducer(RequestReducer, initialState);
    return (
        <RequestContext.Provider value={[state, dispatch]} >
            {children}
        </RequestContext.Provider>
    )
};

export default RequestStore;

AUTH/AUTHPROVIDER.TS
import config from '../utils/config';
import "regenerator-runtime/runtime";
import { PublicClientApplication, LogLevel, RedirectRequest, InteractionRequiredAuthError } from "@azure/msal-browser";
import { AppInsights } from '../AppInsights';

export class AuthProvider {
  public static Application: PublicClientApplication;
  public static _accessToken: string;
  public static _idToken: string;
  
  public static _initialize() {
    AuthProvider.Application = new PublicClientApplication(
      {
        auth: {
          authority: config.authority,
          knownAuthorities: [config.authority],
          clientId: config.clientId,
          redirectUri: config.redirectUrl,
          postLogoutRedirectUri: config.redirectUrl, //???
          navigateToLoginRequestUrl: true,
          //validateAuthority: false, //???
        },
        system: {
          loggerOptions: {
            logLevel: LogLevel.Verbose,
            loggerCallback: (level: LogLevel, message: string, containsPii: boolean) => AppInsights.logEvent(message),
            piiLoggingEnabled: false
          }
        },
        cache: {
          cacheLocation: 'localStorage',
          storeAuthStateInCookie: true,
        }
      })
  }

  // Add here scopes for id token to be used at MS Identity Platform endpoints.
  public static loginRequest: RedirectRequest = {
    scopes: [config.scope],
    prompt: 'login',
  };

  public static GetAccessToken() {
    if (!AuthProvider._accessToken) {
      AuthProvider.Application.acquireTokenSilent(AuthProvider.loginRequest).then(response => {
          AuthProvider._accessToken = response.accessToken;
        }).catch(error => {
            // acquireTokenSilent can fail for a number of reasons, fallback to interaction
            if (error instanceof InteractionRequiredAuthError) {
              AuthProvider.Application.acquireTokenSilent(AuthProvider.loginRequest).then(response => {
                AuthProvider._accessToken = response.accessToken;
              });
            }
        });
    }

    return AuthProvider._accessToken;
}

  public static GetIdToken() {
    if (!AuthProvider._idToken) {
      AuthProvider.Application.acquireTokenSilent(AuthProvider.loginRequest).then(response => {
        AuthProvider._idToken = response.idToken;
      }).catch(error => {
            // acquireTokenSilent can fail for a number of reasons, fallback to interaction
            if (error instanceof InteractionRequiredAuthError) {
              AuthProvider.Application.acquireTokenSilent(AuthProvider.loginRequest).then(response => {
                AuthProvider._idToken = response.idToken;
              });
            }
        });
    }
  
    return AuthProvider._idToken;
  }
}


API.TS
import { dateFormat } from "evicore-component-library/lib/constants";
import config from "../utils/config";
import FetchError from "../types/fetchError";
import { AppInsights } from "../AppInsights";

export async function releaseCaseLock(systemOfRecord: string, contextKey: string, applicationName: string,userRole:string, userId?: string) {
  const body = JSON.stringify({
    systemOfRecord: systemOfRecord,
    contextKey: contextKey,
    userInfo: userId + " - " + userRole,
    applicationName: applicationName
  });
  if (systemOfRecord != "" && contextKey != "" && userId != "") {
    return await fetch(`${config.caseLockApiBaseUrl}deleteLock`, {
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${(window as any).token}`,
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: body
    })
      .then((res) => {
        return res.json()
      }
      )
      .then((data) => {
        if (data.success) {
          //Lock Found
          AppInsights.logEvent(
            `UCX UI_2 ${data.message} for ${contextKey} and ${userId} with Status Code ${data.success}`, {message:data.message,contextKey, userId,statuscode:data.statuscode })
        }
        return data;
      })
      .catch((err) => {
        AppInsights.logExceptionMessage(
          `UCX UI_2 Failed to Delete lock: ${err}`
        );
      });
  }
}

export async function getCaseLockDetails(systemOfRecord: string,
  contextKey: string) {
  if (systemOfRecord != "" && contextKey != "") {
    return await fetch(`${config.caseLockApiBaseUrl}getLock?SystemOfRecord=${systemOfRecord}&ContextKey=${contextKey}`
      , {
        method: "GET",
        headers: {
          Authorization: `Bearer ${(window as any).token}`,
          "Content-Type": "application/json",
          Accept: "application/json",
        },
      })
      .then((res) => {
        return res.json();
      })
  }

}

export async function releaseCaseLockByUserId(systemOfRecord: string, contextKey: string, applicationName: string,userRole:string, userId?: string) {
  const body = JSON.stringify({
    systemOfRecord: systemOfRecord,
    contextKey: contextKey,
    userInfo: userId + " - " + userRole,
    applicationName: applicationName
  });
  if (systemOfRecord != "" && contextKey != "" && userId != "") {
    return await fetch(`${config.caseLockApiBaseUrl}deleteLockByUserID`, {
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${(window as any).token}`,
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: body
    })
      .then((res) => {
        return res.json()
      }
      )
      .then((data) => {
        if (data.success) {
          //Lock Found
          AppInsights.logEvent(
            `UCX UI_2 ${data.message} for ${contextKey} with UserID ${userId} with StatusCode ${data.success}`, {message:data.message,contextKey, userId,statuscode:data.success})
        }else{
          AppInsights.logEvent(
            `UCX UI_2 ${data.message} for ${contextKey} with UserID ${userId} with StatusCode ${data.success}`, { message:data.message,contextKey, userId,statuscode:data.success})
       
        }
        return data;
      })
      .catch((err) => {
        AppInsights.logExceptionMessage(
          `UCX UI_2 Failed to Delete lock: ${err}`
        );
      });
  }
}
import config from "../utils/config";

const baseUrl = config.apiBaseUrl + "clinicalroutingservice/api/v1";
const routingSubscriptionKey = config.routingSubscriptionKey;

export async function postSkipRequest(
  requestForServiceKey: string,
  authToken: string,
  skipExplanation: string,
  skipReasonId: number,
  userId: string
) {
  const body = JSON.stringify({
    requestForServiceKey,
    skipExplanation,
    userId,
    skipReasonId
  });

  return await fetch(`${baseUrl}/UISkipRequest`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${authToken}`,
      'Ocp-Apim-Subscription-Key': routingSubscriptionKey,
      "Content-Type": "application/json",
      Accept: "application/json",
    },
    body: body,
  }).then((response) => {
    return response.json();
  })
  .then((responseData) => {
    return responseData;
  });
}


COMPONENTS
MICROUIHOST.TS
import React, {useState, useEffect, useRef, useContext} from "react";
import config from "../../utils/config";
import { AppInsights } from "../../AppInsights";
import { RouteComponentProps, useHistory } from "react-router-dom";
import {RequestContext} from "../../state/store/request-store";
import { loadExternalScriptWithVersion } from "../../utils/loadExternalScriptWithVersion";

export interface MicroUIHostDefinition {
    name: string;
    label: string;
    icon: string;
    webComponentType: string;
    isMainMenu : boolean;
    files: Array<MicroUIHostFile>;
}

interface MicroUIHostFile {
    name: string;
    url: string;
    version: string | undefined;
}

interface MicroUIHostProps {
    id: string;
}

const MicroUIHost: React.FC<RouteComponentProps<MicroUIHostProps>> = ({
    match, location
}) => {
    const filesLoading = useRef<Array<MicroUIHostFile>>([]);
    const [err, setErr] = useState<string>("");
    const [content, setContent] = useState<any>();
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [state, dispatch] = useContext<any>(RequestContext);
    const history = useHistory();

    useEffect(() => {
        const loadUIScripts = (menuItem : MicroUIHostDefinition): void =>{
            filesLoading.current = menuItem.files.filter((item : MicroUIHostFile)=> !document.getElementById(item.name));
            setIsLoading(filesLoading.current.length > 0);
            setContent(menuItem);
            let filesToLoad = [...filesLoading.current]
            filesToLoad.forEach((item: MicroUIHostFile)=> {
                loadExternalScriptWithVersion(item, loadExternalScript);
            });
        };
    
        const loadExternalScript = (scriptId : string, source : string, file : MicroUIHostFile): void =>{
            const script = document.createElement("script");
            script.id = scriptId;
            script.src = source;
            script.defer = true;
            script.async = true;
            script.onload = (e) => {
                let itemLoaded = filesLoading.current.indexOf(file);
                if(itemLoaded >= 0) {filesLoading.current.splice(itemLoaded, 1);}
                setIsLoading(filesLoading.current.length > 0);
            };
            script.onerror = () => {
                let itemLoaded = filesLoading.current.indexOf(file);
                if(itemLoaded >= 0) {filesLoading.current.splice(itemLoaded, 1);}
                filesLoading.current.splice(itemLoaded, 1);
                let message : string  = `Unable to load script: ${scriptId} micro UI from: ${file} in UCX UI`;
                AppInsights.logExceptionMessage(message);
                setErr(message);
                setIsLoading(filesLoading.current.length > 0);
            };
            document.body.appendChild(script);
        }

        let menuItem : MicroUIHostDefinition = config.microUIHost.find((m: MicroUIHostDefinition) => m.name === match.params.id);
        if(menuItem) {
            loadUIScripts(menuItem);
        } else {
            setErr(`UI is not defined: ${match.params.id} in UCX UI`);
        }
    }, [match.params.id])

    useEffect( () => {
        (window as any).token = state.accessToken;
    }, [state.accessToken]);

    useEffect(() => {
        const navigateHandler =   (e: any) => {
            history.push({
                pathname: e.detail.url
            });
        };
    
        const globalStateHandler =   (e: any) => {
            dispatch({type: e.detail.key, payload: e.detail.payload});
        };

        (window as any).addEventListener("navigateRouter", navigateHandler);
        (window as any).addEventListener("setGlobalState", globalStateHandler);

        return () => {
            (window as any).removeEventListener("navigateRouter", navigateHandler);
            (window as any).removeEventListener("setGlobalState", globalStateHandler);
        };
    }, []);

    const webComponentProps =  () => {
        let elementProps :any = {};
        let cleaned = location.search.replaceAll("?", "");
        let namesAndValues = cleaned.split("&");
        namesAndValues.forEach((nv) => {
            let parsedNamesAndValues = nv.split("=");
            elementProps={...elementProps,...{[parsedNamesAndValues[0]]:parsedNamesAndValues[1]}};
        })
        return elementProps;
    }

    return(
        <div className="content-wrapper">
            {isLoading &&
            <div className="spinner-border text-primary"></div>
            }
            {err &&
                <div className="alert alert-dismissible alert-danger mb-3">
                    <div className="row no-gutters align-items-center">
                        <div className="col-auto align-self-start">
                            <span className="fa-stack"> <i className="fas fa-circle fa-stack-2x"></i> <i className="fas fa-ban fa-stack-1x fa-inverse"></i> </span>
                        </div>
                        <div className="col">
                            <h6 className="alert-heading mb-0">Error</h6>
                            <p className="mb-0">Unable to load UI resource.</p>
                        </div>
                    </div>
                </div>
            }
            {!isLoading && !err && content && state.accessToken &&
                React.createElement(content.webComponentType, webComponentProps())
            }
        </div>
    )
}

export default MicroUIHost;
IDLE-LOGOUT.TSX
import React, { useRef } from "react";
import { NavLink } from "react-router-dom";
import { AuthProvider } from "../../auth/authProvider";
import { useLocalStorage } from "../../utils/useLocalStorage";

function IdleLogout() {
  const [, setIdleTimeoutTriggered] = useLocalStorage<Boolean>('idleTimeoutTriggered', false);

  const loginFn = useRef(() => {});
    loginFn.current = () => {
      setIdleTimeoutTriggered(false);
      AuthProvider.Application.loginRedirect(AuthProvider.loginRequest);
  };

  return (
    <>
      <div className="container py-5 h-100">
        <div className="row d-flex justify-content-center align-items-center h-100">
          <div className="col-12 col-md-8 col-lg-6 col-xl-5">
            <div className="card card-alt">
              <div className="card-header bg-transparent border-bottom-0">
                <div className="logo w-50 h-50 py-5 m-auto">
                  <svg
                    viewBox="0 0 375 278"
                    xmlns="http://www.w3.org/2000/svg"
                    xmlnsXlink="http://www.w3.org/1999/xlink"
                  >
                    <defs>
                      <path id="a" d="M0 0h375.08v277.7H0z" />
                    </defs>
                    <clipPath id="b">
                      <use overflow="visible" xlinkHref="#a" />
                    </clipPath>
                    <path
                      d="M129.17 232.91c-4.001-4.229-3.817-10.899.41-14.9 4.228-4.001 10.899-3.817 14.9.41 3.986 4.231 3.798 10.89-.42 14.89a10.486 10.486 0 01-7.24 2.891c-2.894 0-5.66-1.19-7.65-3.291"
                      clip-path="url(#b)"
                      fill="#CFD7DF"
                    />
                    <path
                      d="M171 263.54c-5.231-2.54-7.414-8.84-4.874-14.071l.004-.009c2.545-5.23 8.847-7.41 14.08-4.87 5.232 2.54 7.414 8.84 4.874 14.071l-.004.009a10.541 10.541 0 01-9.48 5.94 10.367 10.367 0 01-4.6-1.07"
                      clip-path="url(#b)"
                      fill="#C0CBD5"
                    />
                    <path
                      d="M220.8 277.65c-5.784-.599-9.996-5.763-9.42-11.55.6-5.784 5.763-9.996 11.55-9.42 5.786.583 10.005 5.746 9.422 11.531l-.002.019a10.53 10.53 0 01-10.47 9.471 9.749 9.749 0 01-1.08-.051"
                      clip-path="url(#b)"
                      fill="#B3C0CD"
                    />
                    <path
                      d="M259.61 266.16c-1.469-5.627 1.902-11.38 7.53-12.848a.126.126 0 01.01-.003c5.62-1.474 11.37 1.888 12.844 7.508a.658.658 0 00.006.022c1.479 5.619-1.877 11.372-7.496 12.852l-.034.009a10.55 10.55 0 01-12.86-7.54M304.78 249.3c-3.372-4.742-2.267-11.319 2.47-14.7 4.745-3.369 11.323-2.26 14.7 2.48 3.371 4.742 2.267 11.319-2.47 14.7a10.52 10.52 0 01-6.101 1.949 10.53 10.53 0 01-8.599-4.429"
                      clip-path="url(#b)"
                      fill="#A4B4C3"
                    />
                    <path
                      d="M340.9 217.38c-4.871-3.173-6.258-9.688-3.101-14.57 3.174-4.876 9.693-6.267 14.579-3.109 4.878 3.173 6.266 9.696 3.102 14.58a10.533 10.533 0 01-8.852 4.81 10.632 10.632 0 01-5.728-1.711M362.54 174.31c-5.691-1.095-9.428-6.583-8.36-12.279a.737.737 0 010-.199c1.086-5.716 6.593-9.474 12.311-8.401 5.72 1.08 9.481 6.593 8.401 12.313l-.002.008a.834.834 0 000 .1.706.706 0 010 .13 10.52 10.52 0 01-10.34 8.561 10.78 10.78 0 01-2.01-.233"
                      clip-path="url(#b)"
                      fill="#859AAE"
                    />
                    <path
                      d="M354 117.79c-1.148-5.704 2.538-11.261 8.24-12.42 5.703-1.142 11.255 2.549 12.41 8.25 1.153 5.694-2.526 11.246-8.221 12.4l-.05.01c-.694.138-1.401.209-2.11.21A10.53 10.53 0 01354 117.79M337.22 77.031c-3.168-4.87-1.788-11.387 3.082-14.555l.008-.005c4.865-3.176 11.384-1.806 14.561 3.059l.02.031c3.16 4.879 1.778 11.394-3.09 14.57a10.46 10.46 0 01-5.729 1.71 10.53 10.53 0 01-8.852-4.81M306.77 44.871c-4.695-3.421-5.729-10.001-2.309-14.697l.009-.013c3.432-4.703 10.024-5.733 14.728-2.303l.003.003c4.699 3.434 5.726 10.029 2.291 14.728l-.001.002a10.553 10.553 0 01-8.491 4.32 10.484 10.484 0 01-6.23-2.04"
                      clip-path="url(#b)"
                      fill="#768EA4"
                    />
                    <path
                      d="M266.87 25.511c-5.599-1.582-8.857-7.4-7.28-13 1.577-5.603 7.397-8.866 13-7.29 5.599 1.582 8.857 7.4 7.28 13a10.52 10.52 0 01-10.14 7.68 11.012 11.012 0 01-2.86-.39"
                      clip-path="url(#b)"
                    />
                    <path
                      d="M266.87 25.511c-5.599-1.582-8.857-7.4-7.28-13 1.577-5.603 7.397-8.866 13-7.29 5.599 1.582 8.857 7.4 7.28 13a10.52 10.52 0 01-10.14 7.68 11.012 11.012 0 01-2.86-.39"
                      clip-path="url(#b)"
                      fill="#5A7692"
                    />
                    <path
                      d="M211.38 11.381c-.459-5.809 3.877-10.89 9.686-11.349l.015-.001c5.805-.442 10.868 3.905 11.31 9.709v.001c.442 5.797-3.893 10.858-9.689 11.31h-.83a10.54 10.54 0 01-10.492-9.67"
                      clip-path="url(#b)"
                      fill="#3B5D7D"
                    />
                    <path
                      d="M165.84 27.221c-2.458-5.269-.185-11.533 5.08-14 5.269-2.458 11.533-.185 14 5.08 2.452 5.27.181 11.529-5.08 14a10.53 10.53 0 01-4.45 1 10.52 10.52 0 01-9.55-6.08"
                      clip-path="url(#b)"
                      fill="#1F466B"
                    />
                    <path
                      d="M129 58.301c-4.187-4.041-4.321-10.705-.3-14.91 4.034-4.191 10.7-4.325 14.9-.3 4.199 4.029 4.338 10.7.31 14.9a10.498 10.498 0 01-7.61 3.24 10.588 10.588 0 01-7.3-2.93"
                      clip-path="url(#b)"
                      fill="#0D375F"
                    />
                    <path
                      d="M101.66 84.121c-3.349 4.625-2.314 11.09 2.311 14.439l.029.021c4.638 3.351 11.112 2.312 14.47-2.32 3.34-4.644 2.294-11.116-2.34-14.47a10.31 10.31 0 00-7-1.92 10.289 10.289 0 00-7.47 4.25"
                      clip-path="url(#b)"
                      fill="#C99700"
                    />
                    <path
                      d="M16.51 136.87c.17 4 1.77 7.75 7.66 7.75 3.71 0 6-1.771 6.66-4.221h16C45.4 149 37.4 155.48 24.26 155.48 9.1 155.479 0 146.81 0 133.41c0-12.12 8-22.15 23.92-22.15 15.24 0 23.58 9.52 23.58 19.38a34.327 34.327 0 01-.5 6.23H16.51zm0-8H31c0-4.55-2.78-7.33-7.16-7.33s-7.33 2.61-7.33 7.33M63.53 112.44l8.76 24.93 9-24.93h17.19l-19 41.86H65.05l-18.7-41.86zM101.17 112.44h16.51v41.859h-16.51zM178.4 133.7c-1.74 12.17-11.57 22.3-27.82 22.3-18.23 0-29-13.16-29-27.9s10.66-27.9 28.5-27.9c17.09 0 26.69 10.43 28.13 23.21h-16.44c-.91-5-4.69-8.92-11.19-8.92-8.47 0-12.86 6.43-12.86 13.61 0 7.71 4.92 13.61 13.16 13.61 5.82 0 9.9-3.63 10.89-8l16.63-.01zM181.72 133.41c0-12.21 8.76-22.15 24.339-22.15 15.58 0 24.431 9.94 24.431 22.15 0 12.05-8.84 22.07-24.431 22.07-15.588-.001-24.339-10.02-24.339-22.07m32.18 0c0-4.71-3-8.25-7.841-8.25-4.84 0-7.829 3.54-7.829 8.25 0 4.55 3.119 8.26 7.829 8.26s7.841-3.711 7.841-8.26M267.7 127.27a18.56 18.56 0 00-5.641-.76c-6.319 0-11.199 3-11.199 13v14.74h-16.51v-41.81h16.511v6.66a14.187 14.187 0 0112.55-7.5 12.888 12.888 0 014.29.59v15.08zM285.73 136.87c.17 4 1.77 7.75 7.67 7.75 3.699 0 6-1.771 6.649-4.221h16c-1.43 8.601-9.43 15.081-22.569 15.081-15.16 0-24.25-8.67-24.25-22.069 0-12.12 8-22.15 23.92-22.15 15.239 0 23.58 9.52 23.58 19.38a34.42 34.42 0 01-.511 6.23H285.73zm0-8h14.489c0-4.55-2.779-7.33-7.16-7.33-4.379 0-7.329 2.61-7.329 7.33"
                      clip-path="url(#b)"
                      fill="#002855"
                    />
                    <path
                      d="M101.17 167.31h4v14.891a7.74 7.74 0 017.31-4.2c2.87 0 5 1 6.21 2.74 1.14 1.55 1.6 3.38 1.6 6.3v12.24h-4v-11c0-3.83-1.37-6.761-5.25-6.761s-5.89 3.381-5.89 7.08v10.69h-4l.02-31.98zM129.29 189.96c.19 3.521 1.88 6.49 6.44 6.49 3.11 0 4.61-1.511 5.25-3.29h4c-.68 3.51-4.06 6.62-9.27 6.62-7 0-10.36-4.891-10.36-10.87 0-6.25 3.69-10.91 10.22-10.91 5.157-.139 9.449 3.93 9.587 9.087l.003.273c.013.871-.048 1.739-.18 2.6h-15.69zm.05-3h12a5.6 5.6 0 00-5.84-5.93c-3.56 0-6.07 2.17-6.16 5.92v.01zM171.07 178.55v20.73h-3.93v-3.61a8.241 8.241 0 01-7.26 4.11c-6.014-.003-10.888-4.881-10.886-10.896.003-6.011 4.875-10.882 10.886-10.885a8.239 8.239 0 017.26 4.11v-3.561h3.93zm-3.93 10.36c0-4-2.74-7.351-7-7.351s-6.94 3.38-6.94 7.351c0 3.97 2.74 7.31 6.94 7.31s7-3.34 7-7.31M178.19 167.31h4v32h-4zM200.56 199.28a24.514 24.514 0 01-3.56.271c-2.56 0-6.529-.461-6.529-7.261v-10.41h-3.83v-3.329h3.83v-7h3.999v7h5.391v3.329h-5.391v9.54c0 4 1.42 4.52 3.431 4.52a22.81 22.81 0 002.689-.18l-.03 3.52zM204.81 167.31h4v14.891a7.741 7.741 0 017.311-4.2c2.87 0 5 1 6.211 2.74 1.139 1.55 1.589 3.38 1.589 6.3v12.24h-4v-11c0-3.83-1.37-6.761-5.25-6.761s-5.89 3.381-5.89 7.08v10.69h-4l.029-31.98zM245.17 186.08c-.32-2.561-1.87-4.521-5.75-4.521-4.3 0-6.439 3.471-6.439 7.351s2.05 7.31 6.659 7.31c3.431 0 4.94-1.6 5.58-4.07h4c-.64 4.301-3.79 7.631-9.819 7.631-6.761 0-10.36-5.25-10.36-10.87s3.57-10.88 10.29-10.88 9.45 4.06 9.81 8.08l-3.971-.031zM274.89 178.55v20.73H271v-3.61a8.262 8.262 0 01-7.26 4.11c-5.826.052-10.592-4.629-10.645-10.455-.001-.139 0-.277.004-.415 0-5.891 4.29-10.91 10.641-10.91a8.26 8.26 0 017.26 4.11v-3.561h3.89zM271 188.91c0-4-2.74-7.351-7-7.351s-6.94 3.38-6.94 7.351c0 3.97 2.74 7.31 6.94 7.31s7-3.34 7-7.31M294.84 182.2a7.698 7.698 0 00-2-.23c-4.609 0-6.899 3.24-6.899 8.22v9.091h-4v-20.73h4v4.061a7.618 7.618 0 016.899-4.381 5.015 5.015 0 012 .32v3.649zM300.55 189.96c.181 3.521 1.87 6.49 6.44 6.49 3.1 0 4.609-1.511 5.25-3.29h4c-.69 3.51-4.07 6.62-9.271 6.62-7 0-10.37-4.891-10.37-10.87 0-6.25 3.7-10.91 10.23-10.91 5.156-.139 9.448 3.93 9.587 9.087l.003.273c.013.871-.048 1.739-.18 2.6H300.55zm0-3h12a5.59 5.59 0 00-5.839-5.89c-3.51-.04-6.02 2.13-6.12 5.88l-.041.01z"
                      clip-path="url(#b)"
                      fill="#C99700"
                    />
                  </svg>
                </div>
              </div>
              <div className="card-body px-5 pt-0 pb-5">
                <h1 id="sessionExpiredHeading" className="font-size-md">Session expired</h1>
                <p id="sessionExpiredMessage" className="text-secondary font-size-sm">
                  Your session has expired due to inactivity.
                </p>

                <NavLink
                      to=""
                      id="login-btn"
                      activeClassName="active"
                      className=""
                      onClick={loginFn.current}
                    >
                      <span className="mt-3 btn btn-primary font-size-sm">
                        Login
                      </span>
                  </NavLink>
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  );
}

export default IdleLogout;


import React from 'react';
import { render, screen } from '@testing-library/react';
import { act } from "react-dom/test-utils";

import IdleLogout from './idle-logout';
import { MemoryRouter } from 'react-router';

describe('IdleLogout', () => {

    it('renders Header component', () => {
        act(() => {
            render(
                <MemoryRouter initialEntries={["/"]}>

                    <IdleLogout />);
                </MemoryRouter>
            
            );
        });

        const element = screen.queryAllByText(/Session expired/i);
        expect(element[0]).toBeInTheDocument();
    });

});


HOME.TSX
import React, { useContext, useEffect } from 'react';
import IdleLogout from '../idle-logout/idle-logout';
import { RequestContext } from '../../state/store/request-store';

function Home () {
    const [state] = useContext<any>(RequestContext);
    
    useEffect( () => {
        (window as any).token = state.accessToken;
    }, [state.accessToken]);

    return (
        <>
            {!state.idleTimeout
                ? 
                <div className="content-wrapper">
                    <div className="container-fluid">
                        <div className="row mt-3">
                            <div className="col-lg-12">
                                <div className="card mb-3">
                                    <div className="card-body p-sm-5 mb-3">
                                        <div className="row">
                                            <div className="col-lg-12">
                                                <div className="row">
                                                    <div className="col-md-12">
                                                        <h1 id="forms" className="text-primary">UCX&nbsp;</h1>
                                                        <h2 className="lead mb-5">
                                                            The UCX will be an application that provides a Universal Clinical Experience regardless of medical disciplines or existing and future platform origin. Unlike having clinicians log into multiple applications, our approach will allow for more efficient and effective processing and an enhanced user experience, which supports our objective to have best-in-class client, provider and patient experiences.<br />
                                                        </h2>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                : <IdleLogout />
            }
        </>
    );
}

export default Home;
import React from 'react';
import { act, render, screen } from '@testing-library/react';
import Home from './home';
import RequestStore from '../../state/store/request-store';

it('renders home text', () => {
    act(() => {
        render(
            <RequestStore>
                <Home />
            </RequestStore>
        );
    });
    const homeTitle = screen.queryAllByText(/UCX/i);
    expect(homeTitle[0]).toBeInTheDocument();
});
  

OTHER COMPS
import React, { useContext, useEffect } from 'react';
import { useHistory } from "react-router-dom";
import { RequestContext } from '../../state/store/request-store';

function ReloadRequest() {
    const history = useHistory();
    const [state] = useContext<any>(RequestContext);
    
    useEffect(() => {
        history.push({
            pathname: `/request/${state.refreshRequestKey}`
        });
    }, [history, state.refreshRequestKey]);

    return (
        <>
            <p>Reload</p>
        </>
    );
}

export default ReloadRequest;

import React, {
  useCallback,
  useContext,
  useEffect,
  useRef,
  useState,
} from "react";
import { NavLink, useHistory, useLocation } from "react-router-dom";
import config from "../../utils/config";
import { AuthProvider } from "../../auth/authProvider";
import logoSm from "../../assets/img/EP-Logo_sm.png";
import logo from "../../assets/img/Ep-Logo.png";
import "./sidebar.css";
import moment from "moment";
import Alert from "../alert/alert";
import { AlertTypes } from "../../utils/constants";
import SignInButton from "./signInButton";
import SignOutButton from "./signOutButton";
import { LOGOUT_TIMEOUT } from "../../utils/constants";
import { AppInsights } from "../../AppInsights";

import { useIdleTimer } from "react-idle-timer";
import { RequestContext } from "../../state/store/request-store";
import { useLocalStorage } from "../../utils/useLocalStorage";
import * as requestApi from "../../api/lookup-request-service-api";
import {
  AuthenticatedTemplate,
  UnauthenticatedTemplate,
  useAccount,
  useIsAuthenticated,
  useMsal,
} from "@azure/msal-react";
import {
  EventMessage,
  EventType,
  InteractionRequiredAuthError,
} from "@azure/msal-browser";
import { ToastContainer } from "evicore-component-library";
import { ToastProps } from "evicore-component-library/lib/atoms/atoms-props";

import { MicroUIHostDefinition } from "../microuihost/microuihost";
import CSS from "csstype";
import jwt_decode from "jwt-decode";
import TimeoutModal from "./timeoutModel";
import * as caseLockApi from "../../api/case-lock-api";
function Sidebar() {
  const { instance, accounts } = useMsal();
  const account = useAccount(accounts[0] || {});
  const isAuthenticated = useIsAuthenticated();
  const history = useHistory();
  const [idleTimeoutTriggered, setIdleTimeoutTriggered] =
    useLocalStorage<Boolean>("idleTimeoutTriggered", false);
  const [state, dispatch] = useContext<any>(RequestContext);
  const [userRole, setUserRole] = useState("");
  const [userId, setUserId] = useState("");
  const [userEmail, setUserEmail] = useState("");
  const [groupType, setGroupType] = useState("");
  const [idToken, setIdToken] = useState("");
  const [accessToken, setAccessToken] = useState("");
  const [activeAlert, setActiveAlert] = useState(false);
  const [showIdleModal, setShowIdleModal] = useState(false);
  const showIdleModalRef = useRef(false);
  const [toasts, setToasts] = useState<Array<ToastProps>>([]);
  const authId = state.lookupRequest == undefined ? "" : state.lookupRequest.requestForServiceId;
  const systemOrigin = state.originSystem;
  const caseLockUserName = account?.username.substring(0,account?.username.indexOf("@"));
  const applicationName="UCX";
  const caselockUserRole=config.clinicalRoutingServiceUserRole;

  const loginFn = useRef(() => { });
  loginFn.current = () => {
    setIdleTimeoutTriggered(false);
    instance.loginRedirect(AuthProvider.loginRequest);
  };
  const location = useLocation();
  const logoutFn = useRef(() => { });
  logoutFn.current = () => {
    caseLockApi.releaseCaseLockByUserId(systemOrigin,authId,applicationName,caselockUserRole,caseLockUserName);
    localStorage.clear();
    sessionStorage.clear();
    instance.logoutRedirect();
  };

  const toastStyles: CSS.Properties = {
    position: "fixed",
    right: "0.5rem",
    top: "1rem",
    zIndex: 5000,
  };

  const callbackId = instance.addEventCallback((message: EventMessage) => {
    // Update UI or interact with EventMessage here
    if (
      message.eventType === EventType.LOGIN_SUCCESS ||
      message.eventType === EventType.ACQUIRE_TOKEN_BY_CODE_SUCCESS ||
      message.eventType === EventType.ACQUIRE_TOKEN_SUCCESS
    ) {
      let idToken = (message?.payload as any)?.idToken;
      let accessToken = (message?.payload as any)?.accessToken;
      if (!!idToken) {
        setIdToken(idToken);
      }
      if (!!accessToken) {
        setAccessToken(accessToken);
      }
    }
  });

  useEffect(() => {
    let localAccount = accounts[0];
    if (!localAccount) {
      return;
    }
    setUserId((localAccount.name as string)?.split(" ")[0]);
    setUserEmail((localAccount.idTokenClaims as any)?.emails[0]);
    if (!AuthProvider?._idToken) {
      getIdToken();
    } else {
      setIdToken(AuthProvider?._idToken);
    }
    if (!AuthProvider?._accessToken) {
      getAccessToken();
    } else {
      setAccessToken(AuthProvider?._accessToken);
    }
  }, [account, isAuthenticated]);

  const defaultTimeout = config.logoutAfterIdleTime;
  const [idleTimeout, setIdleTimeout] = useState(defaultTimeout);

  const reduceIdleTimeout = () => {
    setIdleTimeout(15000);
  };

  let logoutTimer = null as any;

  useEffect(() => {
    showIdleModalRef.current = showIdleModal;
  }, [showIdleModal]);
 
  const handleLogout = () => {
    if (showIdleModalRef.current) {
      logoutTimer = null;
      setIdleTimeoutTriggered(true);
      dispatch({ type: "SET_IDLE_TIMEOUT", payload: true });
      logoutFn.current();
    }
  };

  const handleOnIdle = () => {
    if (!idleTimeoutTriggered) {
      if (logoutTimer) {
        clearTimeout(logoutTimer);
      }
      togglePopup();
      logoutTimer = setTimeout(() => {
        handleLogout();
      }, 1000 * 30 * 1); // 30 seconds
    }
  };

  const togglePopup = () => {
    setShowIdleModal(!showIdleModal);
  };

  const handleStayLoggedIn = () => {
    if (logoutTimer) {
      clearTimeout(logoutTimer);
      logoutTimer = null;
    }
    togglePopup();
  };

  const checkAndRefreshTokens = (e: Event) => {
    if (accessToken && accessToken.length > 0) {
      let token = jwt_decode(accessToken) as any;
      let isTokenExpiring = moment(new Date(token.exp * 1000)).diff(moment(new Date()), "minutes");
      if (isTokenExpiring < 14) {
        getAccessToken();
      }
    }
    if (idToken && idToken.length > 0) {
      let id = jwt_decode(idToken) as any;
      let isIdExpiring = moment(new Date(id.exp * 1000)).diff(moment(new Date()), "minutes");
      if (isIdExpiring < 14) {
        getIdToken();
      }
    }
  };

  useIdleTimer({
    timeout: idleTimeout,
    onIdle: handleOnIdle,
    onAction: checkAndRefreshTokens,

    crossTab: {
      emitOnAllTabs: true,
    },
  });

  const getIdToken = useCallback(async () => {
    const request = {
      ...AuthProvider.loginRequest,
      account: accounts[0],
    };

    if (!AuthProvider._idToken) {
      AuthProvider?.Application?.acquireTokenSilent(request)
        ?.then((response: { idToken: React.SetStateAction<string> }) => {
          setIdToken(response.idToken);
          AppInsights.logEvent(`UCX - Succeeded to aquire idToken in Sidebar`);
        })
        .catch((error: any) => {
          // acquireTokenSilent can fail for a number of reasons, fallback to interaction
          if (error instanceof InteractionRequiredAuthError) {
            AppInsights.logExceptionMessage(
              `UCX - Failed to aquire idToken in Sidebar: ${error}`
            );
            AuthProvider?.Application?.acquireTokenSilent(
              AuthProvider.loginRequest
            )?.then((response: { idToken: React.SetStateAction<string> }) => {
              setIdToken(response.idToken);
            });
          }
        });
    }

    if (account && account.name) {
      setUserId(account.name.split(" ")[0]);
    } else {
      setUserId("");
    }
  }, [account, accounts]);

  const getAccessToken = useCallback(async () => {
    const request = {
      ...AuthProvider.loginRequest,
      account: accounts[0],
    };

    if (!accounts || accounts.length == 0) {
      dispatch({ type: "SET_ACCESS_TOKEN", payload: "" });
    }

    if (!AuthProvider._accessToken) {
      AuthProvider?.Application?.acquireTokenSilent(request)
        ?.then((response: { accessToken: React.SetStateAction<string> }) => {
          setAccessToken(response.accessToken);
          dispatch({ type: "SET_ACCESS_TOKEN", payload: response.accessToken });
          AppInsights.logEvent(
            `UCX - Succeeded to aquire accessToken in Sidebar`
          );
        })
        .catch((error: any) => {
          // acquireTokenSilent can fail for a number of reasons, fallback to interaction
          if (error instanceof InteractionRequiredAuthError) {
            AppInsights.logExceptionMessage(
              `UCX - Failed to aquire accessToken in Sidebar: ${error}`
            );
            AuthProvider?.Application?.acquireTokenSilent(
              AuthProvider.loginRequest
            )?.then(
              (response: { accessToken: React.SetStateAction<string> }) => {
                setAccessToken(response.accessToken);
                dispatch({
                  type: "SET_ACCESS_TOKEN",
                  payload: response.accessToken,
                });
              }
            );
          }
        });
    }
  }, [accounts]);

  useEffect(() => {
    getIdToken();
    getAccessToken();
    dispatch({ type: "SET_IDLE_TIMEOUT", payload: idleTimeoutTriggered });
  }, [dispatch, getAccessToken, getIdToken, idleTimeoutTriggered]);

  const getNextHandler = useCallback(
    (e: any) => {
      if (e.detail.events.requestForServiceKey == null) {
        let toastError: ToastProps = {
          id: e.detail.events.error,
          type: "info",
          title: "Get Next",
          secondaryText: "",
          message: `No requests found.`,
          removeToast: removeToast,
        };
        addNewToast(toastError);

        AppInsights.logExceptionMessage(
          `SideBar/getNextHandler - for userName: ${userEmail} - requestForServiceKey for GetNext came back null.`
        );
      }
      requestApi
        .getLookupRequest(e.detail.events.requestForServiceKey, accessToken)
        .then((results) => {
          dispatch({
            type: "SET_REFRESH_REQUEST_KEY",
            payload: e.detail.events.requestForServiceKey,
          });
          dispatch({ type: "SET_LOOKUP_REQUEST", payload: results });
          history.push({
            pathname: `/reload`,
          });
        })
        .catch((error: any) => {
          AppInsights.logExceptionMessage(
            `SideBar/retrieveGetNextRequest - for userName: ${userEmail} - Unable to find request ID: ${e.detail.events.requestForServiceKey} - Error: ${error} - Status: ${error.status}.`
          );
          // TODO Do something here if we don't get the request
        });
    },
    [accessToken, userId, dispatch, history]
  );

  const validateGroupType = useRef(() => { });
  validateGroupType.current = () => {
    if (account && account.name) {
      // const keys = Object.keys(account.idTokenClaims as any);

      const userGroups = (account.idTokenClaims as any)["groups"];
      const userEmails = (account.idTokenClaims as any)["emails"];
      const loginName = account?.name;

      if (userGroups.includes(config.userGroup)) {
        setUserRole(config.clinicalRoutingServiceUserRole); // Todo Hard Coding User Role for Now.  Will get from Database later
        setUserEmail(userEmails[0]);
        setGroupType("Hello Doctor");
        setActiveAlert(false);
      } else {
        setUserRole(" ");
        setUserId(" ");
        setGroupType(" ");
        AppInsights.logExceptionMessage(
          `UCX - Failed Login - Invalid User: ${loginName}`
        );
        setActiveAlert(true);
        setTimeout(() => {
          logoutFn.current();
        }, LOGOUT_TIMEOUT);
      }
    }
  };

  useEffect(() => {
    validateGroupType.current();
    (window as any).addEventListener("getNextRequest", getNextHandler);

    return () => {
      (window as any).removeEventListener("getNextRequest", getNextHandler);
    };
  }, [getNextHandler]);

  useEffect(() => {
    const addToast = (e: any) => {
      let toastSuccess: ToastProps = {
        id: e.detail.id,
        type: e.detail.type,
        title: e.detail.messageTitle,
        secondaryText: e.detail.messageSecondary,
        message: e.detail.messagePrimary,
        removeToast: removeToast,
      };
      addNewToast(toastSuccess);
    };

    (window as any).addEventListener("addToastMessage", addToast);

    return () => {
      (window as any).removeEventListener("addToastMessage", addToast);
    };
  }, []);

  const addNewToast = (toastInfo: ToastProps) => {
    let updatedToasts = [...toasts];
    updatedToasts.push(toastInfo);
    setToasts(updatedToasts);
  };

  const removeToast = (id: string) => {
    let updatedToasts = [...toasts.filter((t) => t.id != id)];
    setToasts(updatedToasts);
  };

  const renderMicroUILink = (menuItem: MicroUIHostDefinition) => {
    let renderLink: boolean =
      menuItem.isMainMenu && userRole.length > 0 && userEmail.length > 0;
    if (!renderLink) return null;
    return (
      <NavLink
        key={"MicroUIHostLink_" + menuItem.name}
        to={"/microuihost/" + menuItem.name}
        activeClassName="active"
        className="collapsed text-center d-block text-xl-left sidenav-link"
        data-parent="#sidebar"
      >
        <i className={"fas fa-fw fa-lg " + menuItem.icon}></i>
        <span className="d-sm-block d-block d-md-block d-lg-block d-xl-inline">
          {menuItem.label}
        </span>
      </NavLink>
    );
  };
  useEffect(() => {
    const requestForServiceKey = sessionStorage.getItem('requestForServiceKey') as string;
    const originSystem = sessionStorage.getItem('originSystem') as string;
    const requestForServiceId = sessionStorage.getItem('requestForServiceId') as string;
    if (window.location.pathname.includes("request/") && !window.location.pathname.split("request/")[1].includes(requestForServiceKey)) {      
        caseLockApi.releaseCaseLockByUserId(originSystem, requestForServiceId,applicationName,caselockUserRole,caseLockUserName);
        sessionStorage.setItem('originSystem','');
        sessionStorage.setItem('requestForServiceId','');
    }else if (!window.location.pathname.includes("reload") && !window.location.pathname.includes("request/" + requestForServiceKey)) {
        caseLockApi.releaseCaseLockByUserId(systemOrigin, authId,applicationName,caselockUserRole,caseLockUserName);
    } 
  }, [location]);
  
  window.onbeforeunload = (e: any) => {
        var image = new Image();
        image.src = caseLockApi.releaseCaseLockByUserId(systemOrigin, authId,applicationName,caselockUserRole,caseLockUserName) as unknown as string;
  }

  return (
    <>
      {userRole.length > 0 && userEmail.length > 0 ? (
        <>
          <div className="row topbar-wrapper sticky-top m-20">
            <div>
              <h3 id="welcome-message">
                {groupType} {userId}
                <br />
              </h3>
            </div>
          </div>
        </>
      ) : (
        <>
          {activeAlert ? (
            <div className="alert-host">
              <Alert
                message={AlertTypes.Error.message}
                title={AlertTypes.Error.title}
                type={AlertTypes.Error.type}
                position="top-right"
              />
            </div>
          ) : (
            <div></div>
          )}
        </>
      )}
      <div
        className={`sidenav ${idleTimeoutTriggered ? "hide-sidebar" : " "}`}
        id="sidebar"
      >
        <div className="p-2 bg-gradient-primary d-none d-sm-none d-xl-block d-md-none d-lg-none">
          <img src={logo} width="100%" alt="logo" />
        </div>
        <div className="p-2 bg-gradient-primary d-block d-sm-block d-md-block d-lg-block d-xl-none">
          <img src={logoSm} width="100%" alt="logo" />
        </div>
        <div className="border-0 mt-5">
          <NavLink
            id="dashboardButton"
            exact
            to="/"
            activeClassName="active"
            className="collapsed text-center d-block text-xl-left sidenav-link"
            data-parent="#sidebar"
          >
            <i className="fas fa-fw fa-lg fa-tachometer-alt"></i>
            <span className="d-sm-block d-block d-md-block d-lg-block d-xl-inline">
              Dashboard
            </span>
          </NavLink>
          <AuthenticatedTemplate>
            {userRole.length > 0 &&
              userEmail.length > 0 &&
              idToken &&
              idToken.length > 0 && (
                <clinical-routing-ui-component
                  appInsightsKey={config.appInsights.instrumentationKey}
                  userRole={userRole}
                  userId={userEmail}
                  medicalDiscipline={config.clinicalRoutingServiceDiscipline}
                  token={idToken}
                ></clinical-routing-ui-component>
              )}
            {config.microUIHost.map(
              (item: MicroUIHostDefinition, index: number) =>
                renderMicroUILink(item)
            )}
            {userRole.length > 0 && userEmail.length > 0 && (
              <SignOutButton
                logout={logoutFn.current}
                reduceIdleTimeout={reduceIdleTimeout}
              />
            )}
          </AuthenticatedTemplate>
          <UnauthenticatedTemplate>
            <SignInButton login={loginFn.current} />
          </UnauthenticatedTemplate>
        </div>
      </div>
      <div style={toastStyles}>
        <ToastContainer toasts={toasts} removeToast={removeToast} />
      </div>
      <TimeoutModal
        showModal={showIdleModal}
        togglePopup={togglePopup}
        handleStayLoggedIn={handleStayLoggedIn}
      />
    </>
  );
}

export default Sidebar;

import React from 'react';
import { act, render, screen } from '@testing-library/react';
import Sidebar from './sidebar';
import { MemoryRouter } from 'react-router';
import RequestStore from '../../state/store/request-store';

it('renders Sidebar component', () => {
    act(() => {
        render(
            <RequestStore>
                <MemoryRouter initialEntries={["/"]}>
                    <Sidebar />
                </MemoryRouter>
            </RequestStore>
            );
    });

    const element = screen.queryAllByText(/Dashboard/i);
    expect(element[0]).toBeInTheDocument();
});

import React from "react";

import { NavLink } from "react-router-dom";

function SignInButton(props: {login: any}) {
    return (
        <>
        <NavLink
          to=""
          id="login-btn"
          activeClassName="active"
          className="collapsed text-center d-block text-xl-left sidenav-link mt-5"
          data-parent="#sidebar"
          onClick={props.login}
        >
          <i className="fas fa-fw fa-lg fa-power-off"></i>
          <span className="d-sm-block d-block d-md-block d-lg-block d-xl-inline">
            Login
          </span>
        </NavLink>
      </>
);
};

export default SignInButton;
import React from "react";
import { NavLink } from "react-router-dom";

function SignOutButton(props: {logout: any, reduceIdleTimeout: any}) {
    return (
        <>
        <a
            href="/"
            className="collapsed text-center d-block text-xl-left sidenav-link"
            data-parent="#sidebar"
            onClick={(e: any) => {e.preventDefault()}}
        >
            <i className="fas fa-fw fa-lg fa-link"></i>
            <span className="d-sm-block d-block d-md-block d-lg-block d-xl-inline">
            Resources and links
            </span>
        </a>
        <hr />
        <NavLink
            to=""
            id="logout-btn"
            activeClassName="active"
            className="collapsed text-center d-block text-xl-left sidenav-link mt-5"
            data-parent="#sidebar"
            onClick={props.logout}
        >
            <i className="fas fa-fw fa-lg fa-power-off"></i>
            <span className="d-sm-block d-block d-md-block d-lg-block d-xl-inline">
            Logout
            </span>
        </NavLink>
        <NavLink
            to=""
            id="reduce-idle-time-btn"
            data-parent="#sidebar"
            onClick={props.reduceIdleTimeout}
        >
            <span>.</span>
        </NavLink>
        </>
    )
};

export default SignOutButton;

import React, { PureComponent } from 'react'

export class Spinner extends PureComponent {
    render() {
        return (
            <>
                <div className="d-flex justify-content-center">
                    <div className="spinner-border" role="status">
                    </div>
                    <span className="sr-only">Loading...</span>
                    <h3 className="h3">Loading Request...</h3>
                </div></>
        )
    }
}

export default Spinner

import React from 'react';
import { Button, Modal, ModalHeader, ModalBody, ModalFooter } from 'reactstrap';
import CountDownTimer from './countDownTimer';

interface TimeoutModalProps {
    showModal?: boolean;
    togglePopup: ()=>void;
    handleStayLoggedIn: ()=>void ;
  }
  
  const TimeoutModal: React.FC<TimeoutModalProps> = ({
    showModal,
    togglePopup,
    handleStayLoggedIn
  })  => {
    return (
        <Modal isOpen={showModal} toggle={togglePopup} keyboard={false} backdrop="static">
        <ModalHeader>Session Timeout!</ModalHeader>
        <ModalBody>
          Your session will expire in <CountDownTimer hours={0} minutes={0} seconds={30}/> seconds due to inactivity. You will be redirected to the login page.
        </ModalBody>
        <ModalFooter>
          <Button color="primary" onClick={handleStayLoggedIn}>Stay Logged In</Button>
        </ModalFooter>
      </Modal>
    );
  };

export default TimeoutModal;

import React from 'react';

import './alert.css';

function Alert(props: { message: string, title: string, type: string, position: string }) {
    return (
        <>
            <div className="row">
                <div className={`alert alert-dismissible ${props.type} ${props.position} mb-3`}>
                    <button type="button" className="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <div className="row no-gutters align-items-center">
                        <div className="col-auto align-self-start">
                            <span className="fa-stack"> <i className="fas fa-circle fa-stack-2x"></i> <i className="fas fa-ban fa-stack-1x fa-inverse"></i> </span>
                        </div>
                        <div className="col">
                            <h6 className="alert-heading mb-0">{props.title}</h6>
                            <p className="mb-0">{props.message}</p>
                        </div>
                    </div>
                </div>
            </div>        
        </>
    )
}

export default Alert;
import React from 'react';
import { render } from '@testing-library/react';
import Alert from './alert';

it('renders home text', () => {
    const comp = render(<Alert message="Unauthorized user." title="Error" type="alert" position="top-right" />);
    expect(comp).toBeTruthy();
});

import React from "react";
import "./decision.css";

interface DecisionProps {
  requestForServiceKey: string;
  upadsToken: string;
  requestForServiceId: string;
  authorizationKey: string;
}

const Decision: React.FC<DecisionProps> = ({
  requestForServiceKey,
  upadsToken,
  requestForServiceId,
  authorizationKey
}) => {
  return (
    <div className="decision-container">
      <decision-ui
        requestForServiceKey={requestForServiceKey}
        upadsToken={upadsToken}
        requestForServiceId={requestForServiceId}
        authorizationKey={authorizationKey}
      ></decision-ui>
    </div>
  );
};

export default Decision;
import React, {
  useEffect,
  useRef,
  useState,
  useContext,
  useCallback,
} from "react";
import { useHistory, useParams } from "react-router-dom";
import { RequestContext } from "../../state/store/request-store";
import { AppInsights } from "../../AppInsights";
import * as lookuprequestapi from "../../api/lookup-request-service-api";
import { AuthProvider } from "../../auth/authProvider";
import { useMsal } from "@azure/msal-react";
import { InteractionRequiredAuthError } from "@azure/msal-browser";
import LookupRequest from "../../types/lookup";
import Details from "./details/details";
import config from "../../utils/config";
import { Spinner } from "evicore-component-library";
import moment from "moment";
import jwt_decode from "jwt-decode";
import Decision from "./decision";
import "./decision.css"
interface ParamTypes {
  id?: string;
}

function RequestView(this: any) {
  const params = useParams<ParamTypes>();
  const [state, dispatch] = useContext<any>(RequestContext);
  const [request, setRequest] = useState<LookupRequest>({} as LookupRequest);
  const { accounts } = useMsal();
  const [accessToken, setAccessToken] = useState("");
  const [idToken, setIdToken] = useState("");
  const account = accounts[0] && accounts[0].name;
  const email = (accounts[0] as any)?.idTokenClaims?.emails[0];
  const caseLockUserName = email?.substring(0, email?.indexOf("@"));

  const [enableUCXHeaderMicroUI, setEnableUCXHeaderMicroUI] = useState(false);
  //get enableUCXHeaderMicroUI value from query string and update state
  useEffect(() => {
    const enableUCXHeaderMicroUI = window.location.search.split(
      "enableUCXHeaderMicroUI="
    )[1];
    if (enableUCXHeaderMicroUI) {
      setEnableUCXHeaderMicroUI(enableUCXHeaderMicroUI === "true");
    }
  }, []);

  const [isMemberHistoryCollapsed, setisMemberHistoryCollapsed] =
    React.useState(!!config.isMemberHistoryCollapsed);
  const collapseMemberHistory = () =>
    setisMemberHistoryCollapsed(!isMemberHistoryCollapsed);

  const [requestFound, setRequestFound] = useState(false);
  const [requestFetchPerformed, setRequestFetchPerformed] = useState(false);

  const history = useHistory();

  const [showCodes, setShowCodes] = useState(false);
  let userId = useRef<string>("");
  let adRoleName = useRef<string>("");

  useRef(() => {
    userId.current = email ?? "undefined";
    adRoleName.current = "Doctor";
  });

  const getIdToken = useCallback(async () => {
    const request = {
      ...AuthProvider.loginRequest,
      account: accounts[0],
    };

    if (!AuthProvider._idToken) {
      AuthProvider.Application.acquireTokenSilent(request)
        .then((response: { idToken: React.SetStateAction<string> }) => {
          setIdToken(response.idToken);
        })
        .catch((error: any) => {
          // acquireTokenSilent can fail for a number of reasons, fallback to interaction
          if (error instanceof InteractionRequiredAuthError) {
            AuthProvider.Application.acquireTokenSilent(
              AuthProvider.loginRequest
            ).then((response: { idToken: React.SetStateAction<string> }) => {
              setIdToken(response.idToken);
            });
          }
        });
    }
  }, [accounts]);

  const getAccessToken = useCallback(async () => {
    const request = {
      ...AuthProvider.loginRequest,
      account: accounts[0],
    };

    if (!AuthProvider._accessToken) {
      AuthProvider.Application.acquireTokenSilent(request)
        .then((response: { accessToken: React.SetStateAction<string> }) => {
          setAccessToken(response.accessToken);
        })
        .catch((error: any) => {
          // acquireTokenSilent can fail for a number of reasons, fallback to interaction
          if (error instanceof InteractionRequiredAuthError) {
            AuthProvider.Application.acquireTokenSilent(
              AuthProvider.loginRequest
            ).then(
              (response: { accessToken: React.SetStateAction<string> }) => {
                setAccessToken(response.accessToken);
              }
            );
          }
        });
    }
  }, [accounts]);

  const checkAndRefreshTokens = (e: Event) => {
    if (!accessToken) {
      return;
    }
    let token = jwt_decode(accessToken) as any;
    let isTokenExpiring = moment(new Date(token.exp * 1000)).diff(
      moment(new Date()),
      "minutes"
    );
    if (isTokenExpiring < 14) {
      getAccessToken();
    }

    let id = jwt_decode(idToken) as any;
    let isIdExpiring = moment(new Date(id.exp * 1000)).diff(
      moment(new Date()),
      "minutes"
    );
    if (isIdExpiring < 14) {
      getIdToken();
    }
  };

  const handleNotesOnScroll = () => {
    const stickyNotes = document.getElementById("sticky-notes");

    if (stickyNotes) {
      const headerWrapperBoundingBox = document.getElementById("header-wrapper")?.getBoundingClientRect();
      const clinicalInfoCardBoundingBox = document.getElementById("clinical-info-card")?.getBoundingClientRect();

      if (headerWrapperBoundingBox && clinicalInfoCardBoundingBox &&
        clinicalInfoCardBoundingBox.bottom <= headerWrapperBoundingBox.bottom) {
        stickyNotes.style.position = "fixed";
        stickyNotes.style.width = `${clinicalInfoCardBoundingBox.width}px`;
        stickyNotes.style.top = `${headerWrapperBoundingBox.bottom + 10}px`;
      }
      else {
        stickyNotes.style.position = "relative";
        stickyNotes.style.top = "0px";
      }
    }
  };

  useEffect(() => {
    window.addEventListener("mousedown", checkAndRefreshTokens);
    window.addEventListener("scroll", checkAndRefreshTokens);
    window.addEventListener("scroll", handleNotesOnScroll);
    window.addEventListener("keydown", checkAndRefreshTokens);
    window.addEventListener("click", checkAndRefreshTokens);
    return () => {
      window.removeEventListener("mousedown", checkAndRefreshTokens);
      window.removeEventListener("scroll", checkAndRefreshTokens);
      window.removeEventListener("scroll", handleNotesOnScroll);
      window.removeEventListener("keydown", checkAndRefreshTokens);
      window.removeEventListener("click", checkAndRefreshTokens);
    };
  }, [accessToken, idToken]);

  useEffect(() => {
    getIdToken();
    getAccessToken();
  }, [getAccessToken, getIdToken]);

  useEffect(() => {
    document.addEventListener(
      "UcxHeaderCollapseMemberHistoryEventTrigger",
      (event: any) => {
        setisMemberHistoryCollapsed(event.detail);
      }
    );
  }, []);

  useEffect(() => {
    document.addEventListener(
      "UcxHeaderDisplayCodesEventTrigger",
      (event: any) => {
        setShowCodes(event.detail);
      }
    );
  }, []);

  const displayCodes = (e: any) => {
    e.preventDefault();
    setShowCodes(!showCodes);

    (window as any).dispatchEvent(
      new CustomEvent("requestForServiceOpened", {
        detail: { request: request },
      })
    );
  };

  const hideCodes = (e: any) => {
    e.preventDefault();
    setShowCodes(false);
    const event = new CustomEvent("UcxHeaderCloseCodesEventTrigger", { detail: showCodes });
    (window as any).dispatchEvent(event);
  };

  const getLookupRequest = useCallback(() => {
    lookuprequestapi
      .getLookupRequest(params.id!, accessToken)
      .then((results) => {
        setRequestFound(true);
        setRequest(results);
        dispatch({ type: "SET_LOOKUP_REQUEST", payload: results });
        sessionStorage.setItem(
          "requestForServiceId",
          results?.requestForServiceId
        );
      })
      .catch((error: any) => {
        AppInsights.logExceptionMessage(
          `getLookupRequest/Request UCX.UI2 - for userName: ${userId.current
          } - Unable to find request ID: ${params.id!} - Error: ${error} - Status: ${error.status
          }.`
        );
      })
      .finally(() => setRequestFetchPerformed(true));
  }, [accessToken, dispatch, params.id]);

  useEffect(() => {
    if (Object.keys(request).length <= 0) {
      getLookupRequest();
    }
  }, [getLookupRequest, request]);

  useEffect(() => {
    if (request) {
      setTimeout(() => {
        (window as any).dispatchEvent(
          new CustomEvent("requestForServiceOpened", {
            detail: { request: request },
          })
        );
      }, 30);
    }
  }, [request]);

  const [configuration, setConfiguration] = useState<any>(null);
  useEffect(() => {
    setConfiguration({
      contextKey: request.requestForServiceId,
      reviewType: config.upadsConfig.reviewType,
      userId: email ?? "undefined",
      upadsShowHistory: config.upadsConfig.upadsShowHistory,
      upadsSystem: config.upadsConfig.upadsSystem,
      upadsForceNewReview: config.upadsConfig.upadsForceNewReview,
      upadsUpadsApiUrl: config.upadsConfig.upadsUpadsApiUrl,
      upadsPublicServiceUrl: config.upadsConfig.upadsPublicServiceUrl,
      upadsContentApiUrl: config.upadsConfig.upadsContentApiUrl,
      upadsServicesUrl: config.upadsConfig.upadsServicesUrl,
      upadsServicesUserName: email ?? "undefined",
      upadsServicesDisplayName: account ?? "undefined",
      upadsServicesAdRoleName: "Doctor",
      upadsServicesGenericRole: config.upadsConfig.upadsServicesGenericRole,
      upadsServicesAuthorizationKey: request.authorizationKey,
      upadsServicesRequestType: config.upadsConfig.upadsServicesRequestType,
      upadsErrorMessage: config.upadsConfig.upadsErrorMessage,
    });
  }, [email, account, request]);

  const [originSystem, setOriginSystem] = useState<string>("");
  const [originSystemError, setOriginSystemError] = useState(undefined);
  const [originSystemLoading, setOriginSystemLoading] = useState(true);
  useEffect(() => {
    if (request?.requestForServiceKey) {
      fetch(
        `${config.apiBaseUrl}ucx/qualifier/api/originsystem/${request.requestForServiceKey}`,
        {
          headers: {
            Authorization: idToken,
          },
        }
      )
        .then((response) => {
          if (response.ok) {
            return response.text();
          }
          throw response;
        })
        .then((text) => {
          setOriginSystem(text);
          dispatch({ type: "SET_ORIGIN_SYSTEM", payload: text });
          sessionStorage.setItem("originSystem", text);
        })
        .catch((error) => {
          AppInsights.logError(
            new Error("Failed to fetch request origin system"),
            {
              email: email,
              requestForServiceKey: request.requestForServiceKey,
              requestForServiceId: request.requestForServiceId,
              error: error,
              statusCode: error.status,
            }
          );
          setOriginSystemError(error);
        })
        .finally(() => {
          setOriginSystemLoading(false);
        });
    }
  }, [request, email, idToken]);

  if (!requestFetchPerformed || originSystemLoading)
    return <Spinner type={"primary"} className={"content-wrapper"}></Spinner>;
  if (
    requestFetchPerformed &&
    !requestFound &&
    !originSystemLoading &&
    !originSystemError
  )
    return (
      <div className="content-wrapper">Request Not Found: {params.id}</div>
    );
  return (
    <>
      <div className="alert-wrapper">
        <ucx-caselock
          systemOfRecord={originSystem}
          contextKey={request.requestForServiceId}
          token={idToken}
          userId={caseLockUserName}
          userRole={config.clinicalRoutingServiceUserRole}
        ></ucx-caselock>
      </div>
      <div id="header-wrapper" className="topbar-wrapper card-alt border-top-0 border-left-0 border-right-0 sticky-top pb-0">
        {requestFound && request?.requestForServiceKey && (
          <ucx-header
            requestForServiceKey={request.requestForServiceKey}
            originSystem={originSystem}
            data-testid={"ucx-header"}
          ></ucx-header>
        )}
      </div>

      <div className="content-wrapper action-tabs">
      

  <div className="action-tab-card card">
  <div className="card-body">
  {requestFound && request && (
        <div className="row decision-wrapper">
        <div className="mb-3 col-12">
          {
          accessToken !== '' &&
          request.requestForServiceId && (
            <div>

                <Decision
                requestForServiceKey={request.requestForServiceKey}
                upadsToken={accessToken}
                requestForServiceId={request.requestForServiceId}
                authorizationKey={request.authorizationKey}
              />

            </div>
          )}
          </div>
          </div>
        )}
  </div>
</div>

  {/* <!-- New Codes Layout --> */}
  <div
          className={`card-alt mb-5 code-details ${!showCodes ? "hide-element" : " "
            }`}
        >
          <div className="card-body">
            <div className="d-flex justify-content-between">
              <h4 className="text-primary mb-4">Codes</h4>
              <a
                href="/"
                data-testid="hideCodes"
                title="close"
                onClick={hideCodes}
              >
                <i className="fa fa-md fa-times-circle text-secondary-300 code-details-close"></i>
              </a>
            </div>
            <div className="row">
              <div className="col-8">
                {requestFound && request && request.requestForServiceKey && (
                  <procedures-micro-ui
                    requestForServiceKey={request.requestForServiceKey}
                  />
                )}
              </div>

              {/* <!-- Diagnoses Codes --> */}
              <div className="col-4">
                {requestFound && request && (
                  <ucx-diagnosis-ui
                    requestForServiceKey={request.requestForServiceKey}
                  />
                )}
              </div>
            </div>
          </div>
        </div>

        <div className="text-end pointer">
          <p className="font-size-sm font-weight-semibold mb-0">
            {isMemberHistoryCollapsed ? (
              <a href="#history" onClick={collapseMemberHistory}>
                View Member History <i className="fas fa-fw fa-caret-down"></i>
              </a>
            ) : (
              <a href="#history" onClick={collapseMemberHistory}>
                Hide Member History <i className="fas fa-fw fa-caret-up"></i>
              </a>
            )}
          </p>
        </div>

        {requestFound && request && (
          <Details
            lookupRequest={request}
            isMemberHistoryCollapsed={isMemberHistoryCollapsed}
            token={idToken}
            originSystem={originSystem}
            configuration={configuration}
            account={account}
            email={email}
          />
        )}
      </div>
    </>
  );
}

export default RequestView;


import React from "react";
import { act, render, screen } from "@testing-library/react";
import "@testing-library/jest-dom/extend-expect";
import RequestView from "./request-view";
import { testData } from "../../testdata/test-data";
import RequestStore from '../../state/store/request-store';
import * as LookupApi from "../../api/lookup-request-service-api";

jest.mock('../../auth/authProvider', () => (
    { AuthProvider: { loginRequest: {}, Application: { acquireTokenSilent: () => new Promise<string>(() => '') } } })
);

const mockApi = {
    get: jest.fn(),
    set: jest.fn()
}

jest.mock("react-router-dom", () => {
    const originalModule = jest.requireActual("react-router-dom");

    return {
        ...originalModule,
        useHistory: jest.fn(),
        useLocation: () => ({
            pathname: "/request-view",
            state: "N191316TQT"
        }),
        useParams: () => ({
            id: "testIdA",
        })
    };
});

describe("<ucx-header/>", () => {
    beforeEach(() => {
        jest.spyOn(global, "fetch").mockImplementation(() =>
            Promise.resolve({
                text: () => Promise.resolve('ImageOne'),
                ok: true
            } as Response)
        );
    });
    afterEach(() => {
        jest.restoreAllMocks();
    });
    it("renders the header in request view", async () => {
        jest.spyOn(LookupApi, 'getLookupRequest').mockImplementation(jest.fn(() => Promise.resolve({ requestForServiceKey: "key" })));
        act(() => {
            render(<RequestStore><RequestView /></RequestStore>)
        });
        const element = await screen.findByTestId('ucx-header');
        expect(element).toBeInTheDocument();
    });
});

describe("<RequestView />", () => {
    beforeEach(() => {
    });

    it("renders RequestView component", () => {
        jest.mock("../../api/clinical-service-api.ts", () => mockApi);
        mockApi.get.mockResolvedValueOnce({ data: testData[0] } as any);

        act(() => {
            render(
                <RequestStore>
                    <RequestView />
                </RequestStore>
            );
        });

        act(() => {
            window.dispatchEvent(new CustomEvent("requestForServiceOpened", { detail: { request: testData } }));
        });

    });

    it('should trigger UcxHeaderCollapseMemberHistoryEventTrigger event Listener Properly', () => {
        act(() => {
            render(
                <div data-testid="content-wrapper">
                    <RequestStore>
                        <RequestView />
                    </RequestStore>
                </div>
            );
            const element = screen.getByTestId('content-wrapper');
            expect(element).toBeInTheDocument();
            expect(element).toContainHTML('<div data-testid="content-wrapper"><div class="spinner-border text-primary content-wrapper" /></div>');

        });
    })

    it('should trigger UcxHeaderDisplayCodesEventTrigger event Listener Properly', () => {
        act(() => {
            render(
                <div data-testid="content-wrapper">
                    <RequestStore>
                        <RequestView />
                    </RequestStore>
                </div>
            );
            const element = screen.getByTestId('content-wrapper');
            expect(element).toBeInTheDocument();
            expect(element).toContainHTML('<div data-testid="content-wrapper"><div class="spinner-border text-primary content-wrapper" /></div>');
        });
    })
});

describe("<ucx-caselock/>", () => {
    it("renders ucx caselock micro ui component", () => {
        act(() => {
            render(
                <div data-testid="content-wrapper">
                    <div className="alert-wrapper">
                        <ucx-caselock systemOfRecord="IOne" contextKey="A500036384" token="" userId="" userRole="MD" />
                    </div>
                </div>
            );
            const element = screen.getByTestId('content-wrapper');
            expect(element).toBeInTheDocument();
            expect(element).toBeVisible();
        });
    });
});

describe("Hide codes event for header micro UI to consume", () => {
    beforeEach(() => {
        jest.spyOn(global, "fetch").mockImplementation(() =>
            Promise.resolve({
                text: () => Promise.resolve('ImageOne'),
                ok: true
            } as Response)
        );
    });
    afterEach(() => {
        jest.restoreAllMocks();
    });
    it("changes showCodes to false when anchor is clicked", async () => {
        jest.spyOn(LookupApi, 'getLookupRequest').mockImplementation(jest.fn(() => Promise.resolve({ requestForServiceKey: "key" })));
        act(() => {
            render(
                <RequestStore>
                    <RequestView />
                </RequestStore>
            );
        });
        let showCodes: boolean = true;
        const viewHandler = (e: any) => {
            showCodes = e.detail;
        };
        const hideCodeslink = await screen.findByTestId('hideCodes')
        window.addEventListener('UcxHeaderCloseCodesEventTrigger', viewHandler);
        hideCodeslink.click();
        expect(showCodes).toBe(false);
    });
});

import React, {useCallback, useEffect} from "react";
import config from "../../utils/config";
import {AppInsights} from "../../AppInsights";

interface UpadsComponentProps {
    token: string,
    configuration: any
}

const UpadsComponent: React.FC<UpadsComponentProps> = ({token, configuration}) => {

    const trackUpadsErrors = useCallback((e: any) => {
        AppInsights.logExceptionMessage(
            `Unable to connect to UPADS service with error status: ${e.detail.criticalError.upads}.`
        );
    }, []);

    useEffect(() => {
        (window as any).addEventListener("upadsErrorEvent", trackUpadsErrors);

        return () => {
            (window as any).removeEventListener("upadsErrorEvent", trackUpadsErrors);
        };
    }, [trackUpadsErrors]);

    return (
        <>
            {
                config.upadsConfig.xPlatformUpadsControlJs && config.upadsConfig.xPlatformUpadsControlCss && token &&
                <div className="ucx-upads-wrapper" data-testid="ucx-upads-wrapper">
                    <ucx-upads-micro-ui
                        url={config.upadsConfig.xPlatformUpadsControlJs}
                        css={config.upadsConfig.xPlatformUpadsControlCss}
                        token={token}
                        configuration={JSON.stringify(configuration)}
                        ucx={"true"}
                    ></ucx-upads-micro-ui>
                </div>
            }
        </>
    );
};

export default UpadsComponent;

class UpadsMicroUiConfiguration {
    // Double Duty Parameters
    contextKey: string | undefined;  //contextKey in upads and Context        in upadsServices (RequestId)
    reviewType: string| undefined; //reviewType in upads and pathwayName    in upadsServices
    userId: string| undefined;     //userId     in upads and UserName       in upadsServices

    // XPlatform Upads ONLY Control Parameters
    upadsShowHistory: boolean;
    upadsSystem: string| undefined;
    upadsForceNewReview: boolean | undefined;
    upadsUpadsApiUrl: string| undefined;
    upadsPublicServiceUrl: string| undefined;
    upadsContentApiUrl: string| undefined;

    // Parameters for UCX UPADS service
    upadsServicesUrl: string| undefined;
    upadsServicesUserName: string | undefined;
    upadsServicesDisplayName: string| undefined;
    upadsServicesAdRoleName: string| undefined;
    upadsServicesGenericRole: string| undefined;  // MD or Nurse
    upadsServicesAuthorizationKey: string| undefined;
    upadsServicesRequestType: string| undefined;

    // Single error message that can be displayed in Micro UI Control - Blank disabled error messages in Micro UI
    upadsErrorMessage: string| undefined;

    constructor(contextKey: string, reviewType: string, userId: string,
        upadsShowHistory: boolean, upadsSystem: string, upadsForceNewReview: boolean, 
        upadsUpadsApiUrl: string, upadsPublicServiceUrl: string, upadsContentApiUrl: string,
        upadsServicesUrl: string, upadsServicesUserName: string, upadsServicesDisplayName: string,
        upadsServicesAdRoleName: string, upadsServicesGenericRole: string, upadsServicesAuthorizationKey: string, 
        upadsServicesRequestType: string, upadsErrorMessage: string) {
        
        this.contextKey = contextKey; 
        this.reviewType = reviewType; 
        this.userId = userId;
    
        this.upadsShowHistory = upadsShowHistory;
        this.upadsSystem = upadsSystem;
        this.upadsForceNewReview = upadsForceNewReview;
        this.upadsUpadsApiUrl = upadsUpadsApiUrl;
        this.upadsPublicServiceUrl = upadsPublicServiceUrl;
        this.upadsContentApiUrl = upadsContentApiUrl;
    
        this.upadsServicesUrl = upadsServicesUrl;
        this.upadsServicesUserName = upadsServicesUserName;
        this.upadsServicesDisplayName = upadsServicesDisplayName;
        this.upadsServicesAdRoleName = upadsServicesAdRoleName; 
        this.upadsServicesGenericRole = upadsServicesGenericRole;
        this.upadsServicesAuthorizationKey = upadsServicesAuthorizationKey;
        this.upadsServicesRequestType = upadsServicesRequestType;
    
        this.upadsErrorMessage = upadsErrorMessage;
    }
}

export default UpadsMicroUiConfiguration;

import React, { useEffect, useState } from "react";
import LookupRequest from "../../types/lookup";
import UpadsComponent from "./UpadsComponent";

interface QualifiersProps {
    request: LookupRequest,
    originSystem: string,
    accessToken: string,
    configuration: any
}

const Qualifier: React.FC<QualifiersProps> = ({ request, originSystem, accessToken, configuration }) => {
    const [hidePathWayBlock, setHidePathWayBlock] = useState(false);
    useEffect(() => {
        window.addEventListener(
            "UCXCaseLockMicroUIEvent",
            (event: any) => {
                setHidePathWayBlock(event.detail);
            }
        );
    }, []);
    return (
    <div>
        {!hidePathWayBlock &&
        <div className="content-wrapper determination-flow m-0" data-testid="pathway-container">
            <div className="d-flex justify-content-between">
                <h4 data-testid="decide-panel" id="decide-panel-header"
                    className="text-primary mb-3 offset-0">Decide Request</h4>
            </div>
                <>
                    {!!originSystem && originSystem !== '' && originSystem !== 'ImageOne' &&
                        <UpadsComponent token={accessToken} configuration={configuration} />}
                    {originSystem === 'ImageOne' &&
                        <ucx-qualifier-ui requestForServiceKey={request.requestForServiceKey}
                            data-testid='ucx-qualifier-ui' />}
                </>
        </div>
        }
    </div>
    )
}

export default Qualifier;
import { act, render, screen } from "@testing-library/react";
import Qualifier from "./Qualifier";
import React, { useState} from 'react';

jest.mock('react', () => ({
    ...jest.requireActual('react'),
    useState: jest.fn()
}))

describe('Qualifiers', () => {    
    afterEach(() => {
        jest.restoreAllMocks();
    });
    beforeEach(()=>{
        const setHidePathWayBlock = jest.fn();        
        jest
            .spyOn(React, 'useState')
            .mockImplementation(() => [false, setHidePathWayBlock]);
    })
    it('should render EvicorePlatform request when originSystem blank', () => {
        render(<Qualifier request={{
            requestForServiceKey: '',
            requestForServiceId: '',
            authorizationKey: '',
            diagnoses: [],
            procedures: []

        }} originSystem={''} accessToken={''} configuration={{}} />);
        expect(() => screen.getByTestId('ucx-upads-wrapper')).toThrow();
    });
    it('should render EvicorePlatform request when originSystem undefined', () => {
        render(<Qualifier request={{
            requestForServiceKey: '',
            requestForServiceId: '',
            authorizationKey: '',
            diagnoses: [],
            procedures: []
        }} originSystem={undefined!} accessToken={''} configuration={{}} />);
        expect(() => screen.getByTestId('ucx-upads-wrapper')).toThrow();
    });
    it('should render EvicorePlatform request', async () => {
        act(() => {
            render(<Qualifier request={{
                requestForServiceKey: 'foo',
                requestForServiceId: '',
                authorizationKey: 'bar',
                diagnoses: [],
                procedures: []
            }} originSystem={'EvicorePlatform'} accessToken={'foo'} configuration={{}} />);
        });
        const element = screen.getByTestId('ucx-upads-wrapper');
        expect(element).toBeInTheDocument();
    });
    it('should render ImageOne request', async () => {
        await act(async () => {
            await render(<Qualifier request={{
                requestForServiceKey: 'foo',
                requestForServiceId: '',
                authorizationKey: 'bar',
                diagnoses: [],
                procedures: []
            }} originSystem={'ImageOne'} accessToken={''} configuration={{}} />);
        });
        const element = screen.getByTestId('ucx-qualifier-ui');
        expect(element).toBeInTheDocument();
    });
    it('should not render upads pathways block', async () => {
        
        const setHidePathWayBlock = jest.fn();        
        jest
            .spyOn(React, 'useState')
            .mockImplementation(() => [true, setHidePathWayBlock]);
        
        render(<Qualifier request={{
            requestForServiceKey: 'foo',
            requestForServiceId: '',
            authorizationKey: 'bar',
            diagnoses: [],
            procedures: []
        }} originSystem=''accessToken={'foo'} configuration={{}} />)
        expect(() => screen.getByTestId('pathway-container')).toThrow();
    });
    it('should render upads pathways block', async () => {   
        render(<Qualifier request={{
            requestForServiceKey: 'foo',
            requestForServiceId: '',
            authorizationKey: 'bar',
            diagnoses: [],
            procedures: []
        }} originSystem=''accessToken={'foo'} configuration={{}} />)
        const element=screen.getByTestId('pathway-container');
        expect(element).toBeInTheDocument();        
    })
});

.DOCKERIGNORE

**/.classpath
**/.dockerignore
**/.env
**/.git
**/.gitignore
**/.project
**/.settings
**/.toolstarget
**/.vs
**/.vscode
**/*.*proj.user
**/*.dbmdl
**/*.jfm
**/azds.yaml
**/charts
**/docker-compose*
**/Dockerfile*
**/node_modules
**/npm-debug.log
**/obj
**/secrets.dev.yaml
**/values.dev.yaml
LICENSE
README.md

.ENV
REACT_APP_ENV=local
REACT_APP_CLIENT_ID=9f3eb1b4-c333-47ef-ad11-44745710b07e
REACT_APP_SCOPE=https://ehdv1b2c.onmicrosoft.com/5f3a640a-613f-4696-afff-5c740cc371cf/ucxauth/user_access
REACT_APP_AUTHORITY=https://ehdv1b2c.b2clogin.com/ehdv1b2c.onmicrosoft.com/B2C_1A_UCX_SUSI
REACT_APP_REDIRECT_URL=http://localhost:3000

REACT_APP_API_URL = https://dv1api.innovate.lan/clinicalservice/requestforservice
REACT_APP_API_BASE_URL=https://dv1api.innovate.lan/clinicalservice/
REACT_APP_USER_GROUP=dv1_EpSleepMedicalDirector


REACT_APP_ATTACHMENT_LIST_NAME=attachment-list
REACT_APP_ATTACHMENT_LIST_URL=https://eu2dv1staucxtfstate.blob.core.windows.net/eu2dv1scucx/build/attachment-list.js

REACT_APP_DIAGNOSES_NAME=diagnoses
REACT_APP_DIAGNOSES_URL=https://eu2dv1staucxtfstate.blob.core.windows.net/eu2dv1scucx/build/ucx-diagnoses-micro-ui.js

REACT_APP_LEVEL_ONE_FREE_TEXT_NOTES_NAME=level-one-free-text-notes
REACT_APP_LEVEL_ONE_FREE_TEXT_NOTES_URL=https://eu2dv1staucxtfstate.blob.core.windows.net/eu2dv1scucx/build/ucx-level-one-free-text-notes-micro-ui.js

REACT_APP_MEDICAL_DIRECTOR_REVIEW_NAME=medical-director-review
REACT_APP_MEDICAL_DIRECTOR_NAME_URL=https://eu2dv1staucxtfstate.blob.core.windows.net/eu2dv1scucx/build/ucx-medical-director-review-history-element.js

REACT_APP_NON_CLINICAL_REVIEW_NAME=non-clinical-review
REACT_APP_NON_CLINICAL_REVIEW_URL=https://dv1ucxmicroui.blob.core.windows.net/nonclinicalreviewhistory/ucx-non-clinical-review-history.js

REACT_APP_NURSE_FREE_TEXT_NOTES_NAME=nurse-free-text-notes
REACT_APP_NURSE_FREE_TEXT_NOTES_URL=https://eu2dv1staucxtfstate.blob.core.windows.net/eu2dv1scucx/build/ucx-nurse-free-text-notes-micro-ui.js

REACT_APP_NURSE_REVIEW_NAME=nurse-review
REACT_APP_NURSE_REVIEW_URL=https://dv1ucxmicroui.blob.core.windows.net/nursereviewhistory/ucx-nurse-review-history.js

REACT_APP_PHYSICIAN_FREE_TEXT_NOTES_NAME=physician-free-text-notes
REACT_APP_PHYSICIAN_FREE_TEXT_NOTES_URL=https://eu2dv1staucxtfstate.blob.core.windows.net/eu2dv1scucx/build/ucx-physician-free-text-notes-micro-ui.js

REACT_APP_PDF_VIEWER_NAME=pdf-viewer
REACT_APP_PDF_VIEWER_URL=https://eu2dv1staucxtfstate.blob.core.windows.net/eu2dv1scucx/build/pdf-viewer.js

REACT_APP_PROCEDURES_NAME=procedures
REACT_APP_PROCEDURES_URL=https://eu2dv1staucxtfstate.blob.core.windows.net/eu2dv1scucx/build/ucx-procedures-micro-ui.js

REACT_APP_SEARCH_MICROUI_HOST=https://eheu2dv1ucxrequestsearchfrontdoor.azurefd.net



.GITIGNORE
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.js

# testing
/coverage

# production
/build
/dist
/tmp

# profiling files
chrome-profiler-events*.json
speed-measure-plugin*.json

# IDEs and editors
/.idea
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# IDE - VSCode
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
.history/*

# IDE - VS
.vs/*

# misc
/.sass-cache
/connect.lock
.env.local
.env.development.local
.env.test.local
.env.production.local
/tools
/typings
*.xml
/.scannerwork

/libpeerconnection.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
testem.log

# System Files
.DS_Store
Thumbs.db

#  Local .terraform directories
**/.terraform/*

# .tfstate files
*.tfstate
*.tfstate.*

# .tfplan files
state.tfplan

# Crash log files
crash.log
debug.log

# Ignore local tfvars testing files
backend-dv1.tfvars
backend-in1.tfvars





.NPMRC
registry=https://pkgs.dev.azure.com/eviCoreDev/_packaging/evicore-npm/npm/registry/
                         
always-auth=true

TSCONFIG.JSON

{
  "compilerOptions": {
    "target": "es5",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noFallthroughCasesInSwitch": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react"
  },
  "include": [
    "src"
  ]
}

{
  "compilerOptions": {
    "target": "es5",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noFallthroughCasesInSwitch": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react"
  },
  "include": [
    "src"
  ]
}


SONARPROJECT.JS
const sonarqubeScanner = require("sonarqube-scanner");

sonarqubeScanner(
  {
    serverUrl: "http://localhost:9000",
    options: {
      "sonar.sources": "./src",
      "sonar.tests": "./src",
      "sonar.test.inclusions": "./src/**/*.spec.js,src/**/*.spec.jsx,src/**/*.test.js,src/**/*.test.jsx,src/**/*.test.ts,src/**/*.test.tsx",
      "sonar.coverage.exclusions": "./src/index.tsx,./src/**/*.ts",
      "sonar.typescript.lcov.reportPaths": "coverage/lcov.info",
      "sonar.testExecutionReportPaths": "coverage/test-report.xml",
    },
  },
  () => {},
);

SONAR-PROJECT.PROPERTIES
# sonar.host.url=https://evicoredevsq.innovate.lan/9000
# sonar.login=70096b383c5ee32269820f33232a54f731207300
# sonar.host.url=http://localhost:9000
# sonar.login=admin
# sonar.password=admin
sonar.projectKey=UCX.UI_2
# this is the name and version displayed in the SonarQube UI. Was mandatory prior to SonarQube 6.1.
sonar.projectName=UCX.UI_2
sonar.projectVersion=1.0
sonar.sourceEncoding=UTF-8
sonar.sources=src
sonar.tests=src
sonar.test.inclusions=src/**/*.spec.js,src/**/*.spec.jsx,src/**/*.test.js,src/**/*.test.jsx,src/**/*.test.ts,src/**/*.test.tsx
sonar.coverage.exclusions=src/index.tsx,src/**/*.ts
sonar.javascript.lcov.reportPaths=coverage/lcov.info
sonar.testExecutionReportPaths=coverage/test-report.xml

README

# Getting Started with Create React App

This project was bootstrapped with [Create React App](https://github.com/facebook/create-react-app).

## Available Scripts

In the project directory, you can run:

### `npm start`

Runs the app in the development mode.\
Open [http://localhost:3000](http://localhost:3000) to view it in the browser.

The page will reload if you make edits.\
You will also see any lint errors in the console.

### `npm test`

Launches the test runner in the interactive watch mode.\
See the section about [running tests](https://facebook.github.io/create-react-app/docs/running-tests) for more information.

### `npm run build`

Builds the app for production to the `build` folder.\
It correctly bundles React in production mode and optimizes the build for the best performance.

The build is minified and the filenames include the hashes.\
Your app is ready to be deployed!

See the section about [deployment](https://facebook.github.io/create-react-app/docs/deployment) for more information.

### `npm run eject`

**Note: this is a one-way operation. Once you `eject`, you cant go back!**

If you arent satisfied with the build tool and configuration choices, you can `eject` at any time. This command will remove the single build dependency from your project.

Instead, it will copy all the configuration files and the transitive dependencies (webpack, Babel, ESLint, etc) right into your project so you have full control over them. All of the commands except `eject` will still work, but they will point to the copied scripts so you can tweak them. At this point youre on your own.

You dont have to ever use `eject`. The curated feature set is suitable for small and middle deployments, and you shouldnt feel obligated to use this feature. However we understand that this tool wouldnt be useful if you couldnt customize it when you are ready for it.

## Learn More

You can learn more in the [Create React App documentation](https://facebook.github.io/create-react-app/docs/getting-started).

To learn React, check out the [React documentation](https://reactjs.org/).

PACKAGE.JSON
{
  "name": "ucx-ui",
  "version": "0.1.0",
  "private": true,
  "dependencies": {
    "@azure/msal-browser": "^2.28.1",
    "@azure/msal-react": "^1.4.5",
    "@babel/core": "^7.13.0",
    "@microsoft/applicationinsights-react-js": "^3.3.6",
    "@microsoft/applicationinsights-web": "^2.8.6",
    "@testing-library/jest-dom": "^5.16.4",
    "@testing-library/react": "^11.2.7",
    "@testing-library/react-hooks": "^3.7.0",
    "@testing-library/user-event": "^12.8.3",
    "@types/dotenv": "^8.2.0",
    "@types/jest": "^26.0.24",
    "@types/node": "^12.20.55",
    "@types/react": "^16.14.29",
    "@types/react-dom": "^16.9.16",
    "@types/react-redux": "^7.1.24",
    "@types/react-router": "^5.1.18",
    "@types/react-router-dom": "^5.3.3",
    "@types/redux": "^3.6.0",
    "@types/redux-logger": "^3.0.9",
    "@types/redux-thunk": "^2.1.0",
    "dotenv": "^8.6.0",
    "env-cmd": "^10.1.0",
    "evicore-component-library": "^1.3.35",
    "moment": "^2.29.4",
    "react": "^17.0.2",
    "react-dom": "^17.0.2",
    "react-idle-timer": "^4.6.4",
    "react-redux": "^7.2.8",
    "react-router": "^5.3.3",
    "react-router-dom": "^5.3.3",
    "react-scripts": "4.0.0",
    "react-test-renderer": "^18.2.0",
    "redux": "^4.2.0",
    "redux-logger": "^3.0.6",
    "redux-thunk": "^2.4.1",
    "typescript": "~4.0.5",
    "web-vitals": "^0.2.4",
    "jwt-decode": "^3.1.2",
    "reactstrap": "^9.2.0"
  },
  "scripts": {
    "start": "set REACT_APP_STAGE=local NODE_OPTIONS=--openssl-legacy-provider && react-scripts start",
    "start:dv1": "set REACT_APP_STAGE=dv1 NODE_OPTIONS=--openssl-legacy-provider && react-scripts start",
    "start:in1": "set REACT_APP_STAGE=in1 NODE_OPTIONS=--openssl-legacy-provider && react-scripts start",
    "build": "set NODE_OPTIONS=--openssl-legacy-provider && react-scripts build",
    "build:dv1": "set REACT_APP_STAGE=dv1 NODE_OPTIONS=--openssl-legacy-provider && react-scripts build ",
    "build:in1": "set REACT_APP_STAGE=in1 NODE_OPTIONS=--openssl-legacy-provider && react-scripts build ",
    "build:pd1": "set REACT_APP_STAGE=pd1 NODE_OPTIONS=--openssl-legacy-provider && react-scripts build ",
    "lint": "eslint */**/*.{js,ts,tsx}",
    "test": "react-scripts test --ci --watchAll false --coverage --testResultsProcessor jest-sonar-reporter",
    "sonar": "node sonar-project.js",
    "eject": "react-scripts eject"
  },
  "eslintConfig": {
    "extends": [
      "react-app",
      "react-app/jest"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  },
  "jestSonar": {
    "reportPath": "coverage",
    "reportFile": "test-report.xml",
    "indent": 4
  },
  "devDependencies": {
    "cross-env": "^7.0.3",
    "eslint": "^7.32.0",
    "eslint-plugin-react": "^7.30.1",
    "jest-sonar-reporter": "^2.0.0",
    "json-server": "^0.16.3",
    "npm-run-all": "^4.1.5",
    "sonarqube-scanner": "^2.8.1"
  }
}


ECOSYSTEM.CONFIG.TS
module.exports = {
    apps: [
      {
        script: "npx serve build -s"
      }
    ]
  };

DOCKERFILE
# Stage 0, "build-stage", based on Node.js, to build and compile the frontend
FROM node:16-alpine as build-stage

# Build-time environment variables
# Default build configuration
ARG REACT_APP_STAGE=pd1
ARG REACT_APP_SEARCH_MICROUI_HOST=""
# set a default in case the ARG isn't passed
ENV REACT_APP_STAGE=$REACT_APP_STAGE
ENV REACT_APP_SEARCH_MICROUI_HOST=$REACT_APP_SEARCH_MICROUI_HOST

# default to dev key
ARG APP_INSIGHTS_KEY="75584c12-a500-4063-88ad-3cd9a2e2c44f"

ENV APP_INSIGHTS_KEY=$APP_INSIGHTS_KEY

# Set working directory
WORKDIR /app

# Copy app dependencies.
COPY package.json package-lock.json .npmrc ./

# Install app dependencies.
RUN npm install 

# Copy app files
COPY . .

# Build app
RUN npm run build

# Stage 1, based on Nginx, to have only the compiled app, ready for production with Nginx
FROM globalcrep.azurecr.io/nginx
# Remove default nginx website
RUN rm -rf /usr/share/nginx/html/*

# Copy the default nginx.conf provided by node:latest
COPY --from=build-stage /app/nginx/nginx.conf /etc/nginx/conf.d/default.conf

# Copy output directory from builder to nginx image.
COPY --from=build-stage /app/build/ /usr/share/nginx/html

# docker build -t my-react-app -f Dockerfile .
# docker build -t my-react-app --build-arg REACT_APP_STAGE=pd1 -f Dockerfile .
# docker run -d -p 80:80 my-react-app

AZURE-PIPELINES.YAML
resources:
  repositories:
  # must have for adding cloud cluster topics/groups
  - repository: ucxAdoTemplates
    type: git
    name: 'UCX/ucx-ado-templates'

trigger:
  branches:
    include:
    - main

pool:
  name: 'eheu2pd1epvmss'

variables:
  buildConfiguration: "Release"
  system.debug: false
  azureContainerRegistry: 'globalcrep-acr'
  azureContainerRegistryName: 'globalcrep'
  azureContainerRegistryUrl: 'globalcrep.azurecr.io'
  azureContainerRegistryRsg: 'global_rsg_ep'
  azureContainerRegistrySubscription: 'a0c6645e-c3da-4a78-9ef6-04ab6aad45ff'
  
  dockerFileLocation: './Dockerfile'
  TERRAFORM_BACKEND_CONTAINER_NAME: 'ucx-terraform-storage-container'
  BACKEND_AZURE_RM_KEY: 'ucx-ucxui-service.tfstate'
  
stages:
  - stage: BUILDDV1
    displayName: 'Build DV1'
    variables:
      BUILD_ENVIRONMENT: 'dv1'
      containerName: 'ucx-ui-$(BUILD_ENVIRONMENT)'
      SEARCH_MICROUI_HOST: 'https://eheu2dv1ucxrequestsearchfrontdoor.azurefd.net'
    jobs:
      - job: BuildAndPublish
        displayName: 'Build and then publish dockerfile'
        pool:
          name: "ubuntu-latest"
        steps:
        # Copy all the files to the staging area before we start creating additional files that aren't needed in the release pipeline
          - task: CopyFiles@2
            displayName: 'Copy files for testing'
            inputs:
              Contents: '**'
              TargetFolder: '$(build.artifactstagingdirectory)'
          - task: NodeTool@0
            inputs:
              versionSpec: 'v16.15.0' 
          - task: Npm@1
            displayName: npm install
            inputs:
              workingDir: '$(build.artifactstagingdirectory)'
              command: install
          - task: Npm@1
            displayName: npm run test
            inputs:
              workingDir: '$(build.artifactstagingdirectory)'
              command: custom
              customCommand: run test
          - task: npmAuthenticate@0
            inputs:
              workingFile: '.npmrc'
          - task: Docker@2
            displayName: Login to acr
            inputs:
              command: login
              containerRegistry: $(azureContainerRegistry)
          - task: Docker@2
            displayName: 'Build image'
            inputs:
              containerRegistry: $(azureContainerRegistry)
              repository: '$(containerName)'
              command: 'build'
              Dockerfile: $(dockerFileLocation)
              buildContext: '.'
              tags: |
                $(Build.BuildNumber)
                $(Build.SourceVersion)
                latest
              arguments: |
                --build-arg REACT_APP_STAGE=$(BUILD_ENVIRONMENT)
                --build-arg REACT_APP_SEARCH_MICROUI_HOST=$(SEARCH_MICROUI_HOST)
          - task: Docker@2
            displayName: 'Push image to container repo'
            inputs:
              containerRegistry: $(azureContainerRegistry)
              repository: $(containerName)
              command: 'push'
              tags: |
                $(Build.BuildNumber)
                $(Build.SourceVersion)
                latest 

  - stage: DV1
    displayName: "Deploy DV1"
    dependsOn: BUILDDV1
    variables:
      SERVICE_ACCOUNT_NAME: 'sp_dv1_rsg_ucx-linux'
      AZURE_RESOURCE_GROUP: 'dv1_rsg_ucx-linux'
      TERRAFORM_BACKEND_STORAGE_ACCOUNT: 'eu2dv1staucxtfstate'
      BUILD_ENVIRONMENT: 'dv1'
      containerName: 'ucx-ui-$(BUILD_ENVIRONMENT)'
    jobs:
      - deployment: Infrastructure
        timeoutInMinutes: 300
        environment: DV1
        displayName: Run Terraform
        strategy:
          runOnce:
            deploy:
              steps:
                - download: none
                - checkout: self
                - task: AzureCLI@2
                  displayName: 'Create Terraform state storage'
                  inputs:
                    azureSubscription: 'sp_dv1_rsg_ucx-linux'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az storage account create --name $(TERRAFORM_BACKEND_STORAGE_ACCOUNT) --resource-group $(AZURE_RESOURCE_GROUP) --location eastus2 --sku Standard_LRS
                      az storage container create --name $(TERRAFORM_BACKEND_CONTAINER_NAME) --account-name $(TERRAFORM_BACKEND_STORAGE_ACCOUNT)
                      STORAGE_ACCOUNT_KEY=$(az storage account keys list -n $(TERRAFORM_BACKEND_STORAGE_ACCOUNT) | jq ".[0].value" -r)
                      echo "setting storage account key variable"
                      echo "##vso[task.setvariable variable=ARM_ACCESS_KEY;issecret=true]$STORAGE_ACCOUNT_KEY"

                - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
                  displayName: "Install Terraform"
                  inputs:
                    terraformversion: "latest"
          
                - powershell: |
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/Terraform%20Modules/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%20Modules'
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/Terraform%20Modules/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%2520Modules'
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/eviCore%20Platform/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/eviCore%20Platform'
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/eviCore%20Platform/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/eviCore%2520Platform'
                    git config --global -l
                  displayName: Git URL Terraform Modules

                - task: TerraformTaskV2@2
                  displayName: "Terraform init"
                  inputs:
                     provider: "azurerm"
                     command: "init"
                     commandOptions: '-upgrade'
                     workingDirectory: "Terraform"
                     backendServiceArm: ${{ variables.SERVICE_ACCOUNT_NAME }}
                     backendAzureRmResourceGroupName: $(AZURE_RESOURCE_GROUP)
                     backendAzureRmStorageAccountName: $(TERRAFORM_BACKEND_STORAGE_ACCOUNT)
                     backendAzureRmContainerName: $(TERRAFORM_BACKEND_CONTAINER_NAME)
                     backendAzureRmKey: $(BACKEND_AZURE_RM_KEY)

                - task: TerraformTaskV2@2
                  displayName: "Terraform plan"
                  name: 'TerraformA'
                  inputs:
                    provider: "azurerm"
                    command: "plan"
                    workingDirectory: "./Terraform"
                    commandOptions: '-var-file environments/$(BUILD_ENVIRONMENT).tfvars -var=container_image_version="$(Build.BuildNumber)" -var=docker_registry_name="$(azureContainerRegistryName)" -var=docker_registry="$(azureContainerRegistryUrl)" -var=docker_registry_rsg=$(azureContainerRegistryRsg) -var=docker_registry_sub=$(azureContainerRegistrySubscription) -out=tplan$(BUILD_ENVIRONMENT).out'
                    environmentServiceNameAzureRM: ${{ variables.SERVICE_ACCOUNT_NAME }}
        
                - task: TerraformTaskV2@2
                  displayName: "Terraform Apply"
                  name: 'TerraformApply'
                  inputs:
                    provider: "azurerm"
                    command: "apply"
                    workingDirectory: "./Terraform"
                    commandOptions: "tplan$(BUILD_ENVIRONMENT).out"
                    environmentServiceNameAzureRM: ${{ variables.SERVICE_ACCOUNT_NAME }}
        
                - task: PowerShell@2
                  displayName: 'Read terraform outputs'
                  name: terraformOutput
                  inputs:
                    targetType: 'inline'
                    script: |
                      $terraformOutput = Get-Content "$(TerraformApply.jsonOutputVariablesPath)" | ConvertFrom-Json
                      $terraformOutput | Get-Member -MemberType NoteProperty | % { $o = $terraformOutput.($_.Name); Write-Host "##vso[task.setvariable variable=$($_.Name);isoutput=true]$($o.value)" }
      - deployment: Swap_Slots
        dependsOn: [Infrastructure]
        timeoutInMinutes: 300
        environment: DV1
        displayName: Swap API Slots
        variables:
          apiWebAppName: $[ dependencies.Infrastructure.outputs['Infrastructure.terraformOutput.apiWebAppName'] ]
        strategy:
          runOnce:
            deploy:
              steps:
              - download: none
              - checkout: self
              - task: AzureAppServiceManage@0
                displayName: 'Swap API slots'
                name: SwapAPISlots
                inputs:
                  ConnectedServiceName: ${{ variables.SERVICE_ACCOUNT_NAME }}
                  WebAppName: $(apiWebAppName)
                  ResourceGroupName: ${{ variables.AZURE_RESOURCE_GROUP }}
                  SourceSlot: staging
                  SwapWithProduction: true

  - stage: DV1AutomationTests
    dependsOn: DV1
    jobs:
      - job: AutomationTests
        pool:
          name: Automation_Win_NonProd
          demands:
            - msbuild
            - visualstudio
        steps:
          - download: none
          - checkout: self
          - task: UseDotNet@2
            displayName: Use .NET Core sdk
            inputs:
              packageType: sdk
              version: '6.0.x'
              installationPath: $(Agent.ToolsDirectory)/dotnet
          - task: DotNetCoreCLI@2
            displayName: "nuget Restore"
            inputs:
              command: "restore"
              feedsToUse: "select"
              vstsFeed: "5483129a-4405-40c1-8ccb-a688120b3137"
              projects: "**/*.csproj"
          - task: DotNetCoreCLI@2
            displayName: Run UI Automation Tests
            continueOnError: true
            env:
              currentEnvironment: dev
              ucxUsername: dv1_epsleepmedicaldirector-a@evicore.com
              ucxPassword: $(ucxPassword)
              url: http://dv1.ucx.evicore.com/
            inputs:
              command: test
              projects: '**/*.AutomationTests.csproj'
              arguments: '--configuration $(buildConfiguration)'

  - stage: BUILDIN1
    displayName: 'Build IN1'
    variables:
      BUILD_ENVIRONMENT: 'in1'
      containerName: 'ucx-ui-$(BUILD_ENVIRONMENT)'
      SEARCH_MICROUI_HOST: 'https://eheu2in1ucxrequestsearchfrontdoor.azurefd.net'
    jobs:
      - job: BuildAndPublish
        displayName: 'Build and then publish dockerfile'
        pool:
          name: "ubuntu-latest"
        steps:
        # Copy all the files to the staging area before we start creating additional files that aren't needed in the release pipeline
          - task: CopyFiles@2
            displayName: 'Copy files for testing'
            inputs:
              Contents: '**'
              TargetFolder: '$(build.artifactstagingdirectory)'
          - task: npmAuthenticate@0
            inputs:
              workingFile: .npmrc
          - task: Docker@2
            displayName: Login to acr
            inputs:
              command: login
              containerRegistry: $(azureContainerRegistry)
          - task: Docker@2
            displayName: 'Build image'
            inputs:
              containerRegistry: $(azureContainerRegistry)
              repository: '$(containerName)'
              command: 'build'
              Dockerfile: $(dockerFileLocation)
              buildContext: '.'
              tags: |
                $(Build.BuildNumber)
                $(Build.SourceVersion)
                latest
              arguments: |
                --build-arg REACT_APP_STAGE=$(BUILD_ENVIRONMENT)
                --build-arg REACT_APP_SEARCH_MICROUI_HOST=$(SEARCH_MICROUI_HOST)
          - task: Docker@2
            displayName: 'Push image to container repo'
            inputs:
              containerRegistry: $(azureContainerRegistry)
              repository: $(containerName)
              command: 'push'
              tags: |
                $(Build.BuildNumber)
                $(Build.SourceVersion)
                latest 
  - stage: IN1
    displayName: "Deploy IN1"
    dependsOn: BUILDIN1
    variables:
      SERVICE_ACCOUNT_NAME: 'sp_in1_rsg_ucx'
      AZURE_RESOURCE_GROUP: 'in1_rsg_ucx-linux'
      TERRAFORM_BACKEND_STORAGE_ACCOUNT: 'eu2in1staucxtfstate'
      BUILD_ENVIRONMENT: 'in1'
      containerName: 'ucx-ui-$(BUILD_ENVIRONMENT)'
    jobs:
      - deployment: Infrastructure
        timeoutInMinutes: 300
        environment: IN1
        displayName: Run Terraform
        strategy:
          runOnce:
            deploy:
              steps:
                - download: none
                - checkout: self
                - task: azurecli@2
                  displayName: 'create terraform state storage'
                  inputs:
                    azuresubscription: 'sp_in1_rsg_ucx-linux'
                    scripttype: 'bash'
                    scriptlocation: 'inlinescript'
                    inlinescript: |
                      az storage account create --name $(terraform_backend_storage_account) --resource-group $(azure_resource_group) --location eastus2 --sku standard_lrs
                      az storage container create --name $(terraform_backend_container_name) --account-name $(terraform_backend_storage_account)
                      storage_account_key=$(az storage account keys list -n $(terraform_backend_storage_account) | jq ".[0].value" -r)
                      echo "setting storage account key variable"
                      echo "##vso[task.setvariable variable=arm_access_key;issecret=true]$storage_account_key"

                - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.terraforminstaller@0
                  displayName: "install terraform"
                  inputs:
                    terraformversion: "latest"

                - powershell: |
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/Terraform%20Modules/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%20Modules'
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/Terraform%20Modules/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%2520Modules'
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/eviCore%20Platform/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/eviCore%20Platform'
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/eviCore%20Platform/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/eviCore%2520Platform'
                    git config --global -l
                  displayName: Git URL Terraform Modules

                - task: terraformtaskv2@2
                  displayName: "terraform init"
                  inputs:
                      provider: "azurerm"
                      command: "init"
                      commandoptions: '-upgrade'
                      workingdirectory: "terraform"
                      backendservicearm: ${{ variables.SERVICE_ACCOUNT_NAME }}
                      backendazurermresourcegroupname: $(azure_resource_group)
                      backendazurermstorageaccountname: $(terraform_backend_storage_account)
                      backendazurermcontainername: $(terraform_backend_container_name)
                      backendazurermkey: $(backend_azure_rm_key)

                - task: terraformtaskv2@2
                  displayName: "terraform plan"
                  name: 'terraforma'
                  inputs:
                    provider: "azurerm"
                    command: "plan"
                    workingdirectory: "./terraform"
                    commandOptions: '-var-file environments/$(BUILD_ENVIRONMENT).tfvars -var=container_image_version="$(Build.BuildNumber)" -var=docker_registry_name="$(azureContainerRegistryName)" -var=docker_registry="$(azureContainerRegistryUrl)" -var=docker_registry_rsg=$(azureContainerRegistryRsg) -var=docker_registry_sub=$(azureContainerRegistrySubscription) -out=tplan$(BUILD_ENVIRONMENT).out'
                    environmentservicenameazurerm: ${{ variables.SERVICE_ACCOUNT_NAME }}

                - task: terraformtaskv2@2
                  displayName: "terraform apply"
                  name: 'terraformapply'
                  inputs:
                    provider: "azurerm"
                    command: "apply"
                    workingdirectory: "./terraform"
                    commandoptions: "tplan$(build_environment).out"
                    environmentservicenameazurerm: ${{ variables.SERVICE_ACCOUNT_NAME }}
        
                - task: powershell@2
                  displayName: 'read terraform outputs'
                  name: terraformoutput
                  inputs:
                    targettype: 'inline'
                    script: |
                      $terraformoutput = get-content "$(terraformapply.jsonoutputvariablespath)" | convertfrom-json
                      $terraformoutput | get-member -membertype noteproperty | % { $o = $terraformoutput.($_.name); write-host "##vso[task.setvariable variable=$($_.name);isoutput=true]$($o.value)" }
     
      - deployment: Swap_Slots
        dependsOn: [Infrastructure]
        timeoutInMinutes: 300
        environment: IN1
        displayName: Swap API Slots
        variables:
          apiWebAppName: $[ dependencies.Infrastructure.outputs['Infrastructure.terraformOutput.apiWebAppName'] ]
        strategy:
          runOnce:
            deploy:
              steps:
              - download: none
              - checkout: self
              - task: AzureAppServiceManage@0
                displayName: 'Swap API slots'
                name: SwapAPISlots
                inputs:
                  ConnectedServiceName: ${{ variables.SERVICE_ACCOUNT_NAME }}
                  WebAppName: $(apiWebAppName)
                  ResourceGroupName: ${{ variables.AZURE_RESOURCE_GROUP }}
                  SourceSlot: staging
                  SwapWithProduction: true
  - stage: BUILDPD1
    displayName: 'Build PD1'
    variables:
      BUILD_ENVIRONMENT: 'pd1'
      containerName: 'ucx-ui-$(BUILD_ENVIRONMENT)'
      SEARCH_MICROUI_HOST: 'https://ehcuspd1ucxrequestsearchfrontdoor.azurefd.net'
    jobs:
      - job: BuildAndPublish
        displayName: 'Build and then publish dockerfile'
        pool:
          name: "ubuntu-latest"
        steps:
        # Copy all the files to the staging area before we start creating additional files that aren't needed in the release pipeline
          - task: CopyFiles@2
            displayName: 'Copy files for testing'
            inputs:
              Contents: '**'
              TargetFolder: '$(build.artifactstagingdirectory)'
          - task: npmAuthenticate@0
            inputs:
              workingFile: .npmrc          
          - task: Docker@2
            displayName: Login to acr
            inputs:
              command: login
              containerRegistry: $(azureContainerRegistry)
          - task: Docker@2
            displayName: 'Build image'
            inputs:
              containerRegistry: $(azureContainerRegistry)
              repository: '$(containerName)'
              command: 'build'
              Dockerfile: $(dockerFileLocation)
              buildContext: '.'
              tags: |
                $(Build.BuildNumber)
                $(Build.SourceVersion)
                latest
              arguments: |
                --build-arg REACT_APP_STAGE=$(BUILD_ENVIRONMENT)
                --build-arg REACT_APP_SEARCH_MICROUI_HOST=$(SEARCH_MICROUI_HOST)
          - task: Docker@2
            displayName: 'Push image to container repo'
            inputs:
              containerRegistry: $(azureContainerRegistry)
              repository: $(containerName)
              command: 'push'
              tags: |
                $(Build.BuildNumber)
                $(Build.SourceVersion)
                latest 
  - stage: PD1
    displayName: "Deploy PD1"
    dependsOn: BUILDPD1
    variables:
      SERVICE_ACCOUNT_NAME: 'sp_pd1_rsg_cus_ucx-linux'
      AZURE_RESOURCE_GROUP: 'pd1_rsg_cus_ucx-linux'
      TERRAFORM_BACKEND_STORAGE_ACCOUNT: 'pd1ucxterraformlinux'
      BUILD_ENVIRONMENT: 'pd1'
      containerName: 'ucx-ui-$(BUILD_ENVIRONMENT)'
    jobs:
      - deployment: Infrastructure
        timeoutInMinutes: 300
        environment: PD1
        displayName: Run Terraform
        strategy:
          runOnce:
            deploy:
              steps:
                - download: none
                - checkout: self
                - task: AzureCLI@2
                  displayName: 'Create Terraform state storage'
                  inputs:
                    azureSubscription: ${{ variables.SERVICE_ACCOUNT_NAME }}
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az storage account create --name $(TERRAFORM_BACKEND_STORAGE_ACCOUNT) --resource-group $(AZURE_RESOURCE_GROUP) --location centralus --sku Standard_LRS
                      az storage container create --name $(TERRAFORM_BACKEND_CONTAINER_NAME) --account-name $(TERRAFORM_BACKEND_STORAGE_ACCOUNT)
                      STORAGE_ACCOUNT_KEY=$(az storage account keys list -n $(TERRAFORM_BACKEND_STORAGE_ACCOUNT) | jq ".[0].value" -r)
                      echo "setting storage account key variable"
                      echo "##vso[task.setvariable variable=ARM_ACCESS_KEY;issecret=true]$STORAGE_ACCOUNT_KEY"

                - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
                  displayName: "Install Terraform"
                  inputs:
                    terraformversion: "latest"
          
                - powershell: |
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/Terraform%20Modules/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%20Modules'
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/Terraform%20Modules/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%2520Modules'
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/eviCore%20Platform/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/eviCore%20Platform'
                    git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/eviCore%20Platform/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/eviCore%2520Platform'
                    git config --global -l
                  displayName: Git URL Terraform Modules

                - task: TerraformTaskV2@2
                  displayName: "Terraform init"
                  inputs:
                      provider: "azurerm"
                      command: "init"
                      commandOptions: '-upgrade'
                      workingDirectory: "Terraform"
                      backendServiceArm: ${{ variables.SERVICE_ACCOUNT_NAME }}
                      backendAzureRmResourceGroupName: $(AZURE_RESOURCE_GROUP)
                      backendAzureRmStorageAccountName: $(TERRAFORM_BACKEND_STORAGE_ACCOUNT)
                      backendAzureRmContainerName: $(TERRAFORM_BACKEND_CONTAINER_NAME)
                      backendAzureRmKey: $(BACKEND_AZURE_RM_KEY)

                - task: terraformtaskv2@2
                  displayName: "terraform plan"
                  name: 'terraforma'
                  inputs:
                    provider: "azurerm"
                    command: "plan"
                    workingdirectory: "./terraform"
                    commandOptions: '-var-file environments/$(BUILD_ENVIRONMENT).tfvars -var=container_image_version="$(Build.BuildNumber)" -var=docker_registry_name="$(azureContainerRegistryName)" -var=docker_registry="$(azureContainerRegistryUrl)" -var=docker_registry_rsg=$(azureContainerRegistryRsg) -var=docker_registry_sub=$(azureContainerRegistrySubscription) -out=tplan$(BUILD_ENVIRONMENT).out'
                    environmentservicenameazurerm: ${{ variables.SERVICE_ACCOUNT_NAME }}

                - task: terraformtaskv2@2
                  displayName: "terraform apply"
                  name: 'terraformapply'
                  inputs:
                    provider: "azurerm"
                    command: "apply"
                    workingdirectory: "./terraform"
                    commandoptions: "tplan$(build_environment).out"
                    environmentservicenameazurerm: ${{ variables.SERVICE_ACCOUNT_NAME }}
        
                - task: PowerShell@2
                  displayName: 'Read terraform outputs'
                  name: terraformOutput
                  inputs:
                    targetType: 'inline'
                    script: |
                      $terraformOutput = Get-Content "$(TerraformApply.jsonOutputVariablesPath)" | ConvertFrom-Json
                      $terraformOutput | Get-Member -MemberType NoteProperty | % { $o = $terraformOutput.($_.Name); Write-Host "##vso[task.setvariable variable=$($_.Name);isoutput=true]$($o.value)" }
      
      - deployment: Swap_Slots
        dependsOn: [Infrastructure]
        timeoutInMinutes: 300
        environment: PD1
        displayName: Swap API Slots
        variables:
          apiWebAppName: $[ dependencies.Infrastructure.outputs['Infrastructure.terraformOutput.apiWebAppName'] ]
        strategy:
          runOnce:
            deploy:
              steps:
              - download: none
              - checkout: self
              - task: AzureAppServiceManage@0
                displayName: 'Swap API slots'
                name: SwapAPISlots
                inputs:
                  ConnectedServiceName: ${{ variables.SERVICE_ACCOUNT_NAME }}
                  WebAppName: $(apiWebAppName)
                  ResourceGroupName: ${{ variables.AZURE_RESOURCE_GROUP }}
                  SourceSlot: staging
                  SwapWithProduction: true


AZURE-PIPELINE-PR.YAML
trigger: none

pool:
   name: "eheu2pd1epvmss"

resources:
  repositories:
    - repository: ucxAdoTemplates
      type: git
      name: 'UCX/ucx-ado-templates'

variables:
  dockerRegistry: 'globalcrep-acr'
  dockerRegistryName: 'globalcrep'
  dockerRegistryUrl: 'globalcrep.azurecr.io'
  dockerRegistryRsg: 'global_rsg_ep'
  dockerRegistrySubscription: 'a0c6645e-c3da-4a78-9ef6-04ab6aad45ff'

stages:
  - stage:
    jobs:
      - template: react/pull-request.yaml@ucxAdoTemplates
        parameters:
          workingDir: './'
          pathToChangeWorkingDir: './'
          SonarQubeProjectKey: 'UCX.UI_2'
          SonarQubeProjectName: 'UCX.UI_2'
          RunSonarQubeAnalysis: true
          CheckmarxProjectName: 'UCX.UI_2'
          CheckmarxServiceConnection: 'UCX-Checkmarx-SAST-Service-Connection'
          CheckmarxFullTeamName: 'CxServer/Cigna/UCX'
          CheckmarxProjectRepoUrl: 'https://eviCoreDev@dev.azure.com/eviCoreDev/UCX/_git/UCX.UI_2'
          CheckmarxPointOfContactEmail: 'krista.guida@evicore.com'
          RunCheckMarxAnalysis: true

  - stage: DV1_Infrastructure_Plan 
    jobs:
      - job: DV1_Infrastructure
        displayName: "Review DV1 Infrastructure Changes"
        condition: or(eq(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.Reason'], 'Manual'))
        steps:
          - checkout: self
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
            displayName: "Install Terraform"
            inputs:
              terraformVersion: "latest"
          - powershell: |
                  git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/Terraform%20Modules/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%20Modules'
                  git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/Terraform%20Modules/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%2520Modules'
                  git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/eviCore%20Platform/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/eviCore%20Platform'
                  git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/eviCore%20Platform/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/eviCore%2520Platform'
                  git config --global -l
            displayName: Git url rewrite
          - task: TerraformTaskV2@2
            displayName: "Terraform init"
            inputs:
              provider: "azurerm"
              command: "init"
              commandOptions: '-upgrade'
              workingDirectory: 'terraform'
              backendServiceArm : 'sp_dv1_rsg_ucx-linux'
              backendAzureRmResourceGroupName: 'dv1_rsg_ucx-linux'
              backendAzureRmStorageAccountName: 'eu2dv1staucxtfstate'
              backendAzureRmContainerName: 'ucx-terraform-storage-container'
              backendAzureRmKey: 'ucx-ucxui-service.tfstate'

          - task: TerraformTaskV2@2
            displayName: "Terraform plan"
            name: 'TerraformA'
            inputs:
              provider: "azurerm"
              command: "plan"
              workingDirectory: 'terraform'
              commandOptions: '-var-file Environments/dv1.tfvars -var=resource_group_name="dv1_rsg_ucx-linux" -var=container_image_version="$(Build.BuildNumber)" -var=docker_registry_name="$(dockerRegistryName)" -var=docker_registry="$(dockerRegistryUrl)" -var=docker_registry_rsg=$(dockerRegistryRsg) -var=docker_registry_sub=$(dockerRegistrySubscription) -out=tfplan.out'
              environmentServiceNameAzureRM: 'sp_dv1_rsg_ucx-linux'
  
  - stage: IN1_Infrastructure_Plan 
    jobs:
      - job: IN1_Infrastructure
        displayName: "Review IN1 Infrastructure Changes"
        condition: or(eq(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.Reason'], 'Manual'))
        steps:
          - checkout: self
          - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
            displayName: "Install Terraform"
            inputs:
              terraformVersion: "latest"
          - powershell: |
                  git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/Terraform%20Modules/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%20Modules'
                  git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/Terraform%20Modules/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%2520Modules'
                  git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/eviCore%20Platform/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/eviCore%20Platform'
                  git config --global --add url."https://eviCoreDev:$(System.AccessToken)@dev.azure.com/eviCoreDev/eviCore%20Platform/_git".insteadOf 'ssh://git@ssh.dev.azure.com/v3/eviCoreDev/eviCore%2520Platform'
                  git config --global -l
            displayName: Git url rewrite
          - task: TerraformTaskV2@2
            displayName: "Terraform init"
            inputs:
              provider: "azurerm"
              command: "init"
              commandOptions: '-upgrade'
              workingDirectory: 'terraform'
              backendServiceArm: 'sp_in1_rsg_ucx'
              backendAzureRmResourceGroupName: 'in1_rsg_ucx-linux'
              backendAzureRmStorageAccountName: 'eu2in1staucxtfstate'
              backendAzureRmContainerName: ucx-terraform-storage-container
              backendAzureRmKey: ucx-ucxui-service.tfstate

          - task: TerraformTaskV2@2
            displayName: "Terraform plan"
            name: 'TerraformA'
            inputs:
              provider: "azurerm"
              command: "plan"
              workingDirectory: 'terraform'
              commandOptions: '-var-file Environments/in1.tfvars -var=resource_group_name="in1_rsg_ucx-linux" -var=container_image_version="$(Build.BuildNumber)" -var=docker_registry_name="$(dockerRegistryName)" -var=docker_registry="$(dockerRegistryUrl)" -var=docker_registry_rsg=$(dockerRegistryRsg) -var=docker_registry_sub=$(dockerRegistrySubscription) -out=tfplan.out'
              environmentServiceNameAzureRM: 'sp_in1_rsg_ucx-linux'

TERRAFORM
environment             = "dv1"
location                = "eastus2"
b2c_tenant              = "ehdv1b2c"
b2c_clientid            = "5f3a640a-613f-4696-afff-5c740cc371cf"
resource_group_name     = "dv1_rsg_ucx-linux"

dns_name              = "dv1.ucx.evicore.com"
sku_name              = "P0v3"
worker_count          = 3

subnet_id_integration = "/subscriptions/5fab10df-31da-4b2f-a1a8-4e2f514b07f0/resourceGroups/dv1_rsg_eu2_vnet_products/providers/Microsoft.Network/virtualNetworks/eu2_dv1_vnet_products/subnets/eu2_dv1_snet_products_ucxui_vnet_intg_10.196.114.16_28"
subnet_id_private     = "/subscriptions/5fab10df-31da-4b2f-a1a8-4e2f514b07f0/resourceGroups/dv1_rsg_eu2_vnet_products/providers/Microsoft.Network/virtualNetworks/eu2_dv1_vnet_products/subnets/eu2_dv1_snet_products_ucxui_pe_10.196.114.0_28"

//Azure Log Analytics data retention parameter settings   
retention_in_days = 30
applicationinsights_tablenames = [
        "AppAvailabilityResults",
        "AppBrowserTimings",
        "AppDependencies",
        "AppEvents",
        "AppMetrics",
        "AppPageViews" ,
        "AppPerformanceCounters",
        "AppRequests",
        "AppSystemEvents",
        "AppExceptions"
    ]
BasicPlan_tablestorage_totalretention_in_days = 8
interactiveretention_in_days                  = 30
totalretention_in_days                        = 30


data "azurerm_monitor_action_group" "email-ucx-team" {
  name                  = "ucx-team"
  resource_group_name   = var.resource_group_name
}

output "email_action_group" {
  value = data.azurerm_monitor_action_group.email-ucx-team.id
}

resource "azurerm_monitor_metric_alert" "http400_errors_count_alert" {
  name                = "alert-ucx-ui-http400_errors_count"
  resource_group_name = var.resource_group_name
  scopes              = [module.ui-pvt.azurerm_app_service.id]
  tags = local.tags
  criteria {
    metric_namespace = "Microsoft.Web/sites"
    metric_name      = "Http4xx"
    aggregation      = "Count"
    operator         = "GreaterThan"
    threshold        = 0

    dimension {
      name     = "Instance"
      operator = "Include"
      values   = ["*"]
    }
  }

  action {
    action_group_id = data.azurerm_monitor_action_group.email-ucx-team.id
  }

  enabled     = true
  severity    = 1
  frequency   = "PT1M"
  window_size = "PT5M"
}

resource "azurerm_monitor_metric_alert" "http400_errors_total_alert" {
  name                = "alert-ucx-ui-http400_errors_total"
  resource_group_name = var.resource_group_name
  scopes              = [module.ui-pvt.azurerm_app_service.id]
  tags = local.tags
  criteria {
    metric_namespace = "Microsoft.Web/sites"
    metric_name      = "Http4xx"
    aggregation      = "Total"
    operator         = "GreaterThan"
    threshold        = 0

    dimension {
      name     = "Instance"
      operator = "Include"
      values   = ["*"]
    }
  }

  action {
    action_group_id = data.azurerm_monitor_action_group.email-ucx-team.id
  }

  enabled     = true
  severity    = 1
  frequency   = "PT1M"
  window_size = "PT5M"
}

resource "azurerm_monitor_metric_alert" "http500_errors_count_alert" {
  name                = "alert-ucx-ui-http500_errors_count"
  resource_group_name = var.resource_group_name
  scopes              = [module.ui-pvt.azurerm_app_service.id]
  tags = local.tags
  criteria {
    metric_namespace = "Microsoft.Web/sites"
    metric_name      = "Http5xx"
    aggregation      = "Count"
    operator         = "GreaterThan"
    threshold        = 0

    dimension {
      name     = "Instance"
      operator = "Include"
      values   = ["*"]
    }
  }

  action {
    action_group_id = data.azurerm_monitor_action_group.email-ucx-team.id
  }

  enabled     = true
  severity    = 1
  frequency   = "PT1M"
  window_size = "PT5M"
}

resource "azurerm_monitor_metric_alert" "http500_errors_total_alert" {
  name                = "alert-ucx-ui-http500_errors_total"
  resource_group_name = var.resource_group_name
  scopes              = [module.ui-pvt.azurerm_app_service.id]
  tags = local.tags
  criteria {
    metric_namespace = "Microsoft.Web/sites"
    metric_name      = "Http5xx"
    aggregation      = "Total"
    operator         = "GreaterThan"
    threshold        = 0

    dimension {
      name     = "Instance"
      operator = "Include"
      values   = ["*"]
    }
  }

  action {
    action_group_id = data.azurerm_monitor_action_group.email-ucx-team.id
  }

  enabled     = true
  severity    = 1
  frequency   = "PT1M"
  window_size = "PT5M"
}

resource "azurerm_monitor_scheduled_query_rules_alert" "microUiNotLoadedAlert" {
  name                = "${var.domain}-alert-micro-ui-not-loaded"
  location            = var.location
  resource_group_name = var.resource_group_name
  action {
    action_group           = [data.azurerm_monitor_action_group.email-ucx-team.id]
    email_subject          = "UCX UI Alert - Micro UI Not Loaded"
    custom_webhook_payload = <<-PAYLOAD
    {
      "properties": {
        "subject": "Micro Ui Not Loaded",
        "message": "An alert that is triggered when a Micro UI fails to load in UCX UI."
      }
    }
    PAYLOAD
  }
  data_source_id = module.app_insights.id
  description    = "An alert that is triggered when a Micro UI fails to load in UCX UI."
  enabled        = true
  query          = <<-QUERY
                         union isfuzzy=true exceptions
                         | where outerMessage contains "Unable to load script" and outerMessage contains "UCX UI"
                         | order by timestamp desc 
                    QUERY
  severity       = 3
  frequency      = 5
  time_window    = 10
  trigger {
    operator  = "GreaterThan"
    threshold = 2
  }
  tags = local.tags
}

resource "azurerm_monitor_scheduled_query_rules_alert" "xPlatformUpadsControlNotLoadedAlert" {
  name                = "${var.domain}-alert-upads-control-not-loaded"
  location            = var.location
  resource_group_name = var.resource_group_name
  action {
    action_group           = [data.azurerm_monitor_action_group.email-ucx-team.id]
    email_subject          = "UCX UI Alert - xPlatfrom UPADS Control Not Loaded"
    custom_webhook_payload = <<-PAYLOAD
    {
      "properties": {
        "subject": "xPlatfrom UPADS Control Not Loaded",
        "message": "An alert that is triggered when the xPlatform UPADS Control fails to load in UCX UPADS Micro UI."
      }
    }
    PAYLOAD
  }
  data_source_id = module.app_insights.id
  description    = "An alert that is triggered when the xPlatform UPADS Control fails to load in UCX UPADS Micro UI."
  enabled        = true
  query          = <<-QUERY
                         union isfuzzy=true exceptions
                         | where outerMessage contains "Unable to load script" and outerMessage contains "UCX UPADS Micro UI"
                         | order by timestamp desc 
                    QUERY
  severity       = 3
  frequency      = 5
  time_window    = 10
  trigger {
    operator  = "GreaterThan"
    threshold = 2
  }
  tags = local.tags
}

resource "azurerm_monitor_scheduled_query_rules_alert" "invalidUserLoginAlert" {
  name                = "${var.domain}-alert-invalid-user-login"
  location            = var.location
  resource_group_name = var.resource_group_name
  action {
    action_group           = [data.azurerm_monitor_action_group.email-ucx-team.id]
    email_subject          = "UCX UI Alert - Invalid User Login"
    custom_webhook_payload = <<-PAYLOAD
    {
      "properties": {
        "subject": "UCX UI Alert - Invalid User Login",
        "message": "An alert that is triggered when an invalid user attempts to login to UCX."
      }
    }
    PAYLOAD
  }
  data_source_id = module.app_insights.id
  description    = "An alert that is triggered when an invalid user attempts to login to UCX."
  enabled        = true
  query          = <<-QUERY
                         union isfuzzy=true exceptions
                         | where outerMessage contains "UCX - Failed Login"
                         | order by timestamp desc 
                    QUERY
  severity       = 3
  frequency      = 5
  time_window    = 5
  trigger {
    operator  = "GreaterThan"
    threshold = 0
  }
    tags = local.tags
}

resource "azurerm_monitor_scheduled_query_rules_alert" "pdf-viewer-micro-ui-lert" {
  name                = "${var.domain}-alert-pdf-viewer-micro-ui-document-not-loaded"
  location            = var.location
  resource_group_name = var.resource_group_name
  action {
    action_group           = [data.azurerm_monitor_action_group.email-ucx-team.id]
    email_subject          = "UCX UI Alert - PDF Viewer Error"
    custom_webhook_payload = <<-PAYLOAD
    {
      "properties": {
        "subject": "PDF Viewer Error",
        "message": "An alert that is triggered when PDF Viewer Micro UI fails to load document."
      }
    }
    PAYLOAD
  }
  data_source_id = module.app_insights.id
  description    = "An alert that is triggered when PDF Viewer Micro UI fails to load document."
  enabled        = true
  query          = <<-QUERY
                         union isfuzzy=true exceptions
                         | where problemId contains "PDF" and assembly contains "pdf-viewer"
                         | order by timestamp desc 
                    QUERY
  severity       = 1
  frequency      = 5
  time_window    = 5
  trigger {
    operator  = "GreaterThan"
    threshold = 1
  }
    tags = local.tags
}

resource "azurerm_monitor_scheduled_query_rules_alert" "UCXHeaderMicroUIfailedtoload" {
  name                = "${var.domain}-UCX-Header-Micro-UI-failed-to-load"
  location            = var.location
  resource_group_name = var.resource_group_name
  action {
    action_group           = [data.azurerm_monitor_action_group.email-ucx-team.id]
    email_subject          = "UCX-Header-Micro-UI Alert - UCX-Header-Micro-UI Failed to Load"
    custom_webhook_payload = <<-PAYLOAD
    {
      "properties": {
        "subject": "UCX-Header-Micro-UI Failed to Load in UCX.UI_2",
        "message": "An Alert is triggered when UCX-Header-Micro-UI fails to load in UCX.UI_2."
      }
    }
    PAYLOAD
  }
  data_source_id = module.app_insights.id
  description    = "An Alert is triggered when UCX-Header-Micro-UI fails to load in UCX.UI_2."
  enabled        = true
  query          = <<-QUERY
                         union isfuzzy=true exceptions
                         | where outerMessage contains "UCX-Header"
                         | order by timestamp desc 
                    QUERY
  severity       = 3
  frequency      = 5
  time_window    = 10
  trigger {
    operator  = "GreaterThan"
    threshold = 2
  }
    tags = local.tags
}


module "ui-pvt" {
  source                  = "git::ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%20Modules/ep-linux-container-deployment-with-slot-with-private-endpoint?ref=v2.2.2"
  resource_group_name     = data.azurerm_resource_group.current_rsg.name
  app_service_plan_id     = module.app_service_plan_pvt.id
  location                = var.location
  environment             = var.environment
  domain                  = var.domain
  role                    = "${local.role}-pvt"
  monitor_action_group_id = data.azurerm_monitor_action_group.email-ucx-team.id
  cors_allowed_origins    = var.allowed_cors_origins
  
  container_image = {
    name    = "${var.domain}-${local.role}-${var.environment}"
    version = var.container_image_version
  }
  docker_settings = {
    registry = var.docker_registry
    username = data.azurerm_container_registry.acr.admin_username
    password = data.azurerm_container_registry.acr.admin_password
  }
  appsettings           = local.app_settings
  
  subnet_id_integration = var.subnet_id_integration
  subnet_id_private     = var.subnet_id_private
  
  site_config = {
    always_on         = true
    health_check_path = var.health_check_path
  }
  
  tier                    = local.tags.Tier
  it_sponsor              = local.tags.ITSponsor
  cost_center             = local.tags.CostCenter
  data_classification     = local.tags.DataClassification
  app_name                = local.tags.AppName
  security_review_id      = local.tags.SecurityReviewID
  service_now_as          = local.tags.ServiceNowAS
  service_now_ba          = local.tags.ServiceNowBA
  app_owner               = local.tags.AssetOwner
  app_team                = local.tags.AssetOwner
  asset_owner             = local.tags.AssetOwner
  business_owner          = local.tags.BusinessOwner
}

module "app_insights" {
  source              = "git::ssh://git@ssh.dev.azure.com/v3/eviCoreDev/Terraform%20Modules/ep-application-insights?ref=v1.8.0"
  environment         = var.environment
  location            = var.location
  domain              = var.domain
  application_type    = local.application_type
  retention_in_days   = var.retention_in_days
  resource_group_name = var.resource_group_name
  cost_center         = local.tags.CostCenter
  asset_owner         = local.tags.AssetOwner
  business_owner      = local.tags.BusinessOwner
  data_classification = local.tags.DataClassification
  app_name            = local.tags.AppName
  it_sponsor          = local.tags.ITSponsor
  tier                = local.tags.Tier
  service_now_ba      = local.tags.ServiceNowBA
  service_now_as      = local.tags.ServiceNowAS
  security_review_id  = local.tags.SecurityReviewID
  app_team            = local.tags.AppTeam
  app_owner           = local.tags.AppOwner
}

resource "azapi_update_resource" "ApplicationInsights_MultipleTables" {
  for_each = toset(var.applicationinsights_tablenames)
  name     = each.key
  parent_id =  data.azurerm_log_analytics_workspace.ucx_ai_law_rsrc.id 
  type      = "Microsoft.OperationalInsights/workspaces/tables@2022-10-01"
  body = jsonencode(
    {
      "properties" : {
        "retentionInDays"      = var.interactiveretention_in_days,
        "totalRetentionInDays" = var.totalretention_in_days
      }
    }
  )
}
resource "azapi_update_resource" "ApplicationInsights_AppTraces_tableForNonDevEnv" {
  count     = "${var.environment == "dv1" ? 0 : 1 }"
  name     = "AppTraces"
  parent_id =  data.azurerm_log_analytics_workspace.ucx_ai_law_rsrc.id 
  type      = "Microsoft.OperationalInsights/workspaces/tables@2022-10-01"
  body = jsonencode(
    {
      "properties" : {
        "retentionInDays"      = var.interactiveretention_in_days,
        "totalRetentionInDays" = var.totalretention_in_days
      }
    }
  )
}
locals {
  application_type        = "web"
  role                    = "ui"
  b2c_policy              = "B2C_1A_UCX_SUSI"
  container_registry_name = "eheu2${var.environment}acrucxlinux"

  # UCX Linux Variables
  storage_account_name   = "eu2${var.environment}staucxtfstate"
  storage_container_name = "eu2${var.environment}scucx"

  # UCX Windows Variables
  storage_account_name_terraform_windows   = "${var.environment}ucxterraform"
  storage_container_name_terraform_windows = "terraform"

  app_settings = {
    "WEBSITES_ENABLE_APP_SERVICE_STORAGE" = "false"
    "AzureAdB2C__Tenant"                  = var.b2c_tenant
    "AzureAdB2C__ClientId"                = var.b2c_clientid
    "AzureAdB2C__Policy"                  = local.b2c_policy
    "REACT_APP_STAGE"                     = var.environment
    }
  email_list = [
    { name = "Team Cerberus", email_address = "scrum_cerberus@evicore.com" },
    { name = "Team Gravity", email_address = "scrum_gravity@evicore.com" }
  ]
  tags = {
    CostCenter         = "61700200"
    AssetOwner         = "Thunder"
    BusinessOwner      = "Kierston Campos"
    DataClassification = "Restricted"
    AppName            = "UCX.UI_2"
    ITSponsor          = "Raja Habib"
    Tier               = 1
    ServiceNowBA       = "notAssigned"
    ServiceNowAS       = "notAssigned"
    SecurityReviewID   = "notAssigned"
    AppTeam            = "Thunder"
    AppOwner           = "Thunder"
    AppCategory        = "UCX"
  }

 location_abbreviations = {
    eastus         = "eu1"
    eastus2        = "eu2"
    westus         = "wu1"
    westus2        = "wu2"
    centralus      = "cus"
    southcentralus = "scu"
  }

}


terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = ">= 3.64.0"
    }
    azapi = {
      source  = "Azure/azapi"
      version = "~> 1.8.0"
    }
  }
}

provider "azurerm" {
  features {}
}
provider "azapi" {
  
}

terraform {
  backend "azurerm" {
    # variables not allowed here
  }
}

data "azurerm_resource_group" "current_rsg" {
  name = var.resource_group_name
}

provider "azurerm" {
  features {}
  alias           = "docker_registry_sub"
  subscription_id = var.docker_registry_sub
}
provider "azapi" {
  alias           = "docker_registry_sub"
  subscription_id = var.docker_registry_sub
}

data "azurerm_log_analytics_workspace" "ucx_ai_law_rsrc" {
  name                = "eh${local.location_abbreviations[var.location]}${var.environment}-law-${var.domain}"
  resource_group_name = var.resource_group_name
}

data "azurerm_container_registry" "acr" {
  provider            = azurerm.docker_registry_sub
  name                = var.docker_registry_name
  resource_group_name = var.docker_registry_rsg
}

resource "azurerm_app_service_custom_hostname_binding" "primary_dns_pvt" {
  hostname            = var.dns_name
  app_service_name    = module.ui-pvt.app_service_name
  resource_group_name = data.azurerm_resource_group.current_rsg.name
}

resource "azurerm_app_service_certificate" "cert_pvt" {
  name                = "cert-pvt"
  resource_group_name = data.azurerm_resource_group.current_rsg.name
  location            = data.azurerm_resource_group.current_rsg.location
  app_service_plan_id = module.app_service_plan_pvt.id
  pfx_blob            = filebase64("./cert/ucx.evicore.com.pfx")
  password            = "Welcome@123"
  tags = local.tags
}

resource "azurerm_app_service_certificate_binding" "cert-binding" {
  hostname_binding_id = azurerm_app_service_custom_hostname_binding.primary_dns_pvt.id
  certificate_id      = azurerm_app_service_certificate.cert_pvt.id
  ssl_state           = "SniEnabled"
}

output "apiWebAppName" {
  value = module.ui-pvt.app_service_name
}

output "web_url" {
  value = module.ui-pvt.app_service_url
}

output "app_insights_instrumentation_key" {
  value = module.app_insights.instrumentation_key
  sensitive = true
}

output "app_insights_app_id" {
  value = module.app_insights.id
}






